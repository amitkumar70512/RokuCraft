/*! For license information please see 241.9aca3ea3b80747f83203.js.LICENSE.txt */
"use strict";(self.webpackChunktypescript_react_project_roku_craft=self.webpackChunktypescript_react_project_roku_craft||[]).push([[241],{81241:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});var r=n(16199),s=n(15319),i=n(25844),o=n(86336),a=n(70860),c=n(34832);const u="@firebase/firestore";class l{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}l.UNAUTHENTICATED=new l(null),l.GOOGLE_CREDENTIALS=new l("google-credentials-uid"),l.FIRST_PARTY=new l("first-party-uid"),l.MOCK_USER=new l("mock-user");let h="10.12.1";const d=new i.Logger("@firebase/firestore");function f(){return d.logLevel}function m(e,...t){if(d.logLevel<=i.LogLevel.DEBUG){const n=t.map(y);d.debug(`Firestore (${h}): ${e}`,...n)}}function g(e,...t){if(d.logLevel<=i.LogLevel.ERROR){const n=t.map(y);d.error(`Firestore (${h}): ${e}`,...n)}}function p(e,...t){if(d.logLevel<=i.LogLevel.WARN){const n=t.map(y);d.warn(`Firestore (${h}): ${e}`,...n)}}function y(e){if("string"==typeof e)return e;try{return function(e){return JSON.stringify(e)}(e)}catch(t){return e}}function w(e="Unexpected state"){const t=`FIRESTORE (${h}) INTERNAL ASSERTION FAILED: `+e;throw g(t),new Error(t)}function v(e,t){e||w()}function I(e,t){return e}const _={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class b extends o.FirebaseError{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class T{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class E{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class S{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(l.UNAUTHENTICATED)))}shutdown(){}}class x{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable((()=>t(this.token.user)))}shutdown(){this.changeListener=null}}class C{constructor(e){this.t=e,this.currentUser=l.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let n=this.i;const r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let s=new T;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new T,e.enqueueRetryable((()=>r(this.currentUser)))};const i=()=>{const t=s;e.enqueueRetryable((async()=>{await t.promise,await r(this.currentUser)}))},o=e=>{m("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((e=>o(e))),setTimeout((()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?o(e):(m("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new T)}}),0),i()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((t=>this.i!==e?(m("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(v("string"==typeof t.accessToken),new E(t.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const e=this.auth&&this.auth.getUid();return v(null===e||"string"==typeof e),new l(e)}}class D{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=l.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);const e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class N{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new D(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable((()=>t(l.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class A{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class k{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(e,t){const n=e=>{null!=e.error&&m("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);const n=e.token!==this.R;return this.R=e.token,m("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable((()=>n(t)))};const r=e=>{m("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.A.onInit((e=>r(e))),setTimeout((()=>{if(!this.appCheck){const e=this.A.getImmediate({optional:!0});e?r(e):m("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((e=>e?(v("string"==typeof e.token),this.R=e.token,new A(e.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}function M(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let t=0;t<e;t++)n[t]=Math.floor(256*Math.random());return n}class F{static newId(){const e=62*Math.floor(256/62);let t="";for(;t.length<20;){const n=M(40);for(let r=0;r<n.length;++r)t.length<20&&n[r]<e&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(n[r]%62))}return t}}function R(e,t){return e<t?-1:e>t?1:0}function P(e,t,n){return e.length===t.length&&e.every(((e,r)=>n(e,t[r])))}function L(e){return e+"\0"}class V{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new b(_.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new b(_.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new b(_.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new b(_.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return V.fromMillis(Date.now())}static fromDate(e){return V.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new V(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?R(this.nanoseconds,e.nanoseconds):R(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class O{constructor(e){this.timestamp=e}static fromTimestamp(e){return new O(e)}static min(){return new O(new V(0,0))}static max(){return new O(new V(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class q{constructor(e,t,n){void 0===t?t=0:t>e.length&&w(),void 0===n?n=e.length-t:n>e.length-t&&w(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===q.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof q?e.forEach((e=>{t.push(e)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),s=t.get(r);if(n<s)return-1;if(n>s)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class U extends q{construct(e,t,n){return new U(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new b(_.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter((e=>e.length>0)))}return new U(t)}static emptyPath(){return new U([])}}const B=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class z extends q{construct(e,t,n){return new z(e,t,n)}static isValidIdentifier(e){return B.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),z.isValidIdentifier(e)||(e="`"+e+"`"),e))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new z(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;const s=()=>{if(0===n.length)throw new b(_.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new b(_.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new b(_.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?(i=!i,r++):"."!==t||i?(n+=t,r++):(s(),r++)}if(s(),i)throw new b(_.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new z(t)}static emptyPath(){return new z([])}}class G{constructor(e){this.path=e}static fromPath(e){return new G(U.fromString(e))}static fromName(e){return new G(U.fromString(e).popFirst(5))}static empty(){return new G(U.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===U.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return U.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new G(new U(e.slice()))}}class K{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function $(e){return e.fields.find((e=>2===e.kind))}function Q(e){return e.fields.filter((e=>2!==e.kind))}function j(e,t){let n=R(e.collectionGroup,t.collectionGroup);if(0!==n)return n;for(let r=0;r<Math.min(e.fields.length,t.fields.length);++r)if(n=H(e.fields[r],t.fields[r]),0!==n)return n;return R(e.fields.length,t.fields.length)}K.UNKNOWN_ID=-1;class W{constructor(e,t){this.fieldPath=e,this.kind=t}}function H(e,t){const n=z.comparator(e.fieldPath,t.fieldPath);return 0!==n?n:R(e.kind,t.kind)}class J{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new J(0,Z.min())}}function Y(e,t){const n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,s=O.fromTimestamp(1e9===r?new V(n+1,0):new V(n,r));return new Z(s,G.empty(),t)}function X(e){return new Z(e.readTime,e.key,-1)}class Z{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new Z(O.min(),G.empty(),-1)}static max(){return new Z(O.max(),G.empty(),-1)}}function ee(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=G.comparator(e.documentKey,t.documentKey),0!==n?n:R(e.largestBatchId,t.largestBatchId))}const te="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ne{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}async function re(e){if(e.code!==_.FAILED_PRECONDITION||e.message!==te)throw e;m("LocalStore","Unexpectedly lost primary lease")}class se{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)}),(e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&w(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new se(((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{const t=e();return t instanceof se?t:se.resolve(t)}catch(e){return se.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):se.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):se.reject(t)}static resolve(e){return new se(((t,n)=>{t(e)}))}static reject(e){return new se(((t,n)=>{n(e)}))}static waitFor(e){return new se(((t,n)=>{let r=0,s=0,i=!1;e.forEach((e=>{++r,e.next((()=>{++s,i&&s===r&&t()}),(e=>n(e)))})),i=!0,s===r&&t()}))}static or(e){let t=se.resolve(!1);for(const n of e)t=t.next((e=>e?se.resolve(e):n()));return t}static forEach(e,t){const n=[];return e.forEach(((e,r)=>{n.push(t.call(this,e,r))})),this.waitFor(n)}static mapArray(e,t){return new se(((n,r)=>{const s=e.length,i=new Array(s);let o=0;for(let a=0;a<s;a++){const c=a;t(e[c]).next((e=>{i[c]=e,++o,o===s&&n(i)}),(e=>r(e)))}}))}static doWhile(e,t){return new se(((n,r)=>{const s=()=>{!0===e()?t().next((()=>{s()}),r):n()};s()}))}}class ie{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.V=new T,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{t.error?this.V.reject(new ue(e,t.error)):this.V.resolve()},this.transaction.onerror=t=>{const n=me(t.target.error);this.V.reject(new ue(e,n))}}static open(e,t,n,r){try{return new ie(t,e.transaction(r,n))}catch(e){throw new ue(t,e)}}get m(){return this.V.promise}abort(e){e&&this.V.reject(e),this.aborted||(m("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){const t=this.transaction.objectStore(e);return new he(t)}}class oe{constructor(e,t,n){this.name=e,this.version=t,this.p=n,12.2===oe.S(o.getUA())&&g("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return m("SimpleDb","Removing database:",e),de(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!o.isIndexedDBAvailable())return!1;if(oe.C())return!0;const e=o.getUA(),t=oe.S(e),n=0<t&&t<10,r=ae(e),s=0<r&&r<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||n||s)}static C(){var e;return"undefined"!=typeof process&&"YES"===(null===(e=process.__PRIVATE_env)||void 0===e?void 0:e.v)}static F(e,t){return e.store(t)}static S(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}async M(e){return this.db||(m("SimpleDb","Opening database:",this.name),this.db=await new Promise(((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{const n=e.target.result;t(n)},r.onblocked=()=>{n(new ue(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{const r=t.target.error;"VersionError"===r.name?n(new b(_.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new b(_.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new ue(e,r))},r.onupgradeneeded=e=>{m("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);const t=e.target.result;this.p.O(t,r.transaction,e.oldVersion,this.version).next((()=>{m("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.N&&(this.db.onversionchange=e=>this.N(e)),this.db}L(e){this.N=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){const s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.M(e);const t=ie.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next((e=>(t.g(),e))).catch((e=>(t.abort(e),se.reject(e)))).toPromise();return i.catch((()=>{})),await t.m,i}catch(e){const t=e,n="FirebaseError"!==t.name&&i<3;if(m("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}function ae(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}class ce{constructor(e){this.B=e,this.k=!1,this.q=null}get isDone(){return this.k}get K(){return this.q}set cursor(e){this.B=e}done(){this.k=!0}$(e){this.q=e}delete(){return de(this.B.delete())}}class ue extends b{constructor(e,t){super(_.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function le(e){return"IndexedDbTransactionError"===e.name}class he{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(m("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(m("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),de(n)}add(e){return m("SimpleDb","ADD",this.store.name,e,e),de(this.store.add(e))}get(e){return de(this.store.get(e)).next((t=>(void 0===t&&(t=null),m("SimpleDb","GET",this.store.name,e,t),t)))}delete(e){return m("SimpleDb","DELETE",this.store.name,e),de(this.store.delete(e))}count(){return m("SimpleDb","COUNT",this.store.name),de(this.store.count())}U(e,t){const n=this.options(e,t),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){const e=r.getAll(n.range);return new se(((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}}))}{const e=this.cursor(n),t=[];return this.W(e,((e,n)=>{t.push(n)})).next((()=>t))}}G(e,t){const n=this.store.getAll(e,null===t?void 0:t);return new se(((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}}))}j(e,t){m("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.H=!1;const r=this.cursor(n);return this.W(r,((e,t,n)=>n.delete()))}J(e,t){let n;t?n=e:(n={},t=e);const r=this.cursor(n);return this.W(r,t)}Y(e){const t=this.cursor({});return new se(((n,r)=>{t.onerror=e=>{const t=me(e.target.error);r(t)},t.onsuccess=t=>{const r=t.target.result;r?e(r.primaryKey,r.value).next((e=>{e?r.continue():n()})):n()}}))}W(e,t){const n=[];return new se(((r,s)=>{e.onerror=e=>{s(e.target.error)},e.onsuccess=e=>{const s=e.target.result;if(!s)return void r();const i=new ce(s),o=t(s.primaryKey,s.value,i);if(o instanceof se){const e=o.catch((e=>(i.done(),se.reject(e))));n.push(e)}i.isDone?r():null===i.K?s.continue():s.continue(i.K)}})).next((()=>se.waitFor(n)))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.H?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function de(e){return new se(((t,n)=>{e.onsuccess=e=>{const n=e.target.result;t(n)},e.onerror=e=>{const t=me(e.target.error);n(t)}}))}let fe=!1;function me(e){const t=oe.S(o.getUA());if(t>=12.2&&t<13){const t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){const e=new b("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return fe||(fe=!0,setTimeout((()=>{throw e}),0)),e}}return e}class ge{constructor(e,t){this.asyncQueue=e,this.Z=t,this.task=null}start(){this.X(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}X(e){m("IndexBackfiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,(async()=>{this.task=null;try{m("IndexBackfiller",`Documents written: ${await this.Z.ee()}`)}catch(e){le(e)?m("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",e):await re(e)}await this.X(6e4)}))}}class pe{constructor(e,t){this.localStore=e,this.persistence=t}async ee(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(t=>this.te(t,e)))}te(e,t){const n=new Set;let r=t,s=!0;return se.doWhile((()=>!0===s&&r>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next((t=>{if(null!==t&&!n.has(t))return m("IndexBackfiller",`Processing collection: ${t}`),this.ne(e,t,r).next((e=>{r-=e,n.add(t)}));s=!1})))).next((()=>t-r))}ne(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next((r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next((n=>{const s=n.changes;return this.localStore.indexManager.updateIndexEntries(e,s).next((()=>this.re(r,n))).next((n=>(m("IndexBackfiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n)))).next((()=>s.size))}))))}re(e,t){let n=e;return t.changes.forEach(((e,t)=>{const r=X(t);ee(r,n)>0&&(n=r)})),new Z(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class ye{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ie(e),this.se=e=>t.writeSequenceNumber(e))}ie(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.se&&this.se(e),e}}function we(e){return null==e}function ve(e){return 0===e&&1/e==-1/0}function Ie(e){return"number"==typeof e&&Number.isInteger(e)&&!ve(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function _e(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t=Te(t)),t=be(e.get(n),t);return Te(t)}function be(e,t){let n=t;const r=e.length;for(let t=0;t<r;t++){const r=e.charAt(t);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}function Te(e){return e+""}function Ee(e){const t=e.length;if(v(t>=2),2===t)return v(""===e.charAt(0)&&""===e.charAt(1)),U.emptyPath();const n=t-2,r=[];let s="";for(let i=0;i<t;){const t=e.indexOf("",i);switch((t<0||t>n)&&w(),e.charAt(t+1)){case"":const n=e.substring(i,t);let o;0===s.length?o=n:(s+=n,o=s,s=""),r.push(o);break;case"":s+=e.substring(i,t),s+="\0";break;case"":s+=e.substring(i,t+1);break;default:w()}i=t+2}return new U(r)}ye.oe=-1;const Se=["userId","batchId"];function xe(e,t){return[e,_e(t)]}function Ce(e,t,n){return[e,_e(t),n]}const De={},Ne=["prefixPath","collectionGroup","readTime","documentId"],Ae=["prefixPath","collectionGroup","documentId"],ke=["collectionGroup","readTime","prefixPath","documentId"],Me=["canonicalId","targetId"],Fe=["targetId","path"],Re=["path","targetId"],Pe=["collectionId","parent"],Le=["indexId","uid"],Ve=["uid","sequenceNumber"],Oe=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],qe=["indexId","uid","orderedDocumentKey"],Ue=["userId","collectionPath","documentId"],Be=["userId","collectionPath","largestBatchId"],ze=["userId","collectionGroup","largestBatchId"],Ge=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],Ke=[...Ge,"documentOverlays"],$e=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Qe=$e,je=[...Qe,"indexConfiguration","indexState","indexEntries"],We=je;class He extends ne{constructor(e,t){super(),this._e=e,this.currentSequenceNumber=t}}function Je(e,t){const n=I(e);return oe.F(n._e,t)}function Ye(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function Xe(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function Ze(e,t){const n=[];for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&n.push(t(e[r],r,e));return n}function et(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class tt{constructor(e,t){this.comparator=e,this.root=t||rt.EMPTY}insert(e,t){return new tt(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,rt.BLACK,null,null))}remove(e){return new tt(this.comparator,this.root.remove(e,this.comparator).copy(null,null,rt.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,n)=>(e(t,n),!1)))}toString(){const e=[];return this.inorderTraversal(((t,n)=>(e.push(`${t}:${n}`),!1))),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new nt(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new nt(this.root,e,this.comparator,!1)}getReverseIterator(){return new nt(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new nt(this.root,e,this.comparator,!0)}}class nt{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class rt{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:rt.RED,this.left=null!=r?r:rt.EMPTY,this.right=null!=s?s:rt.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new rt(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;const s=n(e,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return rt.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return rt.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,rt.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,rt.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw w();if(this.right.isRed())throw w();const e=this.left.check();if(e!==this.right.check())throw w();return e+(this.isRed()?0:1)}}rt.EMPTY=null,rt.RED=!0,rt.BLACK=!1,rt.EMPTY=new class{constructor(){this.size=0}get key(){throw w()}get value(){throw w()}get color(){throw w()}get left(){throw w()}get right(){throw w()}copy(e,t,n,r,s){return this}insert(e,t,n){return new rt(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class st{constructor(e){this.comparator=e,this.data=new tt(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,n)=>(e(t),!1)))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new it(this.data.getIterator())}getIteratorFrom(e){return new it(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((e=>{t=t.add(e)})),t}isEqual(e){if(!(e instanceof st))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new st(this.comparator);return t.data=e,t}}class it{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function ot(e){return e.hasNext()?e.getNext():void 0}class at{constructor(e){this.fields=e,e.sort(z.comparator)}static empty(){return new at([])}unionWith(e){let t=new st(z.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new at(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return P(this.fields,e.fields,((e,t)=>e.isEqual(t)))}}class ct extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class ut{constructor(e){this.binaryString=e}static fromBase64String(e){const t=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new ct("Invalid base64 string: "+e):e}}(e);return new ut(t)}static fromUint8Array(e){const t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new ut(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return R(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}ut.EMPTY_BYTE_STRING=new ut("");const lt=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function ht(e){if(v(!!e),"string"==typeof e){let t=0;const n=lt.exec(e);if(v(!!n),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}return{seconds:dt(e.seconds),nanos:dt(e.nanos)}}function dt(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function ft(e){return"string"==typeof e?ut.fromBase64String(e):ut.fromUint8Array(e)}function mt(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function gt(e){const t=e.mapValue.fields.__previous_value__;return mt(t)?gt(t):t}function pt(e){const t=ht(e.mapValue.fields.__local_write_time__.timestampValue);return new V(t.seconds,t.nanos)}class yt{constructor(e,t,n,r,s,i,o,a,c){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.longPollingOptions=a,this.useFetchStreams=c}}class wt{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new wt("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof wt&&e.projectId===this.projectId&&e.database===this.database}}const vt={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},It={nullValue:"NULL_VALUE"};function _t(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?mt(e)?4:Lt(e)?9007199254740991:10:w()}function bt(e,t){if(e===t)return!0;const n=_t(e);if(n!==_t(t))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return pt(e).isEqual(pt(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=ht(e.timestampValue),r=ht(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return ft(e.bytesValue).isEqual(ft(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return dt(e.geoPointValue.latitude)===dt(t.geoPointValue.latitude)&&dt(e.geoPointValue.longitude)===dt(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return dt(e.integerValue)===dt(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=dt(e.doubleValue),r=dt(t.doubleValue);return n===r?ve(n)===ve(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return P(e.arrayValue.values||[],t.arrayValue.values||[],bt);case 10:return function(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(Ye(n)!==Ye(r))return!1;for(const e in n)if(n.hasOwnProperty(e)&&(void 0===r[e]||!bt(n[e],r[e])))return!1;return!0}(e,t);default:return w()}}function Tt(e,t){return void 0!==(e.values||[]).find((e=>bt(e,t)))}function Et(e,t){if(e===t)return 0;const n=_t(e),r=_t(t);if(n!==r)return R(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return R(e.booleanValue,t.booleanValue);case 2:return function(e,t){const n=dt(e.integerValue||e.doubleValue),r=dt(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return St(e.timestampValue,t.timestampValue);case 4:return St(pt(e),pt(t));case 5:return R(e.stringValue,t.stringValue);case 6:return function(e,t){const n=ft(e),r=ft(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){const n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){const t=R(n[e],r[e]);if(0!==t)return t}return R(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){const n=R(dt(e.latitude),dt(t.latitude));return 0!==n?n:R(dt(e.longitude),dt(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return function(e,t){const n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){const t=Et(n[e],r[e]);if(t)return t}return R(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===vt.mapValue&&t===vt.mapValue)return 0;if(e===vt.mapValue)return 1;if(t===vt.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),s=t.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let e=0;e<r.length&&e<i.length;++e){const t=R(r[e],i[e]);if(0!==t)return t;const o=Et(n[r[e]],s[i[e]]);if(0!==o)return o}return R(r.length,i.length)}(e.mapValue,t.mapValue);default:throw w()}}function St(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return R(e,t);const n=ht(e),r=ht(t),s=R(n.seconds,r.seconds);return 0!==s?s:R(n.nanos,r.nanos)}function xt(e){return Ct(e)}function Ct(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=ht(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?function(e){return ft(e).toBase64()}(e.bytesValue):"referenceValue"in e?function(e){return G.fromName(e).toString()}(e.referenceValue):"geoPointValue"in e?function(e){return`geo(${e.latitude},${e.longitude})`}(e.geoPointValue):"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=Ct(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const s of t)r?r=!1:n+=",",n+=`${s}:${Ct(e.fields[s])}`;return n+"}"}(e.mapValue):w()}function Dt(e){switch(_t(e)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:const t=gt(e);return t?16+Dt(t):16;case 5:return 2*e.stringValue.length;case 6:return ft(e.bytesValue).approximateByteSize();case 7:return e.referenceValue.length;case 9:return function(e){return(e.values||[]).reduce(((e,t)=>e+Dt(t)),0)}(e.arrayValue);case 10:return function(e){let t=0;return Xe(e.fields,((e,n)=>{t+=e.length+Dt(n)})),t}(e.mapValue);default:throw w()}}function Nt(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function At(e){return!!e&&"integerValue"in e}function kt(e){return!!e&&"arrayValue"in e}function Mt(e){return!!e&&"nullValue"in e}function Ft(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Rt(e){return!!e&&"mapValue"in e}function Pt(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return Xe(e.mapValue.fields,((e,n)=>t.mapValue.fields[e]=Pt(n))),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=Pt(e.arrayValue.values[n]);return t}return Object.assign({},e)}function Lt(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function Vt(e){return"nullValue"in e?It:"booleanValue"in e?{booleanValue:!1}:"integerValue"in e||"doubleValue"in e?{doubleValue:NaN}:"timestampValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in e?{stringValue:""}:"bytesValue"in e?{bytesValue:""}:"referenceValue"in e?Nt(wt.empty(),G.empty()):"geoPointValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in e?{arrayValue:{}}:"mapValue"in e?{mapValue:{}}:w()}function Ot(e){return"nullValue"in e?{booleanValue:!1}:"booleanValue"in e?{doubleValue:NaN}:"integerValue"in e||"doubleValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in e?{stringValue:""}:"stringValue"in e?{bytesValue:""}:"bytesValue"in e?Nt(wt.empty(),G.empty()):"referenceValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in e?{arrayValue:{}}:"arrayValue"in e?{mapValue:{}}:"mapValue"in e?vt:w()}function qt(e,t){const n=Et(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function Ut(e,t){const n=Et(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class Bt{constructor(e){this.value=e}static empty(){return new Bt({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!Rt(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Pt(t)}setAll(e){let t=z.emptyPath(),n={},r=[];e.forEach(((e,s)=>{if(!t.isImmediateParentOf(s)){const e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=s.popLast()}e?n[s.lastSegment()]=Pt(e):r.push(s.lastSegment())}));const s=this.getFieldsMap(t);this.applyChanges(s,n,r)}delete(e){const t=this.field(e.popLast());Rt(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return bt(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];Rt(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){Xe(t,((t,n)=>e[t]=n));for(const t of n)delete e[t]}clone(){return new Bt(Pt(this.value))}}function zt(e){const t=[];return Xe(e.fields,((e,n)=>{const r=new z([e]);if(Rt(n)){const e=zt(n.mapValue).fields;if(0===e.length)t.push(r);else for(const n of e)t.push(r.child(n))}else t.push(r)})),new at(t)}class Gt{constructor(e,t,n,r,s,i,o){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=s,this.data=i,this.documentState=o}static newInvalidDocument(e){return new Gt(e,0,O.min(),O.min(),O.min(),Bt.empty(),0)}static newFoundDocument(e,t,n,r){return new Gt(e,1,t,O.min(),n,r,0)}static newNoDocument(e,t){return new Gt(e,2,t,O.min(),O.min(),Bt.empty(),0)}static newUnknownDocument(e,t){return new Gt(e,3,t,O.min(),O.min(),Bt.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(O.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Bt.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Bt.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=O.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof Gt&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new Gt(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Kt{constructor(e,t){this.position=e,this.inclusive=t}}function $t(e,t,n){let r=0;for(let s=0;s<e.position.length;s++){const i=t[s],o=e.position[s];if(r=i.field.isKeyField()?G.comparator(G.fromName(o.referenceValue),n.key):Et(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return r}function Qt(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!bt(e.position[n],t.position[n]))return!1;return!0}class jt{constructor(e,t="asc"){this.field=e,this.dir=t}}function Wt(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}class Ht{}class Jt extends Ht{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new an(e,t,n):"array-contains"===t?new hn(e,n):"in"===t?new dn(e,n):"not-in"===t?new fn(e,n):"array-contains-any"===t?new mn(e,n):new Jt(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new cn(e,n):new un(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(Et(t,this.value)):null!==t&&_t(this.value)===_t(t)&&this.matchesComparison(Et(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return w()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class Yt extends Ht{constructor(e,t){super(),this.filters=e,this.op=t,this.ae=null}static create(e,t){return new Yt(e,t)}matches(e){return Xt(this)?void 0===this.filters.find((t=>!t.matches(e))):void 0!==this.filters.find((t=>t.matches(e)))}getFlattenedFilters(){return null!==this.ae||(this.ae=this.filters.reduce(((e,t)=>e.concat(t.getFlattenedFilters())),[])),this.ae}getFilters(){return Object.assign([],this.filters)}}function Xt(e){return"and"===e.op}function Zt(e){return"or"===e.op}function en(e){return tn(e)&&Xt(e)}function tn(e){for(const t of e.filters)if(t instanceof Yt)return!1;return!0}function nn(e){if(e instanceof Jt)return e.field.canonicalString()+e.op.toString()+xt(e.value);if(en(e))return e.filters.map((e=>nn(e))).join(",");{const t=e.filters.map((e=>nn(e))).join(",");return`${e.op}(${t})`}}function rn(e,t){return e instanceof Jt?function(e,t){return t instanceof Jt&&e.op===t.op&&e.field.isEqual(t.field)&&bt(e.value,t.value)}(e,t):e instanceof Yt?function(e,t){return t instanceof Yt&&e.op===t.op&&e.filters.length===t.filters.length&&e.filters.reduce(((e,n,r)=>e&&rn(n,t.filters[r])),!0)}(e,t):void w()}function sn(e,t){const n=e.filters.concat(t);return Yt.create(n,e.op)}function on(e){return e instanceof Jt?function(e){return`${e.field.canonicalString()} ${e.op} ${xt(e.value)}`}(e):e instanceof Yt?function(e){return e.op.toString()+" {"+e.getFilters().map(on).join(" ,")+"}"}(e):"Filter"}class an extends Jt{constructor(e,t,n){super(e,t,n),this.key=G.fromName(n.referenceValue)}matches(e){const t=G.comparator(e.key,this.key);return this.matchesComparison(t)}}class cn extends Jt{constructor(e,t){super(e,"in",t),this.keys=ln(0,t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class un extends Jt{constructor(e,t){super(e,"not-in",t),this.keys=ln(0,t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function ln(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((e=>G.fromName(e.referenceValue)))}class hn extends Jt{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return kt(t)&&Tt(t.arrayValue,this.value)}}class dn extends Jt{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&Tt(this.value.arrayValue,t)}}class fn extends Jt{constructor(e,t){super(e,"not-in",t)}matches(e){if(Tt(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!Tt(this.value.arrayValue,t)}}class mn extends Jt{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!kt(t)||!t.arrayValue.values)&&t.arrayValue.values.some((e=>Tt(this.value.arrayValue,e)))}}class gn{constructor(e,t=null,n=[],r=[],s=null,i=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.ue=null}}function pn(e,t=null,n=[],r=[],s=null,i=null,o=null){return new gn(e,t,n,r,s,i,o)}function yn(e){const t=I(e);if(null===t.ue){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map((e=>nn(e))).join(","),e+="|ob:",e+=t.orderBy.map((e=>function(e){return e.field.canonicalString()+e.dir}(e))).join(","),we(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((e=>xt(e))).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((e=>xt(e))).join(",")),t.ue=e}return t.ue}function wn(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let n=0;n<e.orderBy.length;n++)if(!Wt(e.orderBy[n],t.orderBy[n]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!rn(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Qt(e.startAt,t.startAt)&&Qt(e.endAt,t.endAt)}function vn(e){return G.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function In(e,t){return e.filters.filter((e=>e instanceof Jt&&e.field.isEqual(t)))}function _n(e,t,n){let r=It,s=!0;for(const n of In(e,t)){let e=It,t=!0;switch(n.op){case"<":case"<=":e=Vt(n.value);break;case"==":case"in":case">=":e=n.value;break;case">":e=n.value,t=!1;break;case"!=":case"not-in":e=It}qt({value:r,inclusive:s},{value:e,inclusive:t})<0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];qt({value:r,inclusive:s},{value:e,inclusive:n.inclusive})<0&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}function bn(e,t,n){let r=vt,s=!0;for(const n of In(e,t)){let e=vt,t=!0;switch(n.op){case">=":case">":e=Ot(n.value),t=!1;break;case"==":case"in":case"<=":e=n.value;break;case"<":e=n.value,t=!1;break;case"!=":case"not-in":e=vt}Ut({value:r,inclusive:s},{value:e,inclusive:t})>0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];Ut({value:r,inclusive:s},{value:e,inclusive:n.inclusive})>0&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}class Tn{constructor(e,t=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}}function En(e,t,n,r,s,i,o,a){return new Tn(e,t,n,r,s,i,o,a)}function Sn(e){return new Tn(e)}function xn(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Cn(e){return null!==e.collectionGroup}function Dn(e){const t=I(e);if(null===t.ce){t.ce=[];const e=new Set;for(const n of t.explicitOrderBy)t.ce.push(n),e.add(n.field.canonicalString());const n=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc",r=function(e){let t=new st(z.comparator);return e.filters.forEach((e=>{e.getFlattenedFilters().forEach((e=>{e.isInequality()&&(t=t.add(e.field))}))})),t}(t);r.forEach((r=>{e.has(r.canonicalString())||r.isKeyField()||t.ce.push(new jt(r,n))})),e.has(z.keyField().canonicalString())||t.ce.push(new jt(z.keyField(),n))}return t.ce}function Nn(e){const t=I(e);return t.le||(t.le=kn(t,Dn(e))),t.le}function An(e){const t=I(e);return t.he||(t.he=kn(t,e.explicitOrderBy)),t.he}function kn(e,t){if("F"===e.limitType)return pn(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map((e=>{const t="desc"===e.dir?"asc":"desc";return new jt(e.field,t)}));const n=e.endAt?new Kt(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new Kt(e.startAt.position,e.startAt.inclusive):null;return pn(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}function Mn(e,t){const n=e.filters.concat([t]);return new Tn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function Fn(e,t,n){return new Tn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Rn(e,t){return wn(Nn(e),Nn(t))&&e.limitType===t.limitType}function Pn(e){return`${yn(Nn(e))}|lt:${e.limitType}`}function Ln(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map((e=>on(e))).join(", ")}]`),we(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map((e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e))).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((e=>xt(e))).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((e=>xt(e))).join(",")),`Target(${t})`}(Nn(e))}; limitType=${e.limitType})`}function Vn(e,t){return t.isFoundDocument()&&function(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):G.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(const n of Dn(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function(e,t){return!(e.startAt&&!function(e,t,n){const r=$t(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,Dn(e),t)||e.endAt&&!function(e,t,n){const r=$t(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,Dn(e),t))}(e,t)}function On(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function qn(e){return(t,n)=>{let r=!1;for(const s of Dn(e)){const e=Un(s,t,n);if(0!==e)return e;r=r||s.field.isKeyField()}return 0}}function Un(e,t,n){const r=e.field.isKeyField()?G.comparator(t.key,n.key):function(e,t,n){const r=t.data.field(e),s=n.data.field(e);return null!==r&&null!==s?Et(r,s):w()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return w()}}class Bn{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){Xe(this.inner,((t,n)=>{for(const[t,r]of n)e(t,r)}))}isEmpty(){return et(this.inner)}size(){return this.innerSize}}const zn=new tt(G.comparator);function Gn(){return zn}const Kn=new tt(G.comparator);function $n(...e){let t=Kn;for(const n of e)t=t.insert(n.key,n);return t}function Qn(e){let t=Kn;return e.forEach(((e,n)=>t=t.insert(e,n.overlayedDocument))),t}function jn(){return Hn()}function Wn(){return Hn()}function Hn(){return new Bn((e=>e.toString()),((e,t)=>e.isEqual(t)))}const Jn=new tt(G.comparator),Yn=new st(G.comparator);function Xn(...e){let t=Yn;for(const n of e)t=t.add(n);return t}const Zn=new st(R);function er(){return Zn}function tr(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:ve(t)?"-0":t}}function nr(e){return{integerValue:""+e}}function rr(e,t){return Ie(t)?nr(t):tr(e,t)}class sr{constructor(){this._=void 0}}function ir(e,t,n){return e instanceof cr?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&mt(t)&&(t=gt(t)),t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof ur?lr(e,t):e instanceof hr?dr(e,t):function(e,t){const n=ar(e,t),r=mr(n)+mr(e.Pe);return At(n)&&At(e.Pe)?nr(r):tr(e.serializer,r)}(e,t)}function or(e,t,n){return e instanceof ur?lr(e,t):e instanceof hr?dr(e,t):n}function ar(e,t){return e instanceof fr?function(e){return At(e)||function(e){return!!e&&"doubleValue"in e}(e)}(t)?t:{integerValue:0}:null}class cr extends sr{}class ur extends sr{constructor(e){super(),this.elements=e}}function lr(e,t){const n=gr(t);for(const t of e.elements)n.some((e=>bt(e,t)))||n.push(t);return{arrayValue:{values:n}}}class hr extends sr{constructor(e){super(),this.elements=e}}function dr(e,t){let n=gr(t);for(const t of e.elements)n=n.filter((e=>!bt(e,t)));return{arrayValue:{values:n}}}class fr extends sr{constructor(e,t){super(),this.serializer=e,this.Pe=t}}function mr(e){return dt(e.integerValue||e.doubleValue)}function gr(e){return kt(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class pr{constructor(e,t){this.field=e,this.transform=t}}class yr{constructor(e,t){this.version=e,this.transformResults=t}}class wr{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new wr}static exists(e){return new wr(void 0,e)}static updateTime(e){return new wr(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function vr(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class Ir{}function _r(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new kr(e.key,wr.none()):new xr(e.key,e.data,wr.none());{const n=e.data,r=Bt.empty();let s=new st(z.comparator);for(let e of t.fields)if(!s.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),s=s.add(e)}return new Cr(e.key,r,new at(s.toArray()),wr.none())}}function br(e,t,n){e instanceof xr?function(e,t,n){const r=e.value.clone(),s=Nr(e.fieldTransforms,t,n.transformResults);r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof Cr?function(e,t,n){if(!vr(e.precondition,t))return void t.convertToUnknownDocument(n.version);const r=Nr(e.fieldTransforms,t,n.transformResults),s=t.data;s.setAll(Dr(e)),s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function Tr(e,t,n,r){return e instanceof xr?function(e,t,n,r){if(!vr(e.precondition,t))return n;const s=e.value.clone(),i=Ar(e.fieldTransforms,r,t);return s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null}(e,t,n,r):e instanceof Cr?function(e,t,n,r){if(!vr(e.precondition,t))return n;const s=Ar(e.fieldTransforms,r,t),i=t.data;return i.setAll(Dr(e)),i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map((e=>e.field)))}(e,t,n,r):function(e,t,n){return vr(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}(e,t,n)}function Er(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=ar(r.transform,e||null);null!=s&&(null===n&&(n=Bt.empty()),n.set(r.field,s))}return n||null}function Sr(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&P(e,t,((e,t)=>function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof ur&&t instanceof ur||e instanceof hr&&t instanceof hr?P(e.elements,t.elements,bt):e instanceof fr&&t instanceof fr?bt(e.Pe,t.Pe):e instanceof cr&&t instanceof cr}(e.transform,t.transform)}(e,t)))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class xr extends Ir{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class Cr extends Ir{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function Dr(e){const t=new Map;return e.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=e.data.field(n);t.set(n,r)}})),t}function Nr(e,t,n){const r=new Map;v(e.length===n.length);for(let s=0;s<n.length;s++){const i=e[s],o=i.transform,a=t.data.field(i.field);r.set(i.field,or(o,a,n[s]))}return r}function Ar(e,t,n){const r=new Map;for(const s of e){const e=s.transform,i=n.data.field(s.field);r.set(s.field,ir(e,i,t))}return r}class kr extends Ir{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Mr extends Ir{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Fr{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){const r=this.mutations[t];r.key.isEqual(e.key)&&br(r,e,n[t])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=Tr(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=Tr(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=Wn();return this.mutations.forEach((r=>{const s=e.get(r.key),i=s.overlayedDocument;let o=this.applyToLocalView(i,s.mutatedFields);o=t.has(r.key)?null:o;const a=_r(i,o);null!==a&&n.set(r.key,a),i.isValidDocument()||i.convertToNoDocument(O.min())})),n}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),Xn())}isEqual(e){return this.batchId===e.batchId&&P(this.mutations,e.mutations,((e,t)=>Sr(e,t)))&&P(this.baseMutations,e.baseMutations,((e,t)=>Sr(e,t)))}}class Rr{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){v(e.mutations.length===n.length);let r=Jn;const s=e.mutations;for(let e=0;e<s.length;e++)r=r.insert(s[e].key,n[e].version);return new Rr(e,t,n,r)}}class Pr{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Lr{constructor(e,t,n){this.alias=e,this.aggregateType=t,this.fieldPath=n}}class Vr{constructor(e,t){this.count=e,this.unchangedNames=t}}var Or,qr;function Ur(e){switch(e){default:return w();case _.CANCELLED:case _.UNKNOWN:case _.DEADLINE_EXCEEDED:case _.RESOURCE_EXHAUSTED:case _.INTERNAL:case _.UNAVAILABLE:case _.UNAUTHENTICATED:return!1;case _.INVALID_ARGUMENT:case _.NOT_FOUND:case _.ALREADY_EXISTS:case _.PERMISSION_DENIED:case _.FAILED_PRECONDITION:case _.ABORTED:case _.OUT_OF_RANGE:case _.UNIMPLEMENTED:case _.DATA_LOSS:return!0}}function Br(e){if(void 0===e)return g("GRPC error has no .code"),_.UNKNOWN;switch(e){case Or.OK:return _.OK;case Or.CANCELLED:return _.CANCELLED;case Or.UNKNOWN:return _.UNKNOWN;case Or.DEADLINE_EXCEEDED:return _.DEADLINE_EXCEEDED;case Or.RESOURCE_EXHAUSTED:return _.RESOURCE_EXHAUSTED;case Or.INTERNAL:return _.INTERNAL;case Or.UNAVAILABLE:return _.UNAVAILABLE;case Or.UNAUTHENTICATED:return _.UNAUTHENTICATED;case Or.INVALID_ARGUMENT:return _.INVALID_ARGUMENT;case Or.NOT_FOUND:return _.NOT_FOUND;case Or.ALREADY_EXISTS:return _.ALREADY_EXISTS;case Or.PERMISSION_DENIED:return _.PERMISSION_DENIED;case Or.FAILED_PRECONDITION:return _.FAILED_PRECONDITION;case Or.ABORTED:return _.ABORTED;case Or.OUT_OF_RANGE:return _.OUT_OF_RANGE;case Or.UNIMPLEMENTED:return _.UNIMPLEMENTED;case Or.DATA_LOSS:return _.DATA_LOSS;default:return w()}}(qr=Or||(Or={}))[qr.OK=0]="OK",qr[qr.CANCELLED=1]="CANCELLED",qr[qr.UNKNOWN=2]="UNKNOWN",qr[qr.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",qr[qr.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",qr[qr.NOT_FOUND=5]="NOT_FOUND",qr[qr.ALREADY_EXISTS=6]="ALREADY_EXISTS",qr[qr.PERMISSION_DENIED=7]="PERMISSION_DENIED",qr[qr.UNAUTHENTICATED=16]="UNAUTHENTICATED",qr[qr.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",qr[qr.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",qr[qr.ABORTED=10]="ABORTED",qr[qr.OUT_OF_RANGE=11]="OUT_OF_RANGE",qr[qr.UNIMPLEMENTED=12]="UNIMPLEMENTED",qr[qr.INTERNAL=13]="INTERNAL",qr[qr.UNAVAILABLE=14]="UNAVAILABLE",qr[qr.DATA_LOSS=15]="DATA_LOSS";let zr=null;function Gr(){return new TextEncoder}const Kr=new a.Integer([4294967295,4294967295],0);function $r(e){const t=Gr().encode(e),n=new a.Md5;return n.update(t),new Uint8Array(n.digest())}function Qr(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),s=t.getUint32(8,!0),i=t.getUint32(12,!0);return[new a.Integer([n,r],0),new a.Integer([s,i],0)]}class jr{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new Wr(`Invalid padding: ${t}`);if(n<0)throw new Wr(`Invalid hash count: ${n}`);if(e.length>0&&0===this.hashCount)throw new Wr(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new Wr(`Invalid padding when bitmap length is 0: ${t}`);this.Ie=8*e.length-t,this.Te=a.Integer.fromNumber(this.Ie)}Ee(e,t,n){let r=e.add(t.multiply(a.Integer.fromNumber(n)));return 1===r.compare(Kr)&&(r=new a.Integer([r.getBits(0),r.getBits(1)],0)),r.modulo(this.Te).toNumber()}de(e){return 0!=(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Ie)return!1;const t=$r(e),[n,r]=Qr(t);for(let e=0;e<this.hashCount;e++){const t=this.Ee(n,r,e);if(!this.de(t))return!1}return!0}static create(e,t,n){const r=e%8==0?0:8-e%8,s=new Uint8Array(Math.ceil(e/8)),i=new jr(s,r,t);return n.forEach((e=>i.insert(e))),i}insert(e){if(0===this.Ie)return;const t=$r(e),[n,r]=Qr(t);for(let e=0;e<this.hashCount;e++){const t=this.Ee(n,r,e);this.Ae(t)}}Ae(e){const t=Math.floor(e/8),n=e%8;this.bitmap[t]|=1<<n}}class Wr extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class Hr{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,Jr.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new Hr(O.min(),r,new tt(R),Gn(),Xn())}}class Jr{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new Jr(n,t,Xn(),Xn(),Xn())}}class Yr{constructor(e,t,n,r){this.Re=e,this.removedTargetIds=t,this.key=n,this.Ve=r}}class Xr{constructor(e,t){this.targetId=e,this.me=t}}class Zr{constructor(e,t,n=ut.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class es{constructor(){this.fe=0,this.ge=rs(),this.pe=ut.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return 0!==this.fe}get be(){return this.we}De(e){e.approximateByteSize()>0&&(this.we=!0,this.pe=e)}Ce(){let e=Xn(),t=Xn(),n=Xn();return this.ge.forEach(((r,s)=>{switch(s){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:w()}})),new Jr(this.pe,this.ye,e,t,n)}ve(){this.we=!1,this.ge=rs()}Fe(e,t){this.we=!0,this.ge=this.ge.insert(e,t)}Me(e){this.we=!0,this.ge=this.ge.remove(e)}xe(){this.fe+=1}Oe(){this.fe-=1,v(this.fe>=0)}Ne(){this.we=!0,this.ye=!0}}class ts{constructor(e){this.Le=e,this.Be=new Map,this.ke=Gn(),this.qe=ns(),this.Qe=new tt(R)}Ke(e){for(const t of e.Re)e.Ve&&e.Ve.isFoundDocument()?this.$e(t,e.Ve):this.Ue(t,e.key,e.Ve);for(const t of e.removedTargetIds)this.Ue(t,e.key,e.Ve)}We(e){this.forEachTarget(e,(t=>{const n=this.Ge(t);switch(e.state){case 0:this.ze(t)&&n.De(e.resumeToken);break;case 1:n.Oe(),n.Se||n.ve(),n.De(e.resumeToken);break;case 2:n.Oe(),n.Se||this.removeTarget(t);break;case 3:this.ze(t)&&(n.Ne(),n.De(e.resumeToken));break;case 4:this.ze(t)&&(this.je(t),n.De(e.resumeToken));break;default:w()}}))}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Be.forEach(((e,n)=>{this.ze(n)&&t(n)}))}He(e){const t=e.targetId,n=e.me.count,r=this.Je(t);if(r){const s=r.target;if(vn(s))if(0===n){const e=new G(s.path);this.Ue(t,e,Gt.newNoDocument(e,O.min()))}else v(1===n);else{const r=this.Ye(t);if(r!==n){const n=this.Ze(e),s=n?this.Xe(n,e,r):1;if(0!==s){this.je(t);const e=2===s?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Qe=this.Qe.insert(t,e)}null==zr||zr.et(function(e,t,n,r,s){var i,o,a,c,u,l;const h={localCacheCount:e,existenceFilterCount:t.count,databaseId:n.database,projectId:n.projectId},d=t.unchangedNames;return d&&(h.bloomFilter={applied:0===s,hashCount:null!==(i=null==d?void 0:d.hashCount)&&void 0!==i?i:0,bitmapLength:null!==(c=null===(a=null===(o=null==d?void 0:d.bits)||void 0===o?void 0:o.bitmap)||void 0===a?void 0:a.length)&&void 0!==c?c:0,padding:null!==(l=null===(u=null==d?void 0:d.bits)||void 0===u?void 0:u.padding)&&void 0!==l?l:0,mightContain:e=>{var t;return null!==(t=null==r?void 0:r.mightContain(e))&&void 0!==t&&t}}),h}(r,e.me,this.Le.tt(),n,s))}}}}Ze(e){const t=e.me.unchangedNames;if(!t||!t.bits)return null;const{bits:{bitmap:n="",padding:r=0},hashCount:s=0}=t;let i,o;try{i=ft(n).toUint8Array()}catch(e){if(e instanceof ct)return p("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{o=new jr(i,r,s)}catch(e){return p(e instanceof Wr?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===o.Ie?null:o}Xe(e,t,n){return t.me.count===n-this.nt(e,t.targetId)?0:2}nt(e,t){const n=this.Le.getRemoteKeysForTarget(t);let r=0;return n.forEach((n=>{const s=this.Le.tt(),i=`projects/${s.projectId}/databases/${s.database}/documents/${n.path.canonicalString()}`;e.mightContain(i)||(this.Ue(t,n,null),r++)})),r}rt(e){const t=new Map;this.Be.forEach(((n,r)=>{const s=this.Je(r);if(s){if(n.current&&vn(s.target)){const t=new G(s.target.path);null!==this.ke.get(t)||this.it(r,t)||this.Ue(r,t,Gt.newNoDocument(t,e))}n.be&&(t.set(r,n.Ce()),n.ve())}}));let n=Xn();this.qe.forEach(((e,t)=>{let r=!0;t.forEachWhile((e=>{const t=this.Je(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1,!1)})),r&&(n=n.add(e))})),this.ke.forEach(((t,n)=>n.setReadTime(e)));const r=new Hr(e,t,this.Qe,this.ke,n);return this.ke=Gn(),this.qe=ns(),this.Qe=new tt(R),r}$e(e,t){if(!this.ze(e))return;const n=this.it(e,t.key)?2:0;this.Ge(e).Fe(t.key,n),this.ke=this.ke.insert(t.key,t),this.qe=this.qe.insert(t.key,this.st(t.key).add(e))}Ue(e,t,n){if(!this.ze(e))return;const r=this.Ge(e);this.it(e,t)?r.Fe(t,1):r.Me(t),this.qe=this.qe.insert(t,this.st(t).delete(e)),n&&(this.ke=this.ke.insert(t,n))}removeTarget(e){this.Be.delete(e)}Ye(e){const t=this.Ge(e).Ce();return this.Le.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}xe(e){this.Ge(e).xe()}Ge(e){let t=this.Be.get(e);return t||(t=new es,this.Be.set(e,t)),t}st(e){let t=this.qe.get(e);return t||(t=new st(R),this.qe=this.qe.insert(e,t)),t}ze(e){const t=null!==this.Je(e);return t||m("WatchChangeAggregator","Detected inactive target",e),t}Je(e){const t=this.Be.get(e);return t&&t.Se?null:this.Le.ot(e)}je(e){this.Be.set(e,new es),this.Le.getRemoteKeysForTarget(e).forEach((t=>{this.Ue(e,t,null)}))}it(e,t){return this.Le.getRemoteKeysForTarget(e).has(t)}}function ns(){return new tt(G.comparator)}function rs(){return new tt(G.comparator)}const ss={asc:"ASCENDING",desc:"DESCENDING"},is={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},os={and:"AND",or:"OR"};class as{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function cs(e,t){return e.useProto3Json||we(t)?t:{value:t}}function us(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function ls(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function hs(e,t){return us(e,t.toTimestamp())}function ds(e){return v(!!e),O.fromTimestamp(function(e){const t=ht(e);return new V(t.seconds,t.nanos)}(e))}function fs(e,t){return ms(e,t).canonicalString()}function ms(e,t){const n=function(e){return new U(["projects",e.projectId,"databases",e.database])}(e).child("documents");return void 0===t?n:n.child(t)}function gs(e){const t=U.fromString(e);return v(Os(t)),t}function ps(e,t){return fs(e.databaseId,t.path)}function ys(e,t){const n=gs(t);if(n.get(1)!==e.databaseId.projectId)throw new b(_.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new b(_.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new G(_s(n))}function ws(e,t){return fs(e.databaseId,t)}function vs(e){const t=gs(e);return 4===t.length?U.emptyPath():_s(t)}function Is(e){return new U(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function _s(e){return v(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function bs(e,t,n){return{name:ps(e,t),fields:n.value.mapValue.fields}}function Ts(e,t,n){const r=ys(e,t.name),s=ds(t.updateTime),i=t.createTime?ds(t.createTime):O.min(),o=new Bt({mapValue:{fields:t.fields}}),a=Gt.newFoundDocument(r,s,i,o);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}function Es(e,t){let n;if(t instanceof xr)n={update:bs(e,t.key,t.value)};else if(t instanceof kr)n={delete:ps(e,t.key)};else if(t instanceof Cr)n={update:bs(e,t.key,t.data),updateMask:Vs(t.fieldMask)};else{if(!(t instanceof Mr))return w();n={verify:ps(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((e=>function(e,t){const n=t.transform;if(n instanceof cr)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof ur)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof hr)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof fr)return{fieldPath:t.field.canonicalString(),increment:n.Pe};throw w()}(0,e)))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:hs(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:w()}(e,t.precondition)),n}function Ss(e,t){const n=t.currentDocument?function(e){return void 0!==e.updateTime?wr.updateTime(ds(e.updateTime)):void 0!==e.exists?wr.exists(e.exists):wr.none()}(t.currentDocument):wr.none(),r=t.updateTransforms?t.updateTransforms.map((t=>function(e,t){let n=null;if("setToServerValue"in t)v("REQUEST_TIME"===t.setToServerValue),n=new cr;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new ur(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new hr(e)}else"increment"in t?n=new fr(e,t.increment):w();const r=z.fromServerFormat(t.fieldPath);return new pr(r,n)}(e,t))):[];if(t.update){t.update.name;const s=ys(e,t.update.name),i=new Bt({mapValue:{fields:t.update.fields}});if(t.updateMask){const e=function(e){const t=e.fieldPaths||[];return new at(t.map((e=>z.fromServerFormat(e))))}(t.updateMask);return new Cr(s,i,e,n,r)}return new xr(s,i,n,r)}if(t.delete){const r=ys(e,t.delete);return new kr(r,n)}if(t.verify){const r=ys(e,t.verify);return new Mr(r,n)}return w()}function xs(e,t){return{documents:[ws(e,t.path)]}}function Cs(e,t){const n={structuredQuery:{}},r=t.path;let s;null!==t.collectionGroup?(s=r,n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(s=r.popLast(),n.structuredQuery.from=[{collectionId:r.lastSegment()}]),n.parent=ws(e,s);const i=function(e){if(0!==e.length)return Ls(Yt.create(e,"and"))}(t.filters);i&&(n.structuredQuery.where=i);const o=function(e){if(0!==e.length)return e.map((e=>function(e){return{field:Rs(e.field),direction:ks(e.dir)}}(e)))}(t.orderBy);o&&(n.structuredQuery.orderBy=o);const a=cs(e,t.limit);return null!==a&&(n.structuredQuery.limit=a),t.startAt&&(n.structuredQuery.startAt=function(e){return{before:e.inclusive,values:e.position}}(t.startAt)),t.endAt&&(n.structuredQuery.endAt=function(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),{_t:n,parent:s}}function Ds(e,t,n,r){const{_t:s,parent:i}=Cs(e,t),o={},a=[];let c=0;return n.forEach((e=>{const t=r?e.alias:"aggregate_"+c++;o[t]=e.alias,"count"===e.aggregateType?a.push({alias:t,count:{}}):"avg"===e.aggregateType?a.push({alias:t,avg:{field:Rs(e.fieldPath)}}):"sum"===e.aggregateType&&a.push({alias:t,sum:{field:Rs(e.fieldPath)}})})),{request:{structuredAggregationQuery:{aggregations:a,structuredQuery:s.structuredQuery},parent:s.parent},ut:o,parent:i}}function Ns(e){let t=vs(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){v(1===r);const e=n.from[0];e.allDescendants?s=e.collectionId:t=t.child(e.collectionId)}let i=[];n.where&&(i=function(e){const t=As(e);return t instanceof Yt&&en(t)?t.getFilters():[t]}(n.where));let o=[];n.orderBy&&(o=function(e){return e.map((e=>function(e){return new jt(Ps(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e)))}(n.orderBy));let a=null;n.limit&&(a=function(e){let t;return t="object"==typeof e?e.value:e,we(t)?null:t}(n.limit));let c=null;n.startAt&&(c=function(e){const t=!!e.before,n=e.values||[];return new Kt(n,t)}(n.startAt));let u=null;return n.endAt&&(u=function(e){const t=!e.before,n=e.values||[];return new Kt(n,t)}(n.endAt)),En(t,s,o,i,a,"F",c,u)}function As(e){return void 0!==e.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=Ps(e.unaryFilter.field);return Jt.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=Ps(e.unaryFilter.field);return Jt.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Ps(e.unaryFilter.field);return Jt.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=Ps(e.unaryFilter.field);return Jt.create(s,"!=",{nullValue:"NULL_VALUE"});default:return w()}}(e):void 0!==e.fieldFilter?function(e){return Jt.create(Ps(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return w()}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function(e){return Yt.create(e.compositeFilter.filters.map((e=>As(e))),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return w()}}(e.compositeFilter.op))}(e):w()}function ks(e){return ss[e]}function Ms(e){return is[e]}function Fs(e){return os[e]}function Rs(e){return{fieldPath:e.canonicalString()}}function Ps(e){return z.fromServerFormat(e.fieldPath)}function Ls(e){return e instanceof Jt?function(e){if("=="===e.op){if(Ft(e.value))return{unaryFilter:{field:Rs(e.field),op:"IS_NAN"}};if(Mt(e.value))return{unaryFilter:{field:Rs(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Ft(e.value))return{unaryFilter:{field:Rs(e.field),op:"IS_NOT_NAN"}};if(Mt(e.value))return{unaryFilter:{field:Rs(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Rs(e.field),op:Ms(e.op),value:e.value}}}(e):e instanceof Yt?function(e){const t=e.getFilters().map((e=>Ls(e)));return 1===t.length?t[0]:{compositeFilter:{op:Fs(e.op),filters:t}}}(e):w()}function Vs(e){const t=[];return e.fields.forEach((e=>t.push(e.canonicalString()))),{fieldPaths:t}}function Os(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class qs{constructor(e,t,n,r,s=O.min(),i=O.min(),o=ut.EMPTY_BYTE_STRING,a=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o,this.expectedCount=a}withSequenceNumber(e){return new qs(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new qs(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new qs(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new qs(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class Us{constructor(e){this.ct=e}}function Bs(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:zs(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document=function(e,t){return{name:ps(e,t.key),fields:t.data.value.mapValue.fields,updateTime:us(e,t.version.toTimestamp()),createTime:us(e,t.createTime.toTimestamp())}}(e.ct,t);else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:Gs(t.version)};else{if(!t.isUnknownDocument())return w();r.unknownDocument={path:n.path.toArray(),version:Gs(t.version)}}return r}function zs(e){const t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function Gs(e){const t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function Ks(e){const t=new V(e.seconds,e.nanoseconds);return O.fromTimestamp(t)}function $s(e,t){const n=(t.baseMutations||[]).map((t=>Ss(e.ct,t)));for(let e=0;e<t.mutations.length-1;++e){const n=t.mutations[e];if(e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform){const r=t.mutations[e+1];n.updateTransforms=r.transform.fieldTransforms,t.mutations.splice(e+1,1),++e}}const r=t.mutations.map((t=>Ss(e.ct,t))),s=V.fromMillis(t.localWriteTimeMs);return new Fr(t.batchId,s,n,r)}function Qs(e){const t=Ks(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?Ks(e.lastLimboFreeSnapshotVersion):O.min();let r;return r=function(e){return void 0!==e.documents}(e.query)?function(e){return v(1===e.documents.length),Nn(Sn(vs(e.documents[0])))}(e.query):function(e){return Nn(Ns(e))}(e.query),new qs(r,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,t,n,ut.fromBase64String(e.resumeToken))}function js(e,t){const n=Gs(t.snapshotVersion),r=Gs(t.lastLimboFreeSnapshotVersion);let s;s=vn(t.target)?xs(e.ct,t.target):Cs(e.ct,t.target)._t;const i=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:yn(t.target),readTime:n,resumeToken:i,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function Ws(e){const t=Ns({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Fn(t,t.limit,"L"):t}function Hs(e,t){return new Pr(t.largestBatchId,Ss(e.ct,t.overlayMutation))}function Js(e,t){const n=t.path.lastSegment();return[e,_e(t.path.popLast()),n]}function Ys(e,t,n,r){return{indexId:e,uid:t,sequenceNumber:n,readTime:Gs(r.readTime),documentKey:_e(r.documentKey.path),largestBatchId:r.largestBatchId}}class Xs{getBundleMetadata(e,t){return Zs(e).get(t).next((e=>{if(e)return function(e){return{id:e.bundleId,createTime:Ks(e.createTime),version:e.version}}(e)}))}saveBundleMetadata(e,t){return Zs(e).put(function(e){return{bundleId:e.id,createTime:Gs(ds(e.createTime)),version:e.version}}(t))}getNamedQuery(e,t){return ei(e).get(t).next((e=>{if(e)return function(e){return{name:e.name,query:Ws(e.bundledQuery),readTime:Ks(e.readTime)}}(e)}))}saveNamedQuery(e,t){return ei(e).put(function(e){return{name:e.name,readTime:Gs(ds(e.readTime)),bundledQuery:e.bundledQuery}}(t))}}function Zs(e){return Je(e,"bundles")}function ei(e){return Je(e,"namedQueries")}class ti{constructor(e,t){this.serializer=e,this.userId=t}static lt(e,t){const n=t.uid||"";return new ti(e,n)}getOverlay(e,t){return ni(e).get(Js(this.userId,t)).next((e=>e?Hs(this.serializer,e):null))}getOverlays(e,t){const n=jn();return se.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){const r=[];return n.forEach(((n,s)=>{const i=new Pr(t,s);r.push(this.ht(e,i))})),se.waitFor(r)}removeOverlaysForBatchId(e,t,n){const r=new Set;t.forEach((e=>r.add(_e(e.getCollectionPath()))));const s=[];return r.forEach((t=>{const r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);s.push(ni(e).j("collectionPathOverlayIndex",r))})),se.waitFor(s)}getOverlaysForCollection(e,t,n){const r=jn(),s=_e(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return ni(e).U("collectionPathOverlayIndex",i).next((e=>{for(const t of e){const e=Hs(this.serializer,t);r.set(e.getKey(),e)}return r}))}getOverlaysForCollectionGroup(e,t,n,r){const s=jn();let i;const o=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return ni(e).J({index:"collectionGroupOverlayIndex",range:o},((e,t,n)=>{const o=Hs(this.serializer,t);s.size()<r||o.largestBatchId===i?(s.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>s))}ht(e,t){return ni(e).put(function(e,t,n){const[r,s,i]=Js(t,n.mutation.key);return{userId:t,collectionPath:s,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:Es(e.ct,n.mutation)}}(this.serializer,this.userId,t))}}function ni(e){return Je(e,"documentOverlays")}class ri{constructor(){}Pt(e,t){this.It(e,t),t.Tt()}It(e,t){if("nullValue"in e)this.Et(t,5);else if("booleanValue"in e)this.Et(t,10),t.dt(e.booleanValue?1:0);else if("integerValue"in e)this.Et(t,15),t.dt(dt(e.integerValue));else if("doubleValue"in e){const n=dt(e.doubleValue);isNaN(n)?this.Et(t,13):(this.Et(t,15),ve(n)?t.dt(0):t.dt(n))}else if("timestampValue"in e){let n=e.timestampValue;this.Et(t,20),"string"==typeof n&&(n=ht(n)),t.At(`${n.seconds||""}`),t.dt(n.nanos||0)}else if("stringValue"in e)this.Rt(e.stringValue,t),this.Vt(t);else if("bytesValue"in e)this.Et(t,30),t.ft(ft(e.bytesValue)),this.Vt(t);else if("referenceValue"in e)this.gt(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.Et(t,45),t.dt(n.latitude||0),t.dt(n.longitude||0)}else"mapValue"in e?Lt(e)?this.Et(t,Number.MAX_SAFE_INTEGER):(this.yt(e.mapValue,t),this.Vt(t)):"arrayValue"in e?(this.wt(e.arrayValue,t),this.Vt(t)):w()}Rt(e,t){this.Et(t,25),this.St(e,t)}St(e,t){t.At(e)}yt(e,t){const n=e.fields||{};this.Et(t,55);for(const e of Object.keys(n))this.Rt(e,t),this.It(n[e],t)}wt(e,t){const n=e.values||[];this.Et(t,50);for(const e of n)this.It(e,t)}gt(e,t){this.Et(t,37),G.fromName(e).path.forEach((e=>{this.Et(t,60),this.St(e,t)}))}Et(e,t){e.dt(t)}Vt(e){e.dt(2)}}function si(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}function ii(e){const t=64-function(e){let t=0;for(let n=0;n<8;++n){const r=si(255&e[n]);if(t+=r,8!==r)break}return t}(e);return Math.ceil(t/8)}ri.bt=new ri;class oi{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Dt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ct(n.value),n=t.next();this.vt()}Ft(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Mt(n.value),n=t.next();this.xt()}Ot(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ct(e);else if(e<2048)this.Ct(960|e>>>6),this.Ct(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ct(480|e>>>12),this.Ct(128|63&e>>>6),this.Ct(128|63&e);else{const e=t.codePointAt(0);this.Ct(240|e>>>18),this.Ct(128|63&e>>>12),this.Ct(128|63&e>>>6),this.Ct(128|63&e)}}this.vt()}Nt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Mt(e);else if(e<2048)this.Mt(960|e>>>6),this.Mt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Mt(480|e>>>12),this.Mt(128|63&e>>>6),this.Mt(128|63&e);else{const e=t.codePointAt(0);this.Mt(240|e>>>18),this.Mt(128|63&e>>>12),this.Mt(128|63&e>>>6),this.Mt(128|63&e)}}this.xt()}Lt(e){const t=this.Bt(e),n=ii(t);this.kt(1+n),this.buffer[this.position++]=255&n;for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=255&t[e]}qt(e){const t=this.Bt(e),n=ii(t);this.kt(1+n),this.buffer[this.position++]=~(255&n);for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}Qt(){this.Kt(255),this.Kt(255)}$t(){this.Ut(255),this.Ut(255)}reset(){this.position=0}seed(e){this.kt(e.length),this.buffer.set(e,this.position),this.position+=e.length}Wt(){return this.buffer.slice(0,this.position)}Bt(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=n?255:0;return t}Ct(e){const t=255&e;0===t?(this.Kt(0),this.Kt(255)):255===t?(this.Kt(255),this.Kt(0)):this.Kt(t)}Mt(e){const t=255&e;0===t?(this.Ut(0),this.Ut(255)):255===t?(this.Ut(255),this.Ut(0)):this.Ut(e)}vt(){this.Kt(0),this.Kt(1)}xt(){this.Ut(0),this.Ut(1)}Kt(e){this.kt(1),this.buffer[this.position++]=e}Ut(e){this.kt(1),this.buffer[this.position++]=~e}kt(e){const t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);const r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class ai{constructor(e){this.Gt=e}ft(e){this.Gt.Dt(e)}At(e){this.Gt.Ot(e)}dt(e){this.Gt.Lt(e)}Tt(){this.Gt.Qt()}}class ci{constructor(e){this.Gt=e}ft(e){this.Gt.Ft(e)}At(e){this.Gt.Nt(e)}dt(e){this.Gt.qt(e)}Tt(){this.Gt.$t()}}class ui{constructor(){this.Gt=new oi,this.zt=new ai(this.Gt),this.jt=new ci(this.Gt)}seed(e){this.Gt.seed(e)}Ht(e){return 0===e?this.zt:this.jt}Wt(){return this.Gt.Wt()}reset(){this.Gt.reset()}}class li{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Jt(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new li(this.indexId,this.documentKey,this.arrayValue,n)}}function hi(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=di(e.arrayValue,t.arrayValue),0!==n?n:(n=di(e.directionalValue,t.directionalValue),0!==n?n:G.comparator(e.documentKey,t.documentKey)))}function di(e,t){for(let n=0;n<e.length&&n<t.length;++n){const r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}class fi{constructor(e){this.Yt=new st(((e,t)=>z.comparator(e.field,t.field))),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Zt=e.orderBy,this.Xt=[];for(const t of e.filters){const e=t;e.isInequality()?this.Yt=this.Yt.add(e):this.Xt.push(e)}}get en(){return this.Yt.size>1}tn(e){if(v(e.collectionGroup===this.collectionId),this.en)return!1;const t=$(e);if(void 0!==t&&!this.nn(t))return!1;const n=Q(e);let r=new Set,s=0,i=0;for(;s<n.length&&this.nn(n[s]);++s)r=r.add(n[s].fieldPath.canonicalString());if(s===n.length)return!0;if(this.Yt.size>0){const e=this.Yt.getIterator().getNext();if(!r.has(e.field.canonicalString())){const t=n[s];if(!this.rn(e,t)||!this.sn(this.Zt[i++],t))return!1}++s}for(;s<n.length;++s){const e=n[s];if(i>=this.Zt.length||!this.sn(this.Zt[i++],e))return!1}return!0}on(){if(this.en)return null;let e=new st(z.comparator);const t=[];for(const n of this.Xt)if(!n.field.isKeyField())if("array-contains"===n.op||"array-contains-any"===n.op)t.push(new W(n.field,2));else{if(e.has(n.field))continue;e=e.add(n.field),t.push(new W(n.field,0))}for(const n of this.Zt)n.field.isKeyField()||e.has(n.field)||(e=e.add(n.field),t.push(new W(n.field,"asc"===n.dir?0:1)));return new K(K.UNKNOWN_ID,this.collectionId,t,J.empty())}nn(e){for(const t of this.Xt)if(this.rn(t,e))return!0;return!1}rn(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;const n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}sn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function mi(e){var t,n;if(v(e instanceof Jt||e instanceof Yt),e instanceof Jt){if(e instanceof dn){const r=(null===(n=null===(t=e.value.arrayValue)||void 0===t?void 0:t.values)||void 0===n?void 0:n.map((t=>Jt.create(e.field,"==",t))))||[];return Yt.create(r,"or")}return e}const r=e.filters.map((e=>mi(e)));return Yt.create(r,e.op)}function gi(e){if(0===e.getFilters().length)return[];const t=vi(mi(e));return v(wi(t)),pi(t)||yi(t)?[t]:t.getFilters()}function pi(e){return e instanceof Jt}function yi(e){return e instanceof Yt&&en(e)}function wi(e){return pi(e)||yi(e)||function(e){if(e instanceof Yt&&Zt(e)){for(const t of e.getFilters())if(!pi(t)&&!yi(t))return!1;return!0}return!1}(e)}function vi(e){if(v(e instanceof Jt||e instanceof Yt),e instanceof Jt)return e;if(1===e.filters.length)return vi(e.filters[0]);const t=e.filters.map((e=>vi(e)));let n=Yt.create(t,e.op);return n=bi(n),wi(n)?n:(v(n instanceof Yt),v(Xt(n)),v(n.filters.length>1),n.filters.reduce(((e,t)=>Ii(e,t))))}function Ii(e,t){let n;return v(e instanceof Jt||e instanceof Yt),v(t instanceof Jt||t instanceof Yt),n=e instanceof Jt?t instanceof Jt?function(e,t){return Yt.create([e,t],"and")}(e,t):_i(e,t):t instanceof Jt?_i(t,e):function(e,t){if(v(e.filters.length>0&&t.filters.length>0),Xt(e)&&Xt(t))return sn(e,t.getFilters());const n=Zt(e)?e:t,r=Zt(e)?t:e,s=n.filters.map((e=>Ii(e,r)));return Yt.create(s,"or")}(e,t),bi(n)}function _i(e,t){if(Xt(t))return sn(t,e.getFilters());{const n=t.filters.map((t=>Ii(e,t)));return Yt.create(n,"or")}}function bi(e){if(v(e instanceof Jt||e instanceof Yt),e instanceof Jt)return e;const t=e.getFilters();if(1===t.length)return bi(t[0]);if(tn(e))return e;const n=t.map((e=>bi(e))),r=[];return n.forEach((t=>{t instanceof Jt?r.push(t):t instanceof Yt&&(t.op===e.op?r.push(...t.filters):r.push(t))})),1===r.length?r[0]:Yt.create(r,e.op)}class Ti{constructor(){this._n=new Ei}addToCollectionParentIndex(e,t){return this._n.add(t),se.resolve()}getCollectionParents(e,t){return se.resolve(this._n.getEntries(t))}addFieldIndex(e,t){return se.resolve()}deleteFieldIndex(e,t){return se.resolve()}deleteAllFieldIndexes(e){return se.resolve()}createTargetIndexes(e,t){return se.resolve()}getDocumentsMatchingTarget(e,t){return se.resolve(null)}getIndexType(e,t){return se.resolve(0)}getFieldIndexes(e,t){return se.resolve([])}getNextCollectionGroupToUpdate(e){return se.resolve(null)}getMinOffset(e,t){return se.resolve(Z.min())}getMinOffsetFromCollectionGroup(e,t){return se.resolve(Z.min())}updateCollectionGroup(e,t,n){return se.resolve()}updateIndexEntries(e,t){return se.resolve()}}class Ei{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new st(U.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new st(U.comparator)).toArray()}}const Si=new Uint8Array(0);class xi{constructor(e,t){this.databaseId=t,this.an=new Ei,this.un=new Bn((e=>yn(e)),((e,t)=>wn(e,t))),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.an.has(t)){const n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener((()=>{this.an.add(t)}));const s={collectionId:n,parent:_e(r)};return Ci(e).put(s)}return se.resolve()}getCollectionParents(e,t){const n=[],r=IDBKeyRange.bound([t,""],[L(t),""],!1,!0);return Ci(e).U(r).next((e=>{for(const r of e){if(r.collectionId!==t)break;n.push(Ee(r.parent))}return n}))}addFieldIndex(e,t){const n=Ni(e),r=function(e){return{indexId:e.indexId,collectionGroup:e.collectionGroup,fields:e.fields.map((e=>[e.fieldPath.canonicalString(),e.kind]))}}(t);delete r.indexId;const s=n.add(r);if(t.indexState){const n=Ai(e);return s.next((e=>{n.put(Ys(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))}))}return s.next()}deleteFieldIndex(e,t){const n=Ni(e),r=Ai(e),s=Di(e);return n.delete(t.indexId).next((()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))).next((()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))))}deleteAllFieldIndexes(e){const t=Ni(e),n=Di(e),r=Ai(e);return t.j().next((()=>n.j())).next((()=>r.j()))}createTargetIndexes(e,t){return se.forEach(this.cn(t),(t=>this.getIndexType(e,t).next((n=>{if(0===n||1===n){const n=new fi(t).on();if(null!=n)return this.addFieldIndex(e,n)}}))))}getDocumentsMatchingTarget(e,t){const n=Di(e);let r=!0;const s=new Map;return se.forEach(this.cn(t),(t=>this.ln(e,t).next((e=>{r&&(r=!!e),s.set(t,e)})))).next((()=>{if(r){let e=Xn();const r=[];return se.forEach(s,((s,i)=>{m("IndexedDbIndexManager",`Using index ${function(e){return`id=${e.indexId}|cg=${e.collectionGroup}|f=${e.fields.map((e=>`${e.fieldPath}:${e.kind}`)).join(",")}`}(s)} to execute ${yn(t)}`);const o=function(e,t){const n=$(t);if(void 0===n)return null;for(const t of In(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(i,s),a=function(e,t){const n=new Map;for(const r of Q(t))for(const t of In(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(i,s),c=function(e,t){const n=[];let r=!0;for(const s of Q(t)){const t=0===s.kind?_n(e,s.fieldPath,e.startAt):bn(e,s.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new Kt(n,r)}(i,s),u=function(e,t){const n=[];let r=!0;for(const s of Q(t)){const t=0===s.kind?bn(e,s.fieldPath,e.endAt):_n(e,s.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new Kt(n,r)}(i,s),l=this.hn(s,i,c),h=this.hn(s,i,u),d=this.Pn(s,i,a),f=this.In(s.indexId,o,l,c.inclusive,h,u.inclusive,d);return se.forEach(f,(s=>n.G(s,t.limit).next((t=>{t.forEach((t=>{const n=G.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))}))}))))})).next((()=>r))}return se.resolve(null)}))}cn(e){let t=this.un.get(e);return t||(t=0===e.filters.length?[e]:gi(Yt.create(e.filters,"and")).map((t=>pn(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt))),this.un.set(e,t),t)}In(e,t,n,r,s,i,o){const a=(null!=t?t.length:1)*Math.max(n.length,s.length),c=a/(null!=t?t.length:1),u=[];for(let l=0;l<a;++l){const a=t?this.Tn(t[l/c]):Si,h=this.En(e,a,n[l%c],r),d=this.dn(e,a,s[l%c],i),f=o.map((t=>this.En(e,a,t,!0)));u.push(...this.createRange(h,d,f))}return u}En(e,t,n,r){const s=new li(e,G.empty(),t,n);return r?s:s.Jt()}dn(e,t,n,r){const s=new li(e,G.empty(),t,n);return r?s.Jt():s}ln(e,t){const n=new fi(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next((e=>{let t=null;for(const r of e)n.tn(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t}))}getIndexType(e,t){let n=2;const r=this.cn(t);return se.forEach(r,(t=>this.ln(e,t).next((e=>{e?0!==n&&e.fields.length<function(e){let t=new st(z.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})))).next((()=>function(e){return null!==e.limit}(t)&&r.length>1&&2===n?1:n))}An(e,t){const n=new ui;for(const r of Q(e)){const e=t.data.field(r.fieldPath);if(null==e)return null;const s=n.Ht(r.kind);ri.bt.Pt(e,s)}return n.Wt()}Tn(e){const t=new ui;return ri.bt.Pt(e,t.Ht(0)),t.Wt()}Rn(e,t){const n=new ui;return ri.bt.Pt(Nt(this.databaseId,t),n.Ht(function(e){const t=Q(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.Wt()}Pn(e,t,n){if(null===n)return[];let r=[];r.push(new ui);let s=0;for(const i of Q(e)){const e=n[s++];for(const n of r)if(this.Vn(t,i.fieldPath)&&kt(e))r=this.mn(r,i,e);else{const t=n.Ht(i.kind);ri.bt.Pt(e,t)}}return this.fn(r)}hn(e,t,n){return this.Pn(e,t,n.position)}fn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Wt();return t}mn(e,t,n){const r=[...e],s=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new ui;r.seed(n.Wt()),ri.bt.Pt(e,r.Ht(t.kind)),s.push(r)}return s}Vn(e,t){return!!e.filters.find((e=>e instanceof Jt&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op)))}getFieldIndexes(e,t){const n=Ni(e),r=Ai(e);return(t?n.U("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.U()).next((e=>{const t=[];return se.forEach(e,(e=>r.get([e.indexId,this.uid]).next((n=>{t.push(function(e,t){const n=t?new J(t.sequenceNumber,new Z(Ks(t.readTime),new G(Ee(t.documentKey)),t.largestBatchId)):J.empty(),r=e.fields.map((([e,t])=>new W(z.fromServerFormat(e),t)));return new K(e.indexId,e.collectionGroup,r,n)}(e,n))})))).next((()=>t))}))}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next((e=>0===e.length?null:(e.sort(((e,t)=>{const n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:R(e.collectionGroup,t.collectionGroup)})),e[0].collectionGroup)))}updateCollectionGroup(e,t,n){const r=Ni(e),s=Ai(e);return this.gn(e).next((e=>r.U("collectionGroupIndex",IDBKeyRange.bound(t,t)).next((t=>se.forEach(t,(t=>s.put(Ys(t.indexId,this.uid,e,n))))))))}updateIndexEntries(e,t){const n=new Map;return se.forEach(t,((t,r)=>{const s=n.get(t.collectionGroup);return(s?se.resolve(s):this.getFieldIndexes(e,t.collectionGroup)).next((s=>(n.set(t.collectionGroup,s),se.forEach(s,(n=>this.pn(e,t,n).next((t=>{const s=this.yn(r,n);return t.isEqual(s)?se.resolve():this.wn(e,r,n,t,s)})))))))}))}Sn(e,t,n,r){return Di(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.Rn(n,t.key),documentKey:t.key.path.toArray()})}bn(e,t,n,r){return Di(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.Rn(n,t.key),t.key.path.toArray()])}pn(e,t,n){const r=Di(e);let s=new st(hi);return r.J({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.Rn(n,t)])},((e,r)=>{s=s.add(new li(n.indexId,t,r.arrayValue,r.directionalValue))})).next((()=>s))}yn(e,t){let n=new st(hi);const r=this.An(t,e);if(null==r)return n;const s=$(t);if(null!=s){const i=e.data.field(s.fieldPath);if(kt(i))for(const s of i.arrayValue.values||[])n=n.add(new li(t.indexId,e.key,this.Tn(s),r))}else n=n.add(new li(t.indexId,e.key,Si,r));return n}wn(e,t,n,r,s){m("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);const i=[];return function(e,t,n,r,s){const i=e.getIterator(),o=t.getIterator();let a=ot(i),c=ot(o);for(;a||c;){let e=!1,t=!1;if(a&&c){const r=n(a,c);r<0?t=!0:r>0&&(e=!0)}else null!=a?t=!0:e=!0;e?(r(c),c=ot(o)):t?(s(a),a=ot(i)):(a=ot(i),c=ot(o))}}(r,s,hi,(r=>{i.push(this.Sn(e,t,n,r))}),(r=>{i.push(this.bn(e,t,n,r))})),se.waitFor(i)}gn(e){let t=1;return Ai(e).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((e,n,r)=>{r.done(),t=n.sequenceNumber+1})).next((()=>t))}createRange(e,t,n){n=n.sort(((e,t)=>hi(e,t))).filter(((e,t,n)=>!t||0!==hi(e,n[t-1])));const r=[];r.push(e);for(const s of n){const n=hi(s,e),i=hi(s,t);if(0===n)r[0]=e.Jt();else if(n>0&&i<0)r.push(s),r.push(s.Jt());else if(i>0)break}r.push(t);const s=[];for(let e=0;e<r.length;e+=2){if(this.Dn(r[e],r[e+1]))return[];const t=[r[e].indexId,this.uid,r[e].arrayValue,r[e].directionalValue,Si,[]],n=[r[e+1].indexId,this.uid,r[e+1].arrayValue,r[e+1].directionalValue,Si,[]];s.push(IDBKeyRange.bound(t,n))}return s}Dn(e,t){return hi(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(ki)}getMinOffset(e,t){return se.mapArray(this.cn(t),(t=>this.ln(e,t).next((e=>e||w())))).next(ki)}}function Ci(e){return Je(e,"collectionParents")}function Di(e){return Je(e,"indexEntries")}function Ni(e){return Je(e,"indexConfiguration")}function Ai(e){return Je(e,"indexState")}function ki(e){v(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){const s=e[r].indexState.offset;ee(s,t)<0&&(t=s),n<s.largestBatchId&&(n=s.largestBatchId)}return new Z(t.readTime,t.documentKey,n)}const Mi={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Fi{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new Fi(e,Fi.DEFAULT_COLLECTION_PERCENTILE,Fi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Ri(e,t,n){const r=e.store("mutations"),s=e.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const c=r.J({range:o},((e,t,n)=>(a++,n.delete())));i.push(c.next((()=>{v(1===a)})));const u=[];for(const e of n.mutations){const r=Ce(t,e.key.path,n.batchId);i.push(s.delete(r)),u.push(e.key)}return se.waitFor(i).next((()=>u))}function Pi(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw w();t=e.noDocument}return JSON.stringify(t).length}Fi.DEFAULT_COLLECTION_PERCENTILE=10,Fi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Fi.DEFAULT=new Fi(41943040,Fi.DEFAULT_COLLECTION_PERCENTILE,Fi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Fi.DISABLED=new Fi(-1,0,0);class Li{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Cn={}}static lt(e,t,n,r){v(""!==e.uid);const s=e.isAuthenticated()?e.uid:"";return new Li(s,t,n,r)}checkEmpty(e){let t=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Oi(e).J({index:"userMutationsIndex",range:n},((e,n,r)=>{t=!1,r.done()})).next((()=>t))}addMutationBatch(e,t,n,r){const s=qi(e),i=Oi(e);return i.add({}).next((o=>{v("number"==typeof o);const a=new Fr(o,t,n,r),c=function(e,t,n){const r=n.baseMutations.map((t=>Es(e.ct,t))),s=n.mutations.map((t=>Es(e.ct,t)));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:s}}(this.serializer,this.userId,a),u=[];let l=new st(((e,t)=>R(e.canonicalString(),t.canonicalString())));for(const e of r){const t=Ce(this.userId,e.key.path,o);l=l.add(e.key.path.popLast()),u.push(i.put(c)),u.push(s.put(t,De))}return l.forEach((t=>{u.push(this.indexManager.addToCollectionParentIndex(e,t))})),e.addOnCommittedListener((()=>{this.Cn[o]=a.keys()})),se.waitFor(u).next((()=>a))}))}lookupMutationBatch(e,t){return Oi(e).get(t).next((e=>e?(v(e.userId===this.userId),$s(this.serializer,e)):null))}vn(e,t){return this.Cn[t]?se.resolve(this.Cn[t]):this.lookupMutationBatch(e,t).next((e=>{if(e){const n=e.keys();return this.Cn[t]=n,n}return null}))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return Oi(e).J({index:"userMutationsIndex",range:r},((e,t,r)=>{t.userId===this.userId&&(v(t.batchId>=n),s=$s(this.serializer,t)),r.done()})).next((()=>s))}getHighestUnacknowledgedBatchId(e){const t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return Oi(e).J({index:"userMutationsIndex",range:t,reverse:!0},((e,t,r)=>{n=t.batchId,r.done()})).next((()=>n))}getAllMutationBatches(e){const t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Oi(e).U("userMutationsIndex",t).next((e=>e.map((e=>$s(this.serializer,e)))))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=xe(this.userId,t.path),r=IDBKeyRange.lowerBound(n),s=[];return qi(e).J({range:r},((n,r,i)=>{const[o,a,c]=n,u=Ee(a);if(o===this.userId&&t.path.isEqual(u))return Oi(e).get(c).next((e=>{if(!e)throw w();v(e.userId===this.userId),s.push($s(this.serializer,e))}));i.done()})).next((()=>s))}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new st(R);const r=[];return t.forEach((t=>{const s=xe(this.userId,t.path),i=IDBKeyRange.lowerBound(s),o=qi(e).J({range:i},((e,r,s)=>{const[i,o,a]=e,c=Ee(o);i===this.userId&&t.path.isEqual(c)?n=n.add(a):s.done()}));r.push(o)})),se.waitFor(r).next((()=>this.Fn(e,n)))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1,s=xe(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new st(R);return qi(e).J({range:i},((e,t,s)=>{const[i,a,c]=e,u=Ee(a);i===this.userId&&n.isPrefixOf(u)?u.length===r&&(o=o.add(c)):s.done()})).next((()=>this.Fn(e,o)))}Fn(e,t){const n=[],r=[];return t.forEach((t=>{r.push(Oi(e).get(t).next((e=>{if(null===e)throw w();v(e.userId===this.userId),n.push($s(this.serializer,e))})))})),se.waitFor(r).next((()=>n))}removeMutationBatch(e,t){return Ri(e._e,this.userId,t).next((n=>(e.addOnCommittedListener((()=>{this.Mn(t.batchId)})),se.forEach(n,(t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))))}Mn(e){delete this.Cn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next((t=>{if(!t)return se.resolve();const n=IDBKeyRange.lowerBound(function(e){return[e]}(this.userId)),r=[];return qi(e).J({range:n},((e,t,n)=>{if(e[0]===this.userId){const t=Ee(e[1]);r.push(t)}else n.done()})).next((()=>{v(0===r.length)}))}))}containsKey(e,t){return Vi(e,this.userId,t)}xn(e){return Ui(e).get(this.userId).next((e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function Vi(e,t,n){const r=xe(t,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return qi(e).J({range:i,H:!0},((e,n,r)=>{const[i,a,c]=e;i===t&&a===s&&(o=!0),r.done()})).next((()=>o))}function Oi(e){return Je(e,"mutations")}function qi(e){return Je(e,"documentMutations")}function Ui(e){return Je(e,"mutationQueues")}class Bi{constructor(e){this.On=e}next(){return this.On+=2,this.On}static Nn(){return new Bi(0)}static Ln(){return new Bi(-1)}}class zi{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.Bn(e).next((t=>{const n=new Bi(t.highestTargetId);return t.highestTargetId=n.next(),this.kn(e,t).next((()=>t.highestTargetId))}))}getLastRemoteSnapshotVersion(e){return this.Bn(e).next((e=>O.fromTimestamp(new V(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(e){return this.Bn(e).next((e=>e.highestListenSequenceNumber))}setTargetsMetadata(e,t,n){return this.Bn(e).next((r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.kn(e,r))))}addTargetData(e,t){return this.qn(e,t).next((()=>this.Bn(e).next((n=>(n.targetCount+=1,this.Qn(t,n),this.kn(e,n))))))}updateTargetData(e,t){return this.qn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next((()=>Gi(e).delete(t.targetId))).next((()=>this.Bn(e))).next((t=>(v(t.targetCount>0),t.targetCount-=1,this.kn(e,t))))}removeTargets(e,t,n){let r=0;const s=[];return Gi(e).J(((i,o)=>{const a=Qs(o);a.sequenceNumber<=t&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(e,a)))})).next((()=>se.waitFor(s))).next((()=>r))}forEachTarget(e,t){return Gi(e).J(((e,n)=>{const r=Qs(n);t(r)}))}Bn(e){return Ki(e).get("targetGlobalKey").next((e=>(v(null!==e),e)))}kn(e,t){return Ki(e).put("targetGlobalKey",t)}qn(e,t){return Gi(e).put(js(this.serializer,t))}Qn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Bn(e).next((e=>e.targetCount))}getTargetData(e,t){const n=yn(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return Gi(e).J({range:r,index:"queryTargetsIndex"},((e,n,r)=>{const i=Qs(n);wn(t,i.target)&&(s=i,r.done())})).next((()=>s))}addMatchingKeys(e,t,n){const r=[],s=$i(e);return t.forEach((t=>{const i=_e(t.path);r.push(s.put({targetId:n,path:i})),r.push(this.referenceDelegate.addReference(e,n,t))})),se.waitFor(r)}removeMatchingKeys(e,t,n){const r=$i(e);return se.forEach(t,(t=>{const s=_e(t.path);return se.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(e,n,t)])}))}removeMatchingKeysForTargetId(e,t){const n=$i(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=$i(e);let s=Xn();return r.J({range:n,H:!0},((e,t,n)=>{const r=Ee(e[1]),i=new G(r);s=s.add(i)})).next((()=>s))}containsKey(e,t){const n=_e(t.path),r=IDBKeyRange.bound([n],[L(n)],!1,!0);let s=0;return $i(e).J({index:"documentTargetsIndex",H:!0,range:r},(([e,t],n,r)=>{0!==e&&(s++,r.done())})).next((()=>s>0))}ot(e,t){return Gi(e).get(t).next((e=>e?Qs(e):null))}}function Gi(e){return Je(e,"targets")}function Ki(e){return Je(e,"targetGlobal")}function $i(e){return Je(e,"targetDocuments")}function Qi([e,t],[n,r]){const s=R(e,n);return 0===s?R(t,r):s}class ji{constructor(e){this.Kn=e,this.buffer=new st(Qi),this.$n=0}Un(){return++this.$n}Wn(e){const t=[e,this.Un()];if(this.buffer.size<this.Kn)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();Qi(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Wi{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Gn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.zn(6e4)}stop(){this.Gn&&(this.Gn.cancel(),this.Gn=null)}get started(){return null!==this.Gn}zn(e){m("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Gn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(async()=>{this.Gn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){le(e)?m("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await re(e)}await this.zn(3e5)}))}}class Hi{constructor(e,t){this.jn=e,this.params=t}calculateTargetCount(e,t){return this.jn.Hn(e).next((e=>Math.floor(t/100*e)))}nthSequenceNumber(e,t){if(0===t)return se.resolve(ye.oe);const n=new ji(t);return this.jn.forEachTarget(e,(e=>n.Wn(e.sequenceNumber))).next((()=>this.jn.Jn(e,(e=>n.Wn(e))))).next((()=>n.maxValue))}removeTargets(e,t,n){return this.jn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.jn.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(m("LruGarbageCollector","Garbage collection skipped; disabled"),se.resolve(Mi)):this.getCacheSize(e).next((n=>n<this.params.cacheSizeCollectionThreshold?(m("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Mi):this.Yn(e,t)))}getCacheSize(e){return this.jn.getCacheSize(e)}Yn(e,t){let n,r,s,o,a,c,u;const l=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next((t=>(t>this.params.maximumSequenceNumbersToCollect?(m("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,o=Date.now(),this.nthSequenceNumber(e,r)))).next((r=>(n=r,a=Date.now(),this.removeTargets(e,n,t)))).next((t=>(s=t,c=Date.now(),this.removeOrphanedDocuments(e,n)))).next((e=>(u=Date.now(),f()<=i.LogLevel.DEBUG&&m("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-l}ms\n\tDetermined least recently used ${r} in `+(a-o)+"ms\n"+`\tRemoved ${s} targets in `+(c-a)+"ms\n"+`\tRemoved ${e} documents in `+(u-c)+"ms\n"+`Total Duration: ${u-l}ms`),se.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:e}))))}}function Ji(e,t){return new Hi(e,t)}class Yi{constructor(e,t){this.db=e,this.garbageCollector=Ji(this,t)}Hn(e){const t=this.Zn(e);return this.db.getTargetCache().getTargetCount(e).next((e=>t.next((t=>e+t))))}Zn(e){let t=0;return this.Jn(e,(e=>{t++})).next((()=>t))}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Jn(e,t){return this.Xn(e,((e,n)=>t(n)))}addReference(e,t,n){return Xi(e,n)}removeReference(e,t,n){return Xi(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return Xi(e,t)}er(e,t){return function(e,t){let n=!1;return Ui(e).Y((r=>Vi(e,r,t).next((e=>(e&&(n=!0),se.resolve(!e)))))).next((()=>n))}(e,t)}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this.Xn(e,((i,o)=>{if(o<=t){const t=this.er(e,i).next((t=>{if(!t)return s++,n.getEntry(e,i).next((()=>(n.removeEntry(i,O.min()),$i(e).delete(function(e){return[0,_e(e.path)]}(i)))))}));r.push(t)}})).next((()=>se.waitFor(r))).next((()=>n.apply(e))).next((()=>s))}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return Xi(e,t)}Xn(e,t){const n=$i(e);let r,s=ye.oe;return n.J({index:"documentTargetsIndex"},(([e,n],{path:i,sequenceNumber:o})=>{0===e?(s!==ye.oe&&t(new G(Ee(r)),s),s=o,r=i):s=ye.oe})).next((()=>{s!==ye.oe&&t(new G(Ee(r)),s)}))}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function Xi(e,t){return $i(e).put(function(e,t){return{targetId:0,path:_e(e.path),sequenceNumber:t}}(t,e.currentSequenceNumber))}class Zi{constructor(){this.changes=new Bn((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Gt.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?se.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class eo{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return so(e).put(n)}removeEntry(e,t,n){return so(e).delete(function(e,t){const n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],zs(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next((n=>(n.byteSize+=t,this.tr(e,n))))}getEntry(e,t){let n=Gt.newInvalidDocument(t);return so(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(io(t))},((e,r)=>{n=this.nr(t,r)})).next((()=>n))}rr(e,t){let n={size:0,document:Gt.newInvalidDocument(t)};return so(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(io(t))},((e,r)=>{n={document:this.nr(t,r),size:Pi(r)}})).next((()=>n))}getEntries(e,t){let n=Gn();return this.ir(e,t,((e,t)=>{const r=this.nr(e,t);n=n.insert(e,r)})).next((()=>n))}sr(e,t){let n=Gn(),r=new tt(G.comparator);return this.ir(e,t,((e,t)=>{const s=this.nr(e,t);n=n.insert(e,s),r=r.insert(e,Pi(t))})).next((()=>({documents:n,_r:r})))}ir(e,t,n){if(t.isEmpty())return se.resolve();let r=new st(ao);t.forEach((e=>r=r.add(e)));const s=IDBKeyRange.bound(io(r.first()),io(r.last())),i=r.getIterator();let o=i.getNext();return so(e).J({index:"documentKeyIndex",range:s},((e,t,r)=>{const s=G.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;o&&ao(o,s)<0;)n(o,null),o=i.getNext();o&&o.isEqual(s)&&(n(o,t),o=i.hasNext()?i.getNext():null),o?r.$(io(o)):r.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getDocumentsMatchingQuery(e,t,n,r,s){const i=t.path,o=[i.popLast().toArray(),i.lastSegment(),zs(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],a=[i.popLast().toArray(),i.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return so(e).U(IDBKeyRange.bound(o,a,!0)).next((e=>{null==s||s.incrementDocumentReadCount(e.length);let n=Gn();for(const s of e){const e=this.nr(G.fromSegments(s.prefixPath.concat(s.collectionGroup,s.documentId)),s);e.isFoundDocument()&&(Vn(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n}))}getAllFromCollectionGroup(e,t,n,r){let s=Gn();const i=oo(t,n),o=oo(t,Z.max());return so(e).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(i,o,!0)},((e,t,n)=>{const i=this.nr(G.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);s=s.insert(i.key,i),s.size===r&&n.done()})).next((()=>s))}newChangeBuffer(e){return new no(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next((e=>e.byteSize))}getMetadata(e){return ro(e).get("remoteDocumentGlobalKey").next((e=>(v(!!e),e)))}tr(e,t){return ro(e).put("remoteDocumentGlobalKey",t)}nr(e,t){if(t){const e=function(e,t){let n;if(t.document)n=Ts(e.ct,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=G.fromSegments(t.noDocument.path),r=Ks(t.noDocument.readTime);n=Gt.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return w();{const e=G.fromSegments(t.unknownDocument.path),r=Ks(t.unknownDocument.version);n=Gt.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function(e){const t=new V(e[0],e[1]);return O.fromTimestamp(t)}(t.readTime)),n}(this.serializer,t);if(!e.isNoDocument()||!e.version.isEqual(O.min()))return e}return Gt.newInvalidDocument(e)}}function to(e){return new eo(e)}class no extends Zi{constructor(e,t){super(),this.ar=e,this.trackRemovals=t,this.ur=new Bn((e=>e.toString()),((e,t)=>e.isEqual(t)))}applyChanges(e){const t=[];let n=0,r=new st(((e,t)=>R(e.canonicalString(),t.canonicalString())));return this.changes.forEach(((s,i)=>{const o=this.ur.get(s);if(t.push(this.ar.removeEntry(e,s,o.readTime)),i.isValidDocument()){const a=Bs(this.ar.serializer,i);r=r.add(s.path.popLast());const c=Pi(a);n+=c-o.size,t.push(this.ar.addEntry(e,s,a))}else if(n-=o.size,this.trackRemovals){const n=Bs(this.ar.serializer,i.convertToNoDocument(O.min()));t.push(this.ar.addEntry(e,s,n))}})),r.forEach((n=>{t.push(this.ar.indexManager.addToCollectionParentIndex(e,n))})),t.push(this.ar.updateMetadata(e,n)),se.waitFor(t)}getFromCache(e,t){return this.ar.rr(e,t).next((e=>(this.ur.set(t,{size:e.size,readTime:e.document.readTime}),e.document)))}getAllFromCache(e,t){return this.ar.sr(e,t).next((({documents:e,_r:t})=>(t.forEach(((t,n)=>{this.ur.set(t,{size:n,readTime:e.get(t).readTime})})),e)))}}function ro(e){return Je(e,"remoteDocumentGlobal")}function so(e){return Je(e,"remoteDocumentsV14")}function io(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function oo(e,t){const n=t.documentKey.path.toArray();return[e,zs(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function ao(e,t){const n=e.path.toArray(),r=t.path.toArray();let s=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(s=R(n[e],r[e]),s)return s;return s=R(n.length,r.length),s||(s=R(n[n.length-2],r[r.length-2]),s||R(n[n.length-1],r[r.length-1]))}class co{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class uo{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next((r=>(n=r,this.remoteDocumentCache.getEntry(e,t)))).next((e=>(null!==n&&Tr(n.mutation,e,at.empty(),V.now()),e)))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.getLocalViewOfDocuments(e,t,Xn()).next((()=>t))))}getLocalViewOfDocuments(e,t,n=Xn()){const r=jn();return this.populateOverlays(e,r,t).next((()=>this.computeViews(e,t,r,n).next((e=>{let t=$n();return e.forEach(((e,n)=>{t=t.insert(e,n.overlayedDocument)})),t}))))}getOverlayedDocuments(e,t){const n=jn();return this.populateOverlays(e,n,t).next((()=>this.computeViews(e,t,n,Xn())))}populateOverlays(e,t,n){const r=[];return n.forEach((e=>{t.has(e)||r.push(e)})),this.documentOverlayCache.getOverlays(e,r).next((e=>{e.forEach(((e,n)=>{t.set(e,n)}))}))}computeViews(e,t,n,r){let s=Gn();const i=Hn(),o=Hn();return t.forEach(((e,t)=>{const o=n.get(t.key);r.has(t.key)&&(void 0===o||o.mutation instanceof Cr)?s=s.insert(t.key,t):void 0!==o?(i.set(t.key,o.mutation.getFieldMask()),Tr(o.mutation,t,o.mutation.getFieldMask(),V.now())):i.set(t.key,at.empty())})),this.recalculateAndSaveOverlays(e,s).next((e=>(e.forEach(((e,t)=>i.set(e,t))),t.forEach(((e,t)=>{var n;return o.set(e,new co(t,null!==(n=i.get(e))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(e,t){const n=Hn();let r=new tt(((e,t)=>e-t)),s=Xn();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next((e=>{for(const s of e)s.keys().forEach((e=>{const i=t.get(e);if(null===i)return;let o=n.get(e)||at.empty();o=s.applyToLocalView(i,o),n.set(e,o);const a=(r.get(s.batchId)||Xn()).add(e);r=r.insert(s.batchId,a)}))})).next((()=>{const i=[],o=r.getReverseIterator();for(;o.hasNext();){const r=o.getNext(),a=r.key,c=r.value,u=Wn();c.forEach((e=>{if(!s.has(e)){const r=_r(t.get(e),n.get(e));null!==r&&u.set(e,r),s=s.add(e)}})),i.push(this.documentOverlayCache.saveOverlays(e,a,u))}return se.waitFor(i)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.recalculateAndSaveOverlays(e,t)))}getDocumentsMatchingQuery(e,t,n,r){return function(e){return G.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):Cn(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next((s=>{const i=r-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-s.size):se.resolve(jn());let o=-1,a=s;return i.next((t=>se.forEach(t,((t,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),s.get(t)?se.resolve():this.remoteDocumentCache.getEntry(e,t).next((e=>{a=a.insert(t,e)}))))).next((()=>this.populateOverlays(e,t,s))).next((()=>this.computeViews(e,a,t,Xn()))).next((e=>({batchId:o,changes:Qn(e)})))))}))}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new G(t)).next((e=>{let t=$n();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}getDocumentsMatchingCollectionGroupQuery(e,t,n,r){const s=t.collectionGroup;let i=$n();return this.indexManager.getCollectionParents(e,s).next((o=>se.forEach(o,(o=>{const a=function(e,t){return new Tn(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,o.child(s));return this.getDocumentsMatchingCollectionQuery(e,a,n,r).next((e=>{e.forEach(((e,t)=>{i=i.insert(e,t)}))}))})).next((()=>i))))}getDocumentsMatchingCollectionQuery(e,t,n,r){let s;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next((i=>(s=i,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,s,r)))).next((e=>{s.forEach(((t,n)=>{const r=n.getKey();null===e.get(r)&&(e=e.insert(r,Gt.newInvalidDocument(r)))}));let n=$n();return e.forEach(((e,r)=>{const i=s.get(e);void 0!==i&&Tr(i.mutation,r,at.empty(),V.now()),Vn(t,r)&&(n=n.insert(e,r))})),n}))}}class lo{constructor(e){this.serializer=e,this.cr=new Map,this.lr=new Map}getBundleMetadata(e,t){return se.resolve(this.cr.get(t))}saveBundleMetadata(e,t){return this.cr.set(t.id,function(e){return{id:e.id,version:e.version,createTime:ds(e.createTime)}}(t)),se.resolve()}getNamedQuery(e,t){return se.resolve(this.lr.get(t))}saveNamedQuery(e,t){return this.lr.set(t.name,function(e){return{name:e.name,query:Ws(e.bundledQuery),readTime:ds(e.readTime)}}(t)),se.resolve()}}class ho{constructor(){this.overlays=new tt(G.comparator),this.hr=new Map}getOverlay(e,t){return se.resolve(this.overlays.get(t))}getOverlays(e,t){const n=jn();return se.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){return n.forEach(((n,r)=>{this.ht(e,t,r)})),se.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.hr.get(n);return void 0!==r&&(r.forEach((e=>this.overlays=this.overlays.remove(e))),this.hr.delete(n)),se.resolve()}getOverlaysForCollection(e,t,n){const r=jn(),s=t.length+1,i=new G(t.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const e=o.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return se.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let s=new tt(((e,t)=>e-t));const i=this.overlays.getIterator();for(;i.hasNext();){const e=i.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=s.get(e.largestBatchId);null===t&&(t=jn(),s=s.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const o=jn(),a=s.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((e,t)=>o.set(e,t))),!(o.size()>=r)););return se.resolve(o)}ht(e,t,n){const r=this.overlays.get(n.key);if(null!==r){const e=this.hr.get(r.largestBatchId).delete(n.key);this.hr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new Pr(t,n));let s=this.hr.get(t);void 0===s&&(s=Xn(),this.hr.set(t,s)),this.hr.set(t,s.add(n.key))}}class fo{constructor(){this.Pr=new st(mo.Ir),this.Tr=new st(mo.Er)}isEmpty(){return this.Pr.isEmpty()}addReference(e,t){const n=new mo(e,t);this.Pr=this.Pr.add(n),this.Tr=this.Tr.add(n)}dr(e,t){e.forEach((e=>this.addReference(e,t)))}removeReference(e,t){this.Ar(new mo(e,t))}Rr(e,t){e.forEach((e=>this.removeReference(e,t)))}Vr(e){const t=new G(new U([])),n=new mo(t,e),r=new mo(t,e+1),s=[];return this.Tr.forEachInRange([n,r],(e=>{this.Ar(e),s.push(e.key)})),s}mr(){this.Pr.forEach((e=>this.Ar(e)))}Ar(e){this.Pr=this.Pr.delete(e),this.Tr=this.Tr.delete(e)}gr(e){const t=new G(new U([])),n=new mo(t,e),r=new mo(t,e+1);let s=Xn();return this.Tr.forEachInRange([n,r],(e=>{s=s.add(e.key)})),s}containsKey(e){const t=new mo(e,0),n=this.Pr.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class mo{constructor(e,t){this.key=e,this.pr=t}static Ir(e,t){return G.comparator(e.key,t.key)||R(e.pr,t.pr)}static Er(e,t){return R(e.pr,t.pr)||G.comparator(e.key,t.key)}}class go{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.yr=1,this.wr=new st(mo.Ir)}checkEmpty(e){return se.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){const s=this.yr;this.yr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new Fr(s,t,n,r);this.mutationQueue.push(i);for(const t of r)this.wr=this.wr.add(new mo(t.key,s)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return se.resolve(i)}lookupMutationBatch(e,t){return se.resolve(this.Sr(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=this.br(n),s=r<0?0:r;return se.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return se.resolve(0===this.mutationQueue.length?-1:this.yr-1)}getAllMutationBatches(e){return se.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new mo(t,0),r=new mo(t,Number.POSITIVE_INFINITY),s=[];return this.wr.forEachInRange([n,r],(e=>{const t=this.Sr(e.pr);s.push(t)})),se.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new st(R);return t.forEach((e=>{const t=new mo(e,0),r=new mo(e,Number.POSITIVE_INFINITY);this.wr.forEachInRange([t,r],(e=>{n=n.add(e.pr)}))})),se.resolve(this.Dr(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;G.isDocumentKey(s)||(s=s.child(""));const i=new mo(new G(s),0);let o=new st(R);return this.wr.forEachWhile((e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(o=o.add(e.pr)),!0)}),i),se.resolve(this.Dr(o))}Dr(e){const t=[];return e.forEach((e=>{const n=this.Sr(e);null!==n&&t.push(n)})),t}removeMutationBatch(e,t){v(0===this.Cr(t.batchId,"removed")),this.mutationQueue.shift();let n=this.wr;return se.forEach(t.mutations,(r=>{const s=new mo(r.key,t.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)})).next((()=>{this.wr=n}))}Mn(e){}containsKey(e,t){const n=new mo(t,0),r=this.wr.firstAfterOrEqual(n);return se.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,se.resolve()}Cr(e,t){return this.br(e)}br(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Sr(e){const t=this.br(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class po{constructor(e){this.vr=e,this.docs=new tt(G.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.vr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return se.resolve(n?n.document.mutableCopy():Gt.newInvalidDocument(t))}getEntries(e,t){let n=Gn();return t.forEach((e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():Gt.newInvalidDocument(e))})),se.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let s=Gn();const i=t.path,o=new G(i.child("")),a=this.docs.getIteratorFrom(o);for(;a.hasNext();){const{key:e,value:{document:o}}=a.getNext();if(!i.isPrefixOf(e.path))break;e.path.length>i.length+1||ee(X(o),n)<=0||(r.has(o.key)||Vn(t,o))&&(s=s.insert(o.key,o.mutableCopy()))}return se.resolve(s)}getAllFromCollectionGroup(e,t,n,r){w()}Fr(e,t){return se.forEach(this.docs,(e=>t(e)))}newChangeBuffer(e){return new yo(this)}getSize(e){return se.resolve(this.size)}}class yo extends Zi{constructor(e){super(),this.ar=e}applyChanges(e){const t=[];return this.changes.forEach(((n,r)=>{r.isValidDocument()?t.push(this.ar.addEntry(e,r)):this.ar.removeEntry(n)})),se.waitFor(t)}getFromCache(e,t){return this.ar.getEntry(e,t)}getAllFromCache(e,t){return this.ar.getEntries(e,t)}}class wo{constructor(e){this.persistence=e,this.Mr=new Bn((e=>yn(e)),wn),this.lastRemoteSnapshotVersion=O.min(),this.highestTargetId=0,this.Or=0,this.Nr=new fo,this.targetCount=0,this.Lr=Bi.Nn()}forEachTarget(e,t){return this.Mr.forEach(((e,n)=>t(n))),se.resolve()}getLastRemoteSnapshotVersion(e){return se.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return se.resolve(this.Or)}allocateTargetId(e){return this.highestTargetId=this.Lr.next(),se.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Or&&(this.Or=t),se.resolve()}qn(e){this.Mr.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.Lr=new Bi(t),this.highestTargetId=t),e.sequenceNumber>this.Or&&(this.Or=e.sequenceNumber)}addTargetData(e,t){return this.qn(t),this.targetCount+=1,se.resolve()}updateTargetData(e,t){return this.qn(t),se.resolve()}removeTargetData(e,t){return this.Mr.delete(t.target),this.Nr.Vr(t.targetId),this.targetCount-=1,se.resolve()}removeTargets(e,t,n){let r=0;const s=[];return this.Mr.forEach(((i,o)=>{o.sequenceNumber<=t&&null===n.get(o.targetId)&&(this.Mr.delete(i),s.push(this.removeMatchingKeysForTargetId(e,o.targetId)),r++)})),se.waitFor(s).next((()=>r))}getTargetCount(e){return se.resolve(this.targetCount)}getTargetData(e,t){const n=this.Mr.get(t)||null;return se.resolve(n)}addMatchingKeys(e,t,n){return this.Nr.dr(t,n),se.resolve()}removeMatchingKeys(e,t,n){this.Nr.Rr(t,n);const r=this.persistence.referenceDelegate,s=[];return r&&t.forEach((t=>{s.push(r.markPotentiallyOrphaned(e,t))})),se.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Nr.Vr(t),se.resolve()}getMatchingKeysForTargetId(e,t){const n=this.Nr.gr(t);return se.resolve(n)}containsKey(e,t){return se.resolve(this.Nr.containsKey(t))}}class vo{constructor(e,t){this.Br={},this.overlays={},this.kr=new ye(0),this.qr=!1,this.qr=!0,this.referenceDelegate=e(this),this.Qr=new wo(this),this.indexManager=new Ti,this.remoteDocumentCache=function(e){return new po(e)}((e=>this.referenceDelegate.Kr(e))),this.serializer=new Us(t),this.$r=new lo(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.qr=!1,Promise.resolve()}get started(){return this.qr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new ho,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Br[e.toKey()];return n||(n=new go(t,this.referenceDelegate),this.Br[e.toKey()]=n),n}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.$r}runTransaction(e,t,n){m("MemoryPersistence","Starting transaction:",e);const r=new Io(this.kr.next());return this.referenceDelegate.Ur(),n(r).next((e=>this.referenceDelegate.Wr(r).next((()=>e)))).toPromise().then((e=>(r.raiseOnCommittedEvent(),e)))}Gr(e,t){return se.or(Object.values(this.Br).map((n=>()=>n.containsKey(e,t))))}}class Io extends ne{constructor(e){super(),this.currentSequenceNumber=e}}class _o{constructor(e){this.persistence=e,this.zr=new fo,this.jr=null}static Hr(e){return new _o(e)}get Jr(){if(this.jr)return this.jr;throw w()}addReference(e,t,n){return this.zr.addReference(n,t),this.Jr.delete(n.toString()),se.resolve()}removeReference(e,t,n){return this.zr.removeReference(n,t),this.Jr.add(n.toString()),se.resolve()}markPotentiallyOrphaned(e,t){return this.Jr.add(t.toString()),se.resolve()}removeTarget(e,t){this.zr.Vr(t.targetId).forEach((e=>this.Jr.add(e.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next((e=>{e.forEach((e=>this.Jr.add(e.toString())))})).next((()=>n.removeTargetData(e,t)))}Ur(){this.jr=new Set}Wr(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return se.forEach(this.Jr,(n=>{const r=G.fromPath(n);return this.Yr(e,r).next((e=>{e||t.removeEntry(r,O.min())}))})).next((()=>(this.jr=null,t.apply(e))))}updateLimboDocument(e,t){return this.Yr(e,t).next((e=>{e?this.Jr.delete(t.toString()):this.Jr.add(t.toString())}))}Kr(e){return 0}Yr(e,t){return se.or([()=>se.resolve(this.zr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Gr(e,t)])}}class bo{constructor(e,t){this.persistence=e,this.Zr=new Bn((e=>_e(e.path)),((e,t)=>e.isEqual(t))),this.garbageCollector=Ji(this,t)}static Hr(e,t){return new bo(e,t)}Ur(){}Wr(e){return se.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}Hn(e){const t=this.Zn(e);return this.persistence.getTargetCache().getTargetCount(e).next((e=>t.next((t=>e+t))))}Zn(e){let t=0;return this.Jn(e,(e=>{t++})).next((()=>t))}Jn(e,t){return se.forEach(this.Zr,((n,r)=>this.er(e,n,r).next((e=>e?se.resolve():t(r)))))}removeTargets(e,t,n){return this.persistence.getTargetCache().removeTargets(e,t,n)}removeOrphanedDocuments(e,t){let n=0;const r=this.persistence.getRemoteDocumentCache(),s=r.newChangeBuffer();return r.Fr(e,(r=>this.er(e,r,t).next((e=>{e||(n++,s.removeEntry(r,O.min()))})))).next((()=>s.apply(e))).next((()=>n))}markPotentiallyOrphaned(e,t){return this.Zr.set(t,e.currentSequenceNumber),se.resolve()}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,n)}addReference(e,t,n){return this.Zr.set(n,e.currentSequenceNumber),se.resolve()}removeReference(e,t,n){return this.Zr.set(n,e.currentSequenceNumber),se.resolve()}updateLimboDocument(e,t){return this.Zr.set(t,e.currentSequenceNumber),se.resolve()}Kr(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=Dt(e.data.value)),t}er(e,t,n){return se.or([()=>this.persistence.Gr(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{const e=this.Zr.get(t);return se.resolve(void 0!==e&&e>n)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class To{constructor(e){this.serializer=e}O(e,t,n,r){const s=new ie("createOrUpgrade",t);n<1&&r>=1&&(function(e){e.createObjectStore("owner")}(e),function(e){e.createObjectStore("mutationQueues",{keyPath:"userId"}),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Se,{unique:!0}),e.createObjectStore("documentMutations")}(e),Eo(e),function(e){e.createObjectStore("remoteDocuments")}(e));let i=se.resolve();return n<3&&r>=3&&(0!==n&&(function(e){e.deleteObjectStore("targetDocuments"),e.deleteObjectStore("targets"),e.deleteObjectStore("targetGlobal")}(e),Eo(e)),i=i.next((()=>function(e){const t=e.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:O.min().toTimestamp(),targetCount:0};return t.put("targetGlobalKey",n)}(s)))),n<4&&r>=4&&(0!==n&&(i=i.next((()=>function(e,t){return t.store("mutations").U().next((n=>{e.deleteObjectStore("mutations"),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Se,{unique:!0});const r=t.store("mutations"),s=n.map((e=>r.put(e)));return se.waitFor(s)}))}(e,s)))),i=i.next((()=>{!function(e){e.createObjectStore("clientMetadata",{keyPath:"clientId"})}(e)}))),n<5&&r>=5&&(i=i.next((()=>this.Xr(s)))),n<6&&r>=6&&(i=i.next((()=>(function(e){e.createObjectStore("remoteDocumentGlobal")}(e),this.ei(s))))),n<7&&r>=7&&(i=i.next((()=>this.ti(s)))),n<8&&r>=8&&(i=i.next((()=>this.ni(e,s)))),n<9&&r>=9&&(i=i.next((()=>{!function(e){e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")}(e)}))),n<10&&r>=10&&(i=i.next((()=>this.ri(s)))),n<11&&r>=11&&(i=i.next((()=>{!function(e){e.createObjectStore("bundles",{keyPath:"bundleId"})}(e),function(e){e.createObjectStore("namedQueries",{keyPath:"name"})}(e)}))),n<12&&r>=12&&(i=i.next((()=>{!function(e){const t=e.createObjectStore("documentOverlays",{keyPath:Ue});t.createIndex("collectionPathOverlayIndex",Be,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",ze,{unique:!1})}(e)}))),n<13&&r>=13&&(i=i.next((()=>function(e){const t=e.createObjectStore("remoteDocumentsV14",{keyPath:Ne});t.createIndex("documentKeyIndex",Ae),t.createIndex("collectionGroupIndex",ke)}(e))).next((()=>this.ii(e,s))).next((()=>e.deleteObjectStore("remoteDocuments")))),n<14&&r>=14&&(i=i.next((()=>this.si(e,s)))),n<15&&r>=15&&(i=i.next((()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:Le}).createIndex("sequenceNumberIndex",Ve,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Oe}).createIndex("documentKeyIndex",qe,{unique:!1})}(e)))),n<16&&r>=16&&(i=i.next((()=>{t.objectStore("indexState").clear()})).next((()=>{t.objectStore("indexEntries").clear()}))),i}ei(e){let t=0;return e.store("remoteDocuments").J(((e,n)=>{t+=Pi(n)})).next((()=>{const n={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}Xr(e){const t=e.store("mutationQueues"),n=e.store("mutations");return t.U().next((t=>se.forEach(t,(t=>{const r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.U("userMutationsIndex",r).next((n=>se.forEach(n,(n=>{v(n.userId===t.userId);const r=$s(this.serializer,n);return Ri(e,t.userId,r).next((()=>{}))}))))}))))}ti(e){const t=e.store("targetDocuments"),n=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next((e=>{const r=[];return n.J(((n,s)=>{const i=new U(n),o=function(e){return[0,_e(e)]}(i);r.push(t.get(o).next((n=>n?se.resolve():(n=>t.put({targetId:0,path:_e(n),sequenceNumber:e.highestListenSequenceNumber}))(i))))})).next((()=>se.waitFor(r)))}))}ni(e,t){e.createObjectStore("collectionParents",{keyPath:Pe});const n=t.store("collectionParents"),r=new Ei,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:_e(r)})}};return t.store("remoteDocuments").J({H:!0},((e,t)=>{const n=new U(e);return s(n.popLast())})).next((()=>t.store("documentMutations").J({H:!0},(([e,t,n],r)=>{const i=Ee(t);return s(i.popLast())}))))}ri(e){const t=e.store("targets");return t.J(((e,n)=>{const r=Qs(n),s=js(this.serializer,r);return t.put(s)}))}ii(e,t){const n=t.store("remoteDocuments"),r=[];return n.J(((e,n)=>{const s=t.store("remoteDocumentsV14"),i=function(e){return e.document?new G(U.fromString(e.document.name).popFirst(5)):e.noDocument?G.fromSegments(e.noDocument.path):e.unknownDocument?G.fromSegments(e.unknownDocument.path):w()}(n).path.toArray(),o={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(s.put(o))})).next((()=>se.waitFor(r)))}si(e,t){const n=t.store("mutations"),r=to(this.serializer),s=new vo(_o.Hr,this.serializer.ct);return n.U().next((e=>{const n=new Map;return e.forEach((e=>{var t;let r=null!==(t=n.get(e.userId))&&void 0!==t?t:Xn();$s(this.serializer,e).keys().forEach((e=>r=r.add(e))),n.set(e.userId,r)})),se.forEach(n,((e,n)=>{const i=new l(n),o=ti.lt(this.serializer,i),a=s.getIndexManager(i),c=Li.lt(i,this.serializer,a,s.referenceDelegate);return new uo(r,c,o,a).recalculateAndSaveOverlaysForDocumentKeys(new He(t,ye.oe),e).next()}))}))}}function Eo(e){e.createObjectStore("targetDocuments",{keyPath:Fe}).createIndex("documentTargetsIndex",Re,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",Me,{unique:!0}),e.createObjectStore("targetGlobal")}const So="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class xo{constructor(e,t,n,r,s,i,o,a,c,u,l=16){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.oi=s,this.window=i,this.document=o,this._i=c,this.ai=u,this.ui=l,this.kr=null,this.qr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ci=null,this.inForeground=!1,this.li=null,this.hi=null,this.Pi=Number.NEGATIVE_INFINITY,this.Ii=e=>Promise.resolve(),!xo.D())throw new b(_.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Yi(this,r),this.Ti=t+"main",this.serializer=new Us(a),this.Ei=new oe(this.Ti,this.ui,new To(this.serializer)),this.Qr=new zi(this.referenceDelegate,this.serializer),this.remoteDocumentCache=to(this.serializer),this.$r=new Xs,this.window&&this.window.localStorage?this.di=this.window.localStorage:(this.di=null,!1===u&&g("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Ai().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new b(_.FAILED_PRECONDITION,So);return this.Ri(),this.Vi(),this.mi(),this.runTransaction("getHighestListenSequenceNumber","readonly",(e=>this.Qr.getHighestSequenceNumber(e)))})).then((e=>{this.kr=new ye(e,this._i)})).then((()=>{this.qr=!0})).catch((e=>(this.Ei&&this.Ei.close(),Promise.reject(e))))}fi(e){return this.Ii=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ei.L((async t=>{null===t.newVersion&&await e()}))}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.oi.enqueueAndForget((async()=>{this.started&&await this.Ai()})))}Ai(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(e=>Do(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.gi(e).next((e=>{e||(this.isPrimary=!1,this.oi.enqueueRetryable((()=>this.Ii(!1))))}))})).next((()=>this.pi(e))).next((t=>this.isPrimary&&!t?this.yi(e).next((()=>!1)):!!t&&this.wi(e).next((()=>!0)))))).catch((e=>{if(le(e))return m("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return m("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1})).then((e=>{this.isPrimary!==e&&this.oi.enqueueRetryable((()=>this.Ii(e))),this.isPrimary=e}))}gi(e){return Co(e).get("owner").next((e=>se.resolve(this.Si(e))))}bi(e){return Do(e).delete(this.clientId)}async Di(){if(this.isPrimary&&!this.Ci(this.Pi,18e5)){this.Pi=Date.now();const e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(e=>{const t=Je(e,"clientMetadata");return t.U().next((e=>{const n=this.vi(e,18e5),r=e.filter((e=>-1===n.indexOf(e)));return se.forEach(r,(e=>t.delete(e.clientId))).next((()=>r))}))})).catch((()=>[]));if(this.di)for(const t of e)this.di.removeItem(this.Fi(t.clientId))}}mi(){this.hi=this.oi.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.Ai().then((()=>this.Di())).then((()=>this.mi()))))}Si(e){return!!e&&e.ownerId===this.clientId}pi(e){return this.ai?se.resolve(!0):Co(e).get("owner").next((t=>{if(null!==t&&this.Ci(t.leaseTimestampMs,5e3)&&!this.Mi(t.ownerId)){if(this.Si(t)&&this.networkEnabled)return!0;if(!this.Si(t)){if(!t.allowTabSynchronization)throw new b(_.FAILED_PRECONDITION,So);return!1}}return!(!this.networkEnabled||!this.inForeground)||Do(e).U().next((e=>void 0===this.vi(e,5e3).find((e=>{if(this.clientId!==e.clientId){const t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))))})).next((e=>(this.isPrimary!==e&&m("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e)))}async shutdown(){this.qr=!1,this.xi(),this.hi&&(this.hi.cancel(),this.hi=null),this.Oi(),this.Ni(),await this.Ei.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(e=>{const t=new He(e,ye.oe);return this.yi(t).next((()=>this.bi(t)))})),this.Ei.close(),this.Li()}vi(e,t){return e.filter((e=>this.Ci(e.updateTimeMs,t)&&!this.Mi(e.clientId)))}Bi(){return this.runTransaction("getActiveClients","readonly",(e=>Do(e).U().next((e=>this.vi(e,18e5).map((e=>e.clientId))))))}get started(){return this.qr}getMutationQueue(e,t){return Li.lt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new xi(e,this.serializer.ct.databaseId)}getDocumentOverlayCache(e){return ti.lt(this.serializer,e)}getBundleCache(){return this.$r}runTransaction(e,t,n){m("IndexedDbPersistence","Starting transaction:",e);const r="readonly"===t?"readonly":"readwrite",s=function(e){return 16===e?We:15===e?je:14===e?Qe:13===e?$e:12===e?Ke:11===e?Ge:void w()}(this.ui);let i;return this.Ei.runTransaction(e,r,s,(r=>(i=new He(r,this.kr?this.kr.next():ye.oe),"readwrite-primary"===t?this.gi(i).next((e=>!!e||this.pi(i))).next((t=>{if(!t)throw g(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.oi.enqueueRetryable((()=>this.Ii(!1))),new b(_.FAILED_PRECONDITION,te);return n(i)})).next((e=>this.wi(i).next((()=>e)))):this.ki(i).next((()=>n(i)))))).then((e=>(i.raiseOnCommittedEvent(),e)))}ki(e){return Co(e).get("owner").next((e=>{if(null!==e&&this.Ci(e.leaseTimestampMs,5e3)&&!this.Mi(e.ownerId)&&!this.Si(e)&&!(this.ai||this.allowTabSynchronization&&e.allowTabSynchronization))throw new b(_.FAILED_PRECONDITION,So)}))}wi(e){const t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Co(e).put("owner",t)}static D(){return oe.D()}yi(e){const t=Co(e);return t.get("owner").next((e=>this.Si(e)?(m("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):se.resolve()))}Ci(e,t){const n=Date.now();return!(e<n-t||e>n&&(g(`Detected an update time that is in the future: ${e} > ${n}`),1))}Ri(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.li=()=>{this.oi.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.Ai())))},this.document.addEventListener("visibilitychange",this.li),this.inForeground="visible"===this.document.visibilityState)}Oi(){this.li&&(this.document.removeEventListener("visibilitychange",this.li),this.li=null)}Vi(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.ci=()=>{this.xi();const e=/(?:Version|Mobile)\/1[456]/;o.isSafari()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.oi.enterRestrictedMode(!0),this.oi.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.ci))}Ni(){this.ci&&(this.window.removeEventListener("pagehide",this.ci),this.ci=null)}Mi(e){var t;try{const n=null!==(null===(t=this.di)||void 0===t?void 0:t.getItem(this.Fi(e)));return m("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return g("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}xi(){if(this.di)try{this.di.setItem(this.Fi(this.clientId),String(Date.now()))}catch(e){g("Failed to set zombie client id.",e)}}Li(){if(this.di)try{this.di.removeItem(this.Fi(this.clientId))}catch(e){}}Fi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function Co(e){return Je(e,"owner")}function Do(e){return Je(e,"clientMetadata")}function No(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class Ao{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.qi=n,this.Qi=r}static Ki(e,t){let n=Xn(),r=Xn();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new Ao(e,t.fromCache,n,r)}}class ko{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class Mo{constructor(){this.$i=!1,this.Ui=!1,this.Wi=100,this.Gi=o.isSafari()?8:ae(o.getUA())>0?6:4}initialize(e,t){this.zi=e,this.indexManager=t,this.$i=!0}getDocumentsMatchingQuery(e,t,n,r){const s={result:null};return this.ji(e,t).next((e=>{s.result=e})).next((()=>{if(!s.result)return this.Hi(e,t,r,n).next((e=>{s.result=e}))})).next((()=>{if(s.result)return;const n=new ko;return this.Ji(e,t,n).next((r=>{if(s.result=r,this.Ui)return this.Yi(e,t,n,r.size)}))})).next((()=>s.result))}Yi(e,t,n,r){return n.documentReadCount<this.Wi?(f()<=i.LogLevel.DEBUG&&m("QueryEngine","SDK will not create cache indexes for query:",Ln(t),"since it only creates cache indexes for collection contains","more than or equal to",this.Wi,"documents"),se.resolve()):(f()<=i.LogLevel.DEBUG&&m("QueryEngine","Query:",Ln(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.Gi*r?(f()<=i.LogLevel.DEBUG&&m("QueryEngine","The SDK decides to create cache indexes for query:",Ln(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,Nn(t))):se.resolve())}ji(e,t){if(xn(t))return se.resolve(null);let n=Nn(t);return this.indexManager.getIndexType(e,n).next((r=>0===r?null:(null!==t.limit&&1===r&&(t=Fn(t,null,"F"),n=Nn(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next((r=>{const s=Xn(...r);return this.zi.getDocuments(e,s).next((r=>this.indexManager.getMinOffset(e,n).next((n=>{const i=this.Zi(t,r);return this.Xi(t,i,s,n.readTime)?this.ji(e,Fn(t,null,"F")):this.es(e,i,t,n)}))))})))))}Hi(e,t,n,r){return xn(t)||r.isEqual(O.min())?se.resolve(null):this.zi.getDocuments(e,n).next((s=>{const o=this.Zi(t,s);return this.Xi(t,o,n,r)?se.resolve(null):(f()<=i.LogLevel.DEBUG&&m("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),Ln(t)),this.es(e,o,t,Y(r,-1)).next((e=>e)))}))}Zi(e,t){let n=new st(qn(e));return t.forEach(((t,r)=>{Vn(e,r)&&(n=n.add(r))})),n}Xi(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}Ji(e,t,n){return f()<=i.LogLevel.DEBUG&&m("QueryEngine","Using full collection scan to execute query:",Ln(t)),this.zi.getDocumentsMatchingQuery(e,t,Z.min(),n)}es(e,t,n,r){return this.zi.getDocumentsMatchingQuery(e,n,r).next((e=>(t.forEach((t=>{e=e.insert(t.key,t)})),e)))}}class Fo{constructor(e,t,n,r){this.persistence=e,this.ts=t,this.serializer=r,this.ns=new tt(R),this.rs=new Bn((e=>yn(e)),wn),this.ss=new Map,this.os=e.getRemoteDocumentCache(),this.Qr=e.getTargetCache(),this.$r=e.getBundleCache(),this._s(n)}_s(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new uo(this.os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.os.setIndexManager(this.indexManager),this.ts.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.ns)))}}function Ro(e,t,n,r){return new Fo(e,t,n,r)}async function Po(e,t){const n=I(e);return await n.persistence.runTransaction("Handle user change","readonly",(e=>{let r;return n.mutationQueue.getAllMutationBatches(e).next((s=>(r=s,n._s(t),n.mutationQueue.getAllMutationBatches(e)))).next((t=>{const s=[],i=[];let o=Xn();for(const e of r){s.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}for(const e of t){i.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return n.localDocuments.getDocuments(e,o).next((e=>({us:e,removedBatchIds:s,addedBatchIds:i})))}))}))}function Lo(e){const t=I(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(e=>t.Qr.getLastRemoteSnapshotVersion(e)))}function Vo(e,t,n){let r=Xn(),s=Xn();return n.forEach((e=>r=r.add(e))),t.getEntries(e,r).next((e=>{let r=Gn();return n.forEach(((n,i)=>{const o=e.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(s=s.add(n)),i.isNoDocument()&&i.version.isEqual(O.min())?(t.removeEntry(n,i.readTime),r=r.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(t.addEntry(i),r=r.insert(n,i)):m("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)})),{cs:r,ls:s}}))}function Oo(e,t){const n=I(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t))))}function qo(e,t){const n=I(e);return n.persistence.runTransaction("Allocate target","readwrite",(e=>{let r;return n.Qr.getTargetData(e,t).next((s=>s?(r=s,se.resolve(r)):n.Qr.allocateTargetId(e).next((s=>(r=new qs(t,s,"TargetPurposeListen",e.currentSequenceNumber),n.Qr.addTargetData(e,r).next((()=>r)))))))})).then((e=>{const r=n.ns.get(e.targetId);return(null===r||e.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.ns=n.ns.insert(e.targetId,e),n.rs.set(t,e.targetId)),e}))}async function Uo(e,t,n){const r=I(e),s=r.ns.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,(e=>r.persistence.referenceDelegate.removeTarget(e,s)))}catch(e){if(!le(e))throw e;m("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.ns=r.ns.remove(t),r.rs.delete(s.target)}function Bo(e,t,n){const r=I(e);let s=O.min(),i=Xn();return r.persistence.runTransaction("Execute query","readwrite",(e=>function(e,t,n){const r=I(e),s=r.rs.get(n);return void 0!==s?se.resolve(r.ns.get(s)):r.Qr.getTargetData(t,n)}(r,e,Nn(t)).next((t=>{if(t)return s=t.lastLimboFreeSnapshotVersion,r.Qr.getMatchingKeysForTargetId(e,t.targetId).next((e=>{i=e}))})).next((()=>r.ts.getDocumentsMatchingQuery(e,t,n?s:O.min(),n?i:Xn()))).next((e=>(Ko(r,On(t),e),{documents:e,hs:i})))))}function zo(e,t){const n=I(e),r=I(n.Qr),s=n.ns.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",(e=>r.ot(e,t).next((e=>e?e.target:null))))}function Go(e,t){const n=I(e),r=n.ss.get(t)||O.min();return n.persistence.runTransaction("Get new document changes","readonly",(e=>n.os.getAllFromCollectionGroup(e,t,Y(r,-1),Number.MAX_SAFE_INTEGER))).then((e=>(Ko(n,t,e),e)))}function Ko(e,t,n){let r=e.ss.get(t)||O.min();n.forEach(((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)})),e.ss.set(t,r)}async function $o(e,t,n=Xn()){const r=await qo(e,Nn(Ws(t.bundledQuery))),s=I(e);return s.persistence.runTransaction("Save named query","readwrite",(e=>{const i=ds(t.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.$r.saveNamedQuery(e,t);const o=r.withResumeToken(ut.EMPTY_BYTE_STRING,i);return s.ns=s.ns.insert(o.targetId,o),s.Qr.updateTargetData(e,o).next((()=>s.Qr.removeMatchingKeysForTargetId(e,r.targetId))).next((()=>s.Qr.addMatchingKeys(e,n,r.targetId))).next((()=>s.$r.saveNamedQuery(e,t)))}))}function Qo(e,t){return`firestore_clients_${e}_${t}`}function jo(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function Wo(e,t){return`firestore_targets_${e}_${t}`}class Ho{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Es(e,t,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new b(r.error.code,r.error.message))),i?new Ho(e,t,r.state,s):(g("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}ds(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Jo{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Es(e,t){const n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new b(n.error.code,n.error.message))),s?new Jo(e,n.state,r):(g("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}ds(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Yo{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Es(e,t){const n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=er();for(let e=0;r&&e<n.activeTargetIds.length;++e)r=Ie(n.activeTargetIds[e]),s=s.add(n.activeTargetIds[e]);return r?new Yo(e,s):(g("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class Xo{constructor(e,t){this.clientId=e,this.onlineState=t}static Es(e){const t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new Xo(t.clientId,t.onlineState):(g("SharedClientState",`Failed to parse online state: ${e}`),null)}}class Zo{constructor(){this.activeTargetIds=er()}As(e){this.activeTargetIds=this.activeTargetIds.add(e)}Rs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}ds(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class ea{constructor(e,t,n,r,s){this.window=e,this.oi=t,this.persistenceKey=n,this.Vs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.fs=this.gs.bind(this),this.ps=new tt(R),this.started=!1,this.ys=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.ws=Qo(this.persistenceKey,this.Vs),this.Ss=function(e){return`firestore_sequence_number_${e}`}(this.persistenceKey),this.ps=this.ps.insert(this.Vs,new Zo),this.bs=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.Ds=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.Cs=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.vs=function(e){return`firestore_online_state_${e}`}(this.persistenceKey),this.Fs=function(e){return`firestore_bundle_loaded_v2_${e}`}(this.persistenceKey),this.window.addEventListener("storage",this.fs)}static D(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.Bi();for(const t of e){if(t===this.Vs)continue;const e=this.getItem(Qo(this.persistenceKey,t));if(e){const n=Yo.Es(t,e);n&&(this.ps=this.ps.insert(n.clientId,n))}}this.Ms();const t=this.storage.getItem(this.vs);if(t){const e=this.xs(t);e&&this.Os(e)}for(const e of this.ys)this.gs(e);this.ys=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(e){this.setItem(this.Ss,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Ns(this.ps)}isActiveQueryTarget(e){let t=!1;return this.ps.forEach(((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)})),t}addPendingMutation(e){this.Ls(e,"pending")}updateMutationState(e,t,n){this.Ls(e,t,n),this.Bs(e)}addLocalQueryTarget(e){let t="not-current";if(this.isActiveQueryTarget(e)){const n=this.storage.getItem(Wo(this.persistenceKey,e));if(n){const r=Jo.Es(e,n);r&&(t=r.state)}}return this.ks.As(e),this.Ms(),t}removeLocalQueryTarget(e){this.ks.Rs(e),this.Ms()}isLocalQueryTarget(e){return this.ks.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(Wo(this.persistenceKey,e))}updateQueryState(e,t,n){this.qs(e,t,n)}handleUserChange(e,t,n){t.forEach((e=>{this.Bs(e)})),this.currentUser=e,n.forEach((e=>{this.addPendingMutation(e)}))}setOnlineState(e){this.Qs(e)}notifyBundleLoaded(e){this.Ks(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.fs),this.removeItem(this.ws),this.started=!1)}getItem(e){const t=this.storage.getItem(e);return m("SharedClientState","READ",e,t),t}setItem(e,t){m("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){m("SharedClientState","REMOVE",e),this.storage.removeItem(e)}gs(e){const t=e;if(t.storageArea===this.storage){if(m("SharedClientState","EVENT",t.key,t.newValue),t.key===this.ws)return void g("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.oi.enqueueRetryable((async()=>{if(this.started){if(null!==t.key)if(this.bs.test(t.key)){if(null==t.newValue){const e=this.$s(t.key);return this.Us(e,null)}{const e=this.Ws(t.key,t.newValue);if(e)return this.Us(e.clientId,e)}}else if(this.Ds.test(t.key)){if(null!==t.newValue){const e=this.Gs(t.key,t.newValue);if(e)return this.zs(e)}}else if(this.Cs.test(t.key)){if(null!==t.newValue){const e=this.js(t.key,t.newValue);if(e)return this.Hs(e)}}else if(t.key===this.vs){if(null!==t.newValue){const e=this.xs(t.newValue);if(e)return this.Os(e)}}else if(t.key===this.Ss){const e=function(e){let t=ye.oe;if(null!=e)try{const n=JSON.parse(e);v("number"==typeof n),t=n}catch(e){g("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(t.newValue);e!==ye.oe&&this.sequenceNumberHandler(e)}else if(t.key===this.Fs){const e=this.Js(t.newValue);await Promise.all(e.map((e=>this.syncEngine.Ys(e))))}}else this.ys.push(t)}))}}get ks(){return this.ps.get(this.Vs)}Ms(){this.setItem(this.ws,this.ks.ds())}Ls(e,t,n){const r=new Ho(this.currentUser,e,t,n),s=jo(this.persistenceKey,this.currentUser,e);this.setItem(s,r.ds())}Bs(e){const t=jo(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Qs(e){const t={clientId:this.Vs,onlineState:e};this.storage.setItem(this.vs,JSON.stringify(t))}qs(e,t,n){const r=Wo(this.persistenceKey,e),s=new Jo(e,t,n);this.setItem(r,s.ds())}Ks(e){const t=JSON.stringify(Array.from(e));this.setItem(this.Fs,t)}$s(e){const t=this.bs.exec(e);return t?t[1]:null}Ws(e,t){const n=this.$s(e);return Yo.Es(n,t)}Gs(e,t){const n=this.Ds.exec(e),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return Ho.Es(new l(s),r,t)}js(e,t){const n=this.Cs.exec(e),r=Number(n[1]);return Jo.Es(r,t)}xs(e){return Xo.Es(e)}Js(e){return JSON.parse(e)}async zs(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Zs(e.batchId,e.state,e.error);m("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}Hs(e){return this.syncEngine.Xs(e.targetId,e.state,e.error)}Us(e,t){const n=t?this.ps.insert(e,t):this.ps.remove(e),r=this.Ns(this.ps),s=this.Ns(n),i=[],o=[];return s.forEach((e=>{r.has(e)||i.push(e)})),r.forEach((e=>{s.has(e)||o.push(e)})),this.syncEngine.eo(i,o).then((()=>{this.ps=n}))}Os(e){this.ps.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Ns(e){let t=er();return e.forEach(((e,n)=>{t=t.unionWith(n.activeTargetIds)})),t}}class ta{constructor(){this.no=new Zo,this.ro={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.no.As(e),this.ro[e]||"not-current"}updateQueryState(e,t,n){this.ro[e]=t}removeLocalQueryTarget(e){this.no.Rs(e)}isLocalQueryTarget(e){return this.no.activeTargetIds.has(e)}clearQueryState(e){delete this.ro[e]}getAllActiveQueryTargets(){return this.no.activeTargetIds}isActiveQueryTarget(e){return this.no.activeTargetIds.has(e)}start(){return this.no=new Zo,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class na{io(e){}shutdown(){}}class ra{constructor(){this.so=()=>this.oo(),this._o=()=>this.ao(),this.uo=[],this.co()}io(e){this.uo.push(e)}shutdown(){window.removeEventListener("online",this.so),window.removeEventListener("offline",this._o)}co(){window.addEventListener("online",this.so),window.addEventListener("offline",this._o)}oo(){m("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.uo)e(0)}ao(){m("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.uo)e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let sa=null;function ia(){return null===sa?sa=268435456+Math.round(2147483648*Math.random()):sa++,"0x"+sa.toString(16)}const oa={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class aa{constructor(e){this.lo=e.lo,this.ho=e.ho}Po(e){this.Io=e}To(e){this.Eo=e}Ao(e){this.Ro=e}onMessage(e){this.Vo=e}close(){this.ho()}send(e){this.lo(e)}mo(){this.Io()}fo(){this.Eo()}po(e){this.Ro(e)}yo(e){this.Vo(e)}}const ca="WebChannelConnection";class ua extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.wo=t+"://"+e.host,this.So=`projects/${n}/databases/${r}`,this.bo="(default)"===this.databaseId.database?`project_id=${n}`:`project_id=${n}&database_id=${r}`}get Do(){return!1}Co(e,t,n,r,s){const i=ia(),o=this.vo(e,t.toUriEncodedString());m("RestConnection",`Sending RPC '${e}' ${i}:`,o,n);const a={"google-cloud-resource-prefix":this.So,"x-goog-request-params":this.bo};return this.Fo(a,r,s),this.Mo(e,o,a,n).then((t=>(m("RestConnection",`Received RPC '${e}' ${i}: `,t),t)),(t=>{throw p("RestConnection",`RPC '${e}' ${i} failed with error: `,t,"url: ",o,"request:",n),t}))}xo(e,t,n,r,s,i){return this.Co(e,t,n,r,s)}Fo(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+h,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((t,n)=>e[n]=t)),n&&n.headers.forEach(((t,n)=>e[n]=t))}vo(e,t){const n=oa[e];return`${this.wo}/v1/${t}:${n}`}terminate(){}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Mo(e,t,n,r){const s=ia();return new Promise(((i,o)=>{const a=new c.XhrIo;a.setWithCredentials(!0),a.listenOnce(c.EventType.COMPLETE,(()=>{try{switch(a.getLastErrorCode()){case c.ErrorCode.NO_ERROR:const t=a.getResponseJson();m(ca,`XHR for RPC '${e}' ${s} received:`,JSON.stringify(t)),i(t);break;case c.ErrorCode.TIMEOUT:m(ca,`RPC '${e}' ${s} timed out`),o(new b(_.DEADLINE_EXCEEDED,"Request time out"));break;case c.ErrorCode.HTTP_ERROR:const n=a.getStatus();if(m(ca,`RPC '${e}' ${s} failed with status:`,n,"response text:",a.getResponseText()),n>0){let e=a.getResponseJson();Array.isArray(e)&&(e=e[0]);const t=null==e?void 0:e.error;if(t&&t.status&&t.message){const e=function(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(_).indexOf(t)>=0?t:_.UNKNOWN}(t.status);o(new b(e,t.message))}else o(new b(_.UNKNOWN,"Server responded with status "+a.getStatus()))}else o(new b(_.UNAVAILABLE,"Connection failed."));break;default:w()}}finally{m(ca,`RPC '${e}' ${s} completed.`)}}));const u=JSON.stringify(r);m(ca,`RPC '${e}' ${s} sending request:`,r),a.send(t,"POST",u,n,15)}))}Oo(e,t,n){const r=ia(),s=[this.wo,"/","google.firestore.v1.Firestore","/",e,"/channel"],i=c.createWebChannelTransport(),o=c.getStatEventTarget(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(a.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(a.xmlHttpFactory=new c.FetchXmlHttpFactory({})),this.Fo(a.initMessageHeaders,t,n),a.encodeInitMessageHeaders=!0;const l=s.join("");m(ca,`Creating RPC '${e}' stream ${r}: ${l}`,a);const h=i.createWebChannel(l,a);let d=!1,f=!1;const g=new aa({lo:t=>{f?m(ca,`Not sending because RPC '${e}' stream ${r} is closed:`,t):(d||(m(ca,`Opening RPC '${e}' stream ${r} transport.`),h.open(),d=!0),m(ca,`RPC '${e}' stream ${r} sending:`,t),h.send(t))},ho:()=>h.close()}),y=(e,t,n)=>{e.listen(t,(e=>{try{n(e)}catch(e){setTimeout((()=>{throw e}),0)}}))};return y(h,c.WebChannel.EventType.OPEN,(()=>{f||(m(ca,`RPC '${e}' stream ${r} transport opened.`),g.mo())})),y(h,c.WebChannel.EventType.CLOSE,(()=>{f||(f=!0,m(ca,`RPC '${e}' stream ${r} transport closed`),g.po())})),y(h,c.WebChannel.EventType.ERROR,(t=>{f||(f=!0,p(ca,`RPC '${e}' stream ${r} transport errored:`,t),g.po(new b(_.UNAVAILABLE,"The operation could not be completed")))})),y(h,c.WebChannel.EventType.MESSAGE,(t=>{var n;if(!f){const s=t.data[0];v(!!s);const i=s,o=i.error||(null===(n=i[0])||void 0===n?void 0:n.error);if(o){m(ca,`RPC '${e}' stream ${r} received error:`,o);const t=o.status;let n=function(e){const t=Or[e];if(void 0!==t)return Br(t)}(t),s=o.message;void 0===n&&(n=_.INTERNAL,s="Unknown error status: "+t+" with message "+o.message),f=!0,g.po(new b(n,s)),h.close()}else m(ca,`RPC '${e}' stream ${r} received:`,s),g.yo(s)}})),y(o,c.Event.STAT_EVENT,(t=>{t.stat===c.Stat.PROXY?m(ca,`RPC '${e}' stream ${r} detected buffering proxy`):t.stat===c.Stat.NOPROXY&&m(ca,`RPC '${e}' stream ${r} detected no buffering proxy`)})),setTimeout((()=>{g.fo()}),0),g}}function la(){return"undefined"!=typeof window?window:null}function ha(){return"undefined"!=typeof document?document:null}function da(e){return new as(e,!0)}class fa{constructor(e,t,n=1e3,r=1.5,s=6e4){this.oi=e,this.timerId=t,this.No=n,this.Lo=r,this.Bo=s,this.ko=0,this.qo=null,this.Qo=Date.now(),this.reset()}reset(){this.ko=0}Ko(){this.ko=this.Bo}$o(e){this.cancel();const t=Math.floor(this.ko+this.Uo()),n=Math.max(0,Date.now()-this.Qo),r=Math.max(0,t-n);r>0&&m("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.ko} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.qo=this.oi.enqueueAfterDelay(this.timerId,r,(()=>(this.Qo=Date.now(),e()))),this.ko*=this.Lo,this.ko<this.No&&(this.ko=this.No),this.ko>this.Bo&&(this.ko=this.Bo)}Wo(){null!==this.qo&&(this.qo.skipDelay(),this.qo=null)}cancel(){null!==this.qo&&(this.qo.cancel(),this.qo=null)}Uo(){return(Math.random()-.5)*this.ko}}class ma{constructor(e,t,n,r,s,i,o,a){this.oi=e,this.Go=n,this.zo=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.jo=0,this.Ho=null,this.Jo=null,this.stream=null,this.Yo=new fa(e,t)}Zo(){return 1===this.state||5===this.state||this.Xo()}Xo(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.e_()}async stop(){this.Zo()&&await this.close(0)}t_(){this.state=0,this.Yo.reset()}n_(){this.Xo()&&null===this.Ho&&(this.Ho=this.oi.enqueueAfterDelay(this.Go,6e4,(()=>this.r_())))}i_(e){this.s_(),this.stream.send(e)}async r_(){if(this.Xo())return this.close(0)}s_(){this.Ho&&(this.Ho.cancel(),this.Ho=null)}o_(){this.Jo&&(this.Jo.cancel(),this.Jo=null)}async close(e,t){this.s_(),this.o_(),this.Yo.cancel(),this.jo++,4!==e?this.Yo.reset():t&&t.code===_.RESOURCE_EXHAUSTED?(g(t.toString()),g("Using maximum backoff delay to prevent overloading the backend."),this.Yo.Ko()):t&&t.code===_.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.__(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Ao(t)}__(){}auth(){this.state=1;const e=this.a_(this.jo),t=this.jo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([e,n])=>{this.jo===t&&this.u_(e,n)}),(t=>{e((()=>{const e=new b(_.UNKNOWN,"Fetching auth token failed: "+t.message);return this.c_(e)}))}))}u_(e,t){const n=this.a_(this.jo);this.stream=this.l_(e,t),this.stream.Po((()=>{n((()=>this.listener.Po()))})),this.stream.To((()=>{n((()=>(this.state=2,this.Jo=this.oi.enqueueAfterDelay(this.zo,1e4,(()=>(this.Xo()&&(this.state=3),Promise.resolve()))),this.listener.To())))})),this.stream.Ao((e=>{n((()=>this.c_(e)))})),this.stream.onMessage((e=>{n((()=>this.onMessage(e)))}))}e_(){this.state=5,this.Yo.$o((async()=>{this.state=0,this.start()}))}c_(e){return m("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}a_(e){return t=>{this.oi.enqueueAndForget((()=>this.jo===e?t():(m("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class ga extends ma{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s}l_(e,t){return this.connection.Oo("Listen",e,t)}onMessage(e){this.Yo.reset();const t=function(e,t){let n;if("targetChange"in t){t.targetChange;const r=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:w()}(t.targetChange.targetChangeType||"NO_CHANGE"),s=t.targetChange.targetIds||[],i=function(e,t){return e.useProto3Json?(v(void 0===t||"string"==typeof t),ut.fromBase64String(t||"")):(v(void 0===t||t instanceof Buffer||t instanceof Uint8Array),ut.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(e){const t=void 0===e.code?_.UNKNOWN:Br(e.code);return new b(t,e.message||"")}(o);n=new Zr(r,s,i,a||null)}else if("documentChange"in t){t.documentChange;const r=t.documentChange;r.document,r.document.name,r.document.updateTime;const s=ys(e,r.document.name),i=ds(r.document.updateTime),o=r.document.createTime?ds(r.document.createTime):O.min(),a=new Bt({mapValue:{fields:r.document.fields}}),c=Gt.newFoundDocument(s,i,o,a),u=r.targetIds||[],l=r.removedTargetIds||[];n=new Yr(u,l,c.key,c)}else if("documentDelete"in t){t.documentDelete;const r=t.documentDelete;r.document;const s=ys(e,r.document),i=r.readTime?ds(r.readTime):O.min(),o=Gt.newNoDocument(s,i),a=r.removedTargetIds||[];n=new Yr([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const r=t.documentRemove;r.document;const s=ys(e,r.document),i=r.removedTargetIds||[];n=new Yr([],i,s,null)}else{if(!("filter"in t))return w();{t.filter;const e=t.filter;e.targetId;const{count:r=0,unchangedNames:s}=e,i=new Vr(r,s),o=e.targetId;n=new Xr(o,i)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return O.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?O.min():t.readTime?ds(t.readTime):O.min()}(e);return this.listener.h_(t,n)}P_(e){const t={};t.database=Is(this.serializer),t.addTarget=function(e,t){let n;const r=t.target;if(n=vn(r)?{documents:xs(e,r)}:{query:Cs(e,r)._t},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=ls(e,t.resumeToken);const r=cs(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(t.snapshotVersion.compareTo(O.min())>0){n.readTime=us(e,t.snapshotVersion.toTimestamp());const r=cs(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);const n=function(e,t){const n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return w()}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.i_(t)}I_(e){const t={};t.database=Is(this.serializer),t.removeTarget=e,this.i_(t)}}class pa extends ma{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s,this.T_=!1}get E_(){return this.T_}start(){this.T_=!1,this.lastStreamToken=void 0,super.start()}__(){this.T_&&this.d_([])}l_(e,t){return this.connection.Oo("Write",e,t)}onMessage(e){if(v(!!e.streamToken),this.lastStreamToken=e.streamToken,this.T_){this.Yo.reset();const t=function(e,t){return e&&e.length>0?(v(void 0!==t),e.map((e=>function(e,t){let n=e.updateTime?ds(e.updateTime):ds(t);return n.isEqual(O.min())&&(n=ds(t)),new yr(n,e.transformResults||[])}(e,t)))):[]}(e.writeResults,e.commitTime),n=ds(e.commitTime);return this.listener.A_(n,t)}return v(!e.writeResults||0===e.writeResults.length),this.T_=!0,this.listener.R_()}V_(){const e={};e.database=Is(this.serializer),this.i_(e)}d_(e){const t={streamToken:this.lastStreamToken,writes:e.map((e=>Es(this.serializer,e)))};this.i_(t)}}class ya extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.m_=!1}f_(){if(this.m_)throw new b(_.FAILED_PRECONDITION,"The client has already been terminated.")}Co(e,t,n,r){return this.f_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,i])=>this.connection.Co(e,ms(t,n),r,s,i))).catch((e=>{throw"FirebaseError"===e.name?(e.code===_.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new b(_.UNKNOWN,e.toString())}))}xo(e,t,n,r,s){return this.f_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([i,o])=>this.connection.xo(e,ms(t,n),r,i,o,s))).catch((e=>{throw"FirebaseError"===e.name?(e.code===_.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new b(_.UNKNOWN,e.toString())}))}terminate(){this.m_=!0,this.connection.terminate()}}class wa{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.g_=0,this.p_=null,this.y_=!0}w_(){0===this.g_&&(this.S_("Unknown"),this.p_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.p_=null,this.b_("Backend didn't respond within 10 seconds."),this.S_("Offline"),Promise.resolve()))))}D_(e){"Online"===this.state?this.S_("Unknown"):(this.g_++,this.g_>=1&&(this.C_(),this.b_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.S_("Offline")))}set(e){this.C_(),this.g_=0,"Online"===e&&(this.y_=!1),this.S_(e)}S_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}b_(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.y_?(g(t),this.y_=!1):m("OnlineStateTracker",t)}C_(){null!==this.p_&&(this.p_.cancel(),this.p_=null)}}class va{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.v_=[],this.F_=new Map,this.M_=new Set,this.x_=[],this.O_=s,this.O_.io((e=>{n.enqueueAndForget((async()=>{Da(this)&&(m("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=I(e);t.M_.add(4),await _a(t),t.N_.set("Unknown"),t.M_.delete(4),await Ia(t)}(this))}))})),this.N_=new wa(n,r)}}async function Ia(e){if(Da(e))for(const t of e.x_)await t(!0)}async function _a(e){for(const t of e.x_)await t(!1)}function ba(e,t){const n=I(e);n.F_.has(t.targetId)||(n.F_.set(t.targetId,t),Ca(n)?xa(n):ja(n).Xo()&&Ea(n,t))}function Ta(e,t){const n=I(e),r=ja(n);n.F_.delete(t),r.Xo()&&Sa(n,t),0===n.F_.size&&(r.Xo()?r.n_():Da(n)&&n.N_.set("Unknown"))}function Ea(e,t){if(e.L_.xe(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(O.min())>0){const n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}ja(e).P_(t)}function Sa(e,t){e.L_.xe(t),ja(e).I_(t)}function xa(e){e.L_=new ts({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),ot:t=>e.F_.get(t)||null,tt:()=>e.datastore.serializer.databaseId}),ja(e).start(),e.N_.w_()}function Ca(e){return Da(e)&&!ja(e).Zo()&&e.F_.size>0}function Da(e){return 0===I(e).M_.size}function Na(e){e.L_=void 0}async function Aa(e){e.N_.set("Online")}async function ka(e){e.F_.forEach(((t,n)=>{Ea(e,t)}))}async function Ma(e,t){Na(e),Ca(e)?(e.N_.D_(t),xa(e)):e.N_.set("Unknown")}async function Fa(e,t,n){if(e.N_.set("Online"),t instanceof Zr&&2===t.state&&t.cause)try{await async function(e,t){const n=t.cause;for(const r of t.targetIds)e.F_.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.F_.delete(r),e.L_.removeTarget(r))}(e,t)}catch(n){m("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await Ra(e,n)}else if(t instanceof Yr?e.L_.Ke(t):t instanceof Xr?e.L_.He(t):e.L_.We(t),!n.isEqual(O.min()))try{const t=await Lo(e.localStore);n.compareTo(t)>=0&&await function(e,t){const n=e.L_.rt(t);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=e.F_.get(r);s&&e.F_.set(r,s.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach(((t,n)=>{const r=e.F_.get(t);if(!r)return;e.F_.set(t,r.withResumeToken(ut.EMPTY_BYTE_STRING,r.snapshotVersion)),Sa(e,t);const s=new qs(r.target,t,n,r.sequenceNumber);Ea(e,s)})),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){m("RemoteStore","Failed to raise snapshot:",t),await Ra(e,t)}}async function Ra(e,t,n){if(!le(t))throw t;e.M_.add(1),await _a(e),e.N_.set("Offline"),n||(n=()=>Lo(e.localStore)),e.asyncQueue.enqueueRetryable((async()=>{m("RemoteStore","Retrying IndexedDB access"),await n(),e.M_.delete(1),await Ia(e)}))}function Pa(e,t){return t().catch((n=>Ra(e,n,t)))}async function La(e){const t=I(e),n=Wa(t);let r=t.v_.length>0?t.v_[t.v_.length-1].batchId:-1;for(;Va(t);)try{const e=await Oo(t.localStore,r);if(null===e){0===t.v_.length&&n.n_();break}r=e.batchId,Oa(t,e)}catch(e){await Ra(t,e)}qa(t)&&Ua(t)}function Va(e){return Da(e)&&e.v_.length<10}function Oa(e,t){e.v_.push(t);const n=Wa(e);n.Xo()&&n.E_&&n.d_(t.mutations)}function qa(e){return Da(e)&&!Wa(e).Zo()&&e.v_.length>0}function Ua(e){Wa(e).start()}async function Ba(e){Wa(e).V_()}async function za(e){const t=Wa(e);for(const n of e.v_)t.d_(n.mutations)}async function Ga(e,t,n){const r=e.v_.shift(),s=Rr.from(r,t,n);await Pa(e,(()=>e.remoteSyncer.applySuccessfulWrite(s))),await La(e)}async function Ka(e,t){t&&Wa(e).E_&&await async function(e,t){if(function(e){return Ur(e)&&e!==_.ABORTED}(t.code)){const n=e.v_.shift();Wa(e).t_(),await Pa(e,(()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t))),await La(e)}}(e,t),qa(e)&&Ua(e)}async function $a(e,t){const n=I(e);n.asyncQueue.verifyOperationInProgress(),m("RemoteStore","RemoteStore received new credentials");const r=Da(n);n.M_.add(3),await _a(n),r&&n.N_.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.M_.delete(3),await Ia(n)}async function Qa(e,t){const n=I(e);t?(n.M_.delete(2),await Ia(n)):t||(n.M_.add(2),await _a(n),n.N_.set("Unknown"))}function ja(e){return e.B_||(e.B_=function(e,t,n){const r=I(e);return r.f_(),new ga(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{Po:Aa.bind(null,e),To:ka.bind(null,e),Ao:Ma.bind(null,e),h_:Fa.bind(null,e)}),e.x_.push((async t=>{t?(e.B_.t_(),Ca(e)?xa(e):e.N_.set("Unknown")):(await e.B_.stop(),Na(e))}))),e.B_}function Wa(e){return e.k_||(e.k_=function(e,t,n){const r=I(e);return r.f_(),new pa(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{Po:()=>Promise.resolve(),To:Ba.bind(null,e),Ao:Ka.bind(null,e),R_:za.bind(null,e),A_:Ga.bind(null,e)}),e.x_.push((async t=>{t?(e.k_.t_(),await La(e)):(await e.k_.stop(),e.v_.length>0&&(m("RemoteStore",`Stopping write stream with ${e.v_.length} pending writes`),e.v_=[]))}))),e.k_}class Ha{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new T,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((e=>{}))}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,o=new Ha(e,t,i,r,s);return o.start(n),o}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new b(_.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Ja(e,t){if(g("AsyncQueue",`${t}: ${e}`),le(e))return new b(_.UNAVAILABLE,`${t}: ${e}`);throw e}class Ya{constructor(e){this.comparator=e?(t,n)=>e(t,n)||G.comparator(t.key,n.key):(e,t)=>G.comparator(e.key,t.key),this.keyedMap=$n(),this.sortedSet=new tt(this.comparator)}static emptySet(e){return new Ya(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,n)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof Ya))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new Ya;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class Xa{constructor(){this.q_=new tt(G.comparator)}track(e){const t=e.doc.key,n=this.q_.get(t);n?0!==e.type&&3===n.type?this.q_=this.q_.insert(t,e):3===e.type&&1!==n.type?this.q_=this.q_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.q_=this.q_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.q_=this.q_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.q_=this.q_.remove(t):1===e.type&&2===n.type?this.q_=this.q_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.q_=this.q_.insert(t,{type:2,doc:e.doc}):w():this.q_=this.q_.insert(t,e)}Q_(){const e=[];return this.q_.inorderTraversal(((t,n)=>{e.push(n)})),e}}class Za{constructor(e,t,n,r,s,i,o,a,c){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=c}static fromInitialDocuments(e,t,n,r,s){const i=[];return t.forEach((e=>{i.push({type:0,doc:e})})),new Za(e,t,Ya.emptySet(t),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Rn(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class ec{constructor(){this.K_=void 0,this.U_=[]}W_(){return this.U_.some((e=>e.G_()))}}class tc{constructor(){this.queries=new Bn((e=>Pn(e)),Rn),this.onlineState="Unknown",this.z_=new Set}}async function nc(e,t){const n=I(e);let r=3;const s=t.query;let i=n.queries.get(s);i?!i.W_()&&t.G_()&&(r=2):(i=new ec,r=t.G_()?0:1);try{switch(r){case 0:i.K_=await n.onListen(s,!0);break;case 1:i.K_=await n.onListen(s,!1);break;case 2:await n.onFirstRemoteStoreListen(s)}}catch(e){const n=Ja(e,`Initialization of query '${Ln(t.query)}' failed`);return void t.onError(n)}n.queries.set(s,i),i.U_.push(t),t.j_(n.onlineState),i.K_&&t.H_(i.K_)&&oc(n)}async function rc(e,t){const n=I(e),r=t.query;let s=3;const i=n.queries.get(r);if(i){const e=i.U_.indexOf(t);e>=0&&(i.U_.splice(e,1),0===i.U_.length?s=t.G_()?0:1:!i.W_()&&t.G_()&&(s=2))}switch(s){case 0:return n.queries.delete(r),n.onUnlisten(r,!0);case 1:return n.queries.delete(r),n.onUnlisten(r,!1);case 2:return n.onLastRemoteStoreUnlisten(r);default:return}}function sc(e,t){const n=I(e);let r=!1;for(const e of t){const t=e.query,s=n.queries.get(t);if(s){for(const t of s.U_)t.H_(e)&&(r=!0);s.K_=e}}r&&oc(n)}function ic(e,t,n){const r=I(e),s=r.queries.get(t);if(s)for(const e of s.U_)e.onError(n);r.queries.delete(t)}function oc(e){e.z_.forEach((e=>{e.next()}))}var ac,cc;(cc=ac||(ac={})).J_="default",cc.Cache="cache";class uc{constructor(e,t,n){this.query=e,this.Y_=t,this.Z_=!1,this.X_=null,this.onlineState="Unknown",this.options=n||{}}H_(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new Za(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Z_?this.ea(e)&&(this.Y_.next(e),t=!0):this.ta(e,this.onlineState)&&(this.na(e),t=!0),this.X_=e,t}onError(e){this.Y_.error(e)}j_(e){this.onlineState=e;let t=!1;return this.X_&&!this.Z_&&this.ta(this.X_,e)&&(this.na(this.X_),t=!0),t}ta(e,t){if(!e.fromCache)return!0;if(!this.G_())return!0;const n="Offline"!==t;return(!this.options.ra||!n)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}ea(e){if(e.docChanges.length>0)return!0;const t=this.X_&&this.X_.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}na(e){e=Za.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Z_=!0,this.Y_.next(e)}G_(){return this.options.source!==ac.Cache}}class lc{constructor(e,t){this.ia=e,this.byteLength=t}sa(){return"metadata"in this.ia}}class hc{constructor(e){this.serializer=e}Ps(e){return ys(this.serializer,e)}Is(e){return e.metadata.exists?Ts(this.serializer,e.document,!1):Gt.newNoDocument(this.Ps(e.metadata.name),this.Ts(e.metadata.readTime))}Ts(e){return ds(e)}}class dc{constructor(e,t,n){this.oa=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=fc(e)}_a(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.ia.namedQuery)this.queries.push(e.ia.namedQuery);else if(e.ia.documentMetadata){this.documents.push({metadata:e.ia.documentMetadata}),e.ia.documentMetadata.exists||++t;const n=U.fromString(e.ia.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.ia.document&&(this.documents[this.documents.length-1].document=e.ia.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}aa(e){const t=new Map,n=new hc(this.serializer);for(const r of e)if(r.metadata.queries){const e=n.Ps(r.metadata.name);for(const n of r.metadata.queries){const r=(t.get(n)||Xn()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=I(e);let i=Xn(),o=Gn();for(const e of n){const n=t.Ps(e.metadata.name);e.document&&(i=i.add(n));const r=t.Is(e);r.setReadTime(t.Ts(e.metadata.readTime)),o=o.insert(n,r)}const a=s.os.newChangeBuffer({trackRemovals:!0}),c=await qo(s,function(e){return Nn(Sn(U.fromString(`__bundle__/docs/${e}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",(e=>Vo(e,a,o).next((t=>(a.apply(e),t))).next((t=>s.Qr.removeMatchingKeysForTargetId(e,c.targetId).next((()=>s.Qr.addMatchingKeys(e,i,c.targetId))).next((()=>s.localDocuments.getLocalViewOfDocuments(e,t.cs,t.ls))).next((()=>t.cs))))))}(this.localStore,new hc(this.serializer),this.documents,this.oa.id),t=this.aa(this.documents);for(const e of this.queries)await $o(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,ua:this.collectionGroups,ca:e}}}function fc(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class mc{constructor(e){this.key=e}}class gc{constructor(e){this.key=e}}class pc{constructor(e,t){this.query=e,this.la=t,this.ha=null,this.hasCachedResults=!1,this.current=!1,this.Pa=Xn(),this.mutatedKeys=Xn(),this.Ia=qn(e),this.Ta=new Ya(this.Ia)}get Ea(){return this.la}da(e,t){const n=t?t.Aa:new Xa,r=t?t.Ta:this.Ta;let s=t?t.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,c="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal(((e,t)=>{const u=r.get(e),l=Vn(this.query,t)?t:null,h=!!u&&this.mutatedKeys.has(u.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;u&&l?u.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.Ra(u,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.Ia(l,a)>0||c&&this.Ia(l,c)<0)&&(o=!0)):!u&&l?(n.track({type:0,doc:l}),f=!0):u&&!l&&(n.track({type:1,doc:u}),f=!0,(a||c)&&(o=!0)),f&&(l?(i=i.add(l),s=d?s.add(e):s.delete(e)):(i=i.delete(e),s=s.delete(e)))})),null!==this.query.limit)for(;i.size>this.query.limit;){const e="F"===this.query.limitType?i.last():i.first();i=i.delete(e.key),s=s.delete(e.key),n.track({type:1,doc:e})}return{Ta:i,Aa:n,Xi:o,mutatedKeys:s}}Ra(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){const s=this.Ta;this.Ta=e.Ta,this.mutatedKeys=e.mutatedKeys;const i=e.Aa.Q_();i.sort(((e,t)=>function(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return w()}};return n(e)-n(t)}(e.type,t.type)||this.Ia(e.doc,t.doc))),this.Va(n),r=null!=r&&r;const o=t&&!r?this.ma():[],a=0===this.Pa.size&&this.current&&!r?1:0,c=a!==this.ha;return this.ha=a,0!==i.length||c?{snapshot:new Za(this.query,e.Ta,s,i,e.mutatedKeys,0===a,c,!1,!!n&&n.resumeToken.approximateByteSize()>0),fa:o}:{fa:o}}j_(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Ta:this.Ta,Aa:new Xa,mutatedKeys:this.mutatedKeys,Xi:!1},!1)):{fa:[]}}ga(e){return!this.la.has(e)&&!!this.Ta.has(e)&&!this.Ta.get(e).hasLocalMutations}Va(e){e&&(e.addedDocuments.forEach((e=>this.la=this.la.add(e))),e.modifiedDocuments.forEach((e=>{})),e.removedDocuments.forEach((e=>this.la=this.la.delete(e))),this.current=e.current)}ma(){if(!this.current)return[];const e=this.Pa;this.Pa=Xn(),this.Ta.forEach((e=>{this.ga(e.key)&&(this.Pa=this.Pa.add(e.key))}));const t=[];return e.forEach((e=>{this.Pa.has(e)||t.push(new gc(e))})),this.Pa.forEach((n=>{e.has(n)||t.push(new mc(n))})),t}pa(e){this.la=e.hs,this.Pa=Xn();const t=this.da(e.documents);return this.applyChanges(t,!0)}ya(){return Za.fromInitialDocuments(this.query,this.Ta,this.mutatedKeys,0===this.ha,this.hasCachedResults)}}class yc{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class wc{constructor(e){this.key=e,this.wa=!1}}class vc{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.Sa={},this.ba=new Bn((e=>Pn(e)),Rn),this.Da=new Map,this.Ca=new Set,this.va=new tt(G.comparator),this.Fa=new Map,this.Ma=new fo,this.xa={},this.Oa=new Map,this.Na=Bi.Ln(),this.onlineState="Unknown",this.La=void 0}get isPrimaryClient(){return!0===this.La}}async function Ic(e,t,n=!0){const r=Hc(e);let s;const i=r.ba.get(t);return i?(r.sharedClientState.addLocalQueryTarget(i.targetId),s=i.view.ya()):s=await bc(r,t,n,!0),s}async function _c(e,t){const n=Hc(e);await bc(n,t,!0,!1)}async function bc(e,t,n,r){const s=await qo(e.localStore,Nn(t)),i=s.targetId,o=n?e.sharedClientState.addLocalQueryTarget(i):"not-current";let a;return r&&(a=await Tc(e,t,i,"current"===o,s.resumeToken)),e.isPrimaryClient&&n&&ba(e.remoteStore,s),a}async function Tc(e,t,n,r,s){e.Ba=(t,n,r)=>async function(e,t,n,r){let s=t.view.da(n);s.Xi&&(s=await Bo(e.localStore,t.query,!1).then((({documents:e})=>t.view.da(e,s))));const i=r&&r.targetChanges.get(t.targetId),o=r&&null!=r.targetMismatches.get(t.targetId),a=t.view.applyChanges(s,e.isPrimaryClient,i,o);return Pc(e,t.targetId,a.fa),a.snapshot}(e,t,n,r);const i=await Bo(e.localStore,t,!0),o=new pc(t,i.hs),a=o.da(i.documents),c=Jr.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,s),u=o.applyChanges(a,e.isPrimaryClient,c);Pc(e,n,u.fa);const l=new yc(t,n,o);return e.ba.set(t,l),e.Da.has(n)?e.Da.get(n).push(t):e.Da.set(n,[t]),u.snapshot}async function Ec(e,t,n){const r=I(e),s=r.ba.get(t),i=r.Da.get(s.targetId);if(i.length>1)return r.Da.set(s.targetId,i.filter((e=>!Rn(e,t)))),void r.ba.delete(t);r.isPrimaryClient?(r.sharedClientState.removeLocalQueryTarget(s.targetId),r.sharedClientState.isActiveQueryTarget(s.targetId)||await Uo(r.localStore,s.targetId,!1).then((()=>{r.sharedClientState.clearQueryState(s.targetId),n&&Ta(r.remoteStore,s.targetId),Fc(r,s.targetId)})).catch(re)):(Fc(r,s.targetId),await Uo(r.localStore,s.targetId,!0))}async function Sc(e,t){const n=I(e),r=n.ba.get(t),s=n.Da.get(r.targetId);n.isPrimaryClient&&1===s.length&&(n.sharedClientState.removeLocalQueryTarget(r.targetId),Ta(n.remoteStore,r.targetId))}async function xc(e,t){const n=I(e);try{const e=await function(e,t){const n=I(e),r=t.snapshotVersion;let s=n.ns;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(e=>{const i=n.os.newChangeBuffer({trackRemovals:!0});s=n.ns;const o=[];t.targetChanges.forEach(((i,a)=>{const c=s.get(a);if(!c)return;o.push(n.Qr.removeMatchingKeys(e,i.removedDocuments,a).next((()=>n.Qr.addMatchingKeys(e,i.addedDocuments,a))));let u=c.withSequenceNumber(e.currentSequenceNumber);null!==t.targetMismatches.get(a)?u=u.withResumeToken(ut.EMPTY_BYTE_STRING,O.min()).withLastLimboFreeSnapshotVersion(O.min()):i.resumeToken.approximateByteSize()>0&&(u=u.withResumeToken(i.resumeToken,r)),s=s.insert(a,u),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(c,u,i)&&o.push(n.Qr.updateTargetData(e,u))}));let a=Gn(),c=Xn();if(t.documentUpdates.forEach((r=>{t.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))})),o.push(Vo(e,i,t.documentUpdates).next((e=>{a=e.cs,c=e.ls}))),!r.isEqual(O.min())){const t=n.Qr.getLastRemoteSnapshotVersion(e).next((t=>n.Qr.setTargetsMetadata(e,e.currentSequenceNumber,r)));o.push(t)}return se.waitFor(o).next((()=>i.apply(e))).next((()=>n.localDocuments.getLocalViewOfDocuments(e,a,c))).next((()=>a))})).then((e=>(n.ns=s,e)))}(n.localStore,t);t.targetChanges.forEach(((e,t)=>{const r=n.Fa.get(t);r&&(v(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?r.wa=!0:e.modifiedDocuments.size>0?v(r.wa):e.removedDocuments.size>0&&(v(r.wa),r.wa=!1))})),await Oc(n,e,t)}catch(e){await re(e)}}function Cc(e,t,n){const r=I(e);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const e=[];r.ba.forEach(((n,r)=>{const s=r.view.j_(t);s.snapshot&&e.push(s.snapshot)})),function(e,t){const n=I(e);n.onlineState=t;let r=!1;n.queries.forEach(((e,n)=>{for(const e of n.U_)e.j_(t)&&(r=!0)})),r&&oc(n)}(r.eventManager,t),e.length&&r.Sa.h_(e),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}async function Dc(e,t,n){const r=I(e);r.sharedClientState.updateQueryState(t,"rejected",n);const s=r.Fa.get(t),i=s&&s.key;if(i){let e=new tt(G.comparator);e=e.insert(i,Gt.newNoDocument(i,O.min()));const n=Xn().add(i),s=new Hr(O.min(),new Map,new tt(R),e,n);await xc(r,s),r.va=r.va.remove(i),r.Fa.delete(t),Vc(r)}else await Uo(r.localStore,t,!1).then((()=>Fc(r,t,n))).catch(re)}async function Nc(e,t){const n=I(e),r=t.batch.batchId;try{const e=await function(e,t){const n=I(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(e=>{const r=t.batch.keys(),s=n.os.newChangeBuffer({trackRemovals:!0});return function(e,t,n,r){const s=n.batch,i=s.keys();let o=se.resolve();return i.forEach((e=>{o=o.next((()=>r.getEntry(t,e))).next((t=>{const i=n.docVersions.get(e);v(null!==i),t.version.compareTo(i)<0&&(s.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))}))})),o.next((()=>e.mutationQueue.removeMutationBatch(t,s)))}(n,e,t,s).next((()=>s.apply(e))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=Xn();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t)))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(n.localStore,t);Mc(n,r,null),kc(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Oc(n,e)}catch(e){await re(e)}}async function Ac(e,t,n){const r=I(e);try{const e=await function(e,t){const n=I(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(e=>{let r;return n.mutationQueue.lookupMutationBatch(e,t).next((t=>(v(null!==t),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t)))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(r.localStore,t);Mc(r,t,n),kc(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await Oc(r,e)}catch(n){await re(n)}}function kc(e,t){(e.Oa.get(t)||[]).forEach((e=>{e.resolve()})),e.Oa.delete(t)}function Mc(e,t,n){const r=I(e);let s=r.xa[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.xa[r.currentUser.toKey()]=s}}function Fc(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e.Da.get(t))e.ba.delete(r),n&&e.Sa.ka(r,n);e.Da.delete(t),e.isPrimaryClient&&e.Ma.Vr(t).forEach((t=>{e.Ma.containsKey(t)||Rc(e,t)}))}function Rc(e,t){e.Ca.delete(t.path.canonicalString());const n=e.va.get(t);null!==n&&(Ta(e.remoteStore,n),e.va=e.va.remove(t),e.Fa.delete(n),Vc(e))}function Pc(e,t,n){for(const r of n)r instanceof mc?(e.Ma.addReference(r.key,t),Lc(e,r)):r instanceof gc?(m("SyncEngine","Document no longer in limbo: "+r.key),e.Ma.removeReference(r.key,t),e.Ma.containsKey(r.key)||Rc(e,r.key)):w()}function Lc(e,t){const n=t.key,r=n.path.canonicalString();e.va.get(n)||e.Ca.has(r)||(m("SyncEngine","New document in limbo: "+n),e.Ca.add(r),Vc(e))}function Vc(e){for(;e.Ca.size>0&&e.va.size<e.maxConcurrentLimboResolutions;){const t=e.Ca.values().next().value;e.Ca.delete(t);const n=new G(U.fromString(t)),r=e.Na.next();e.Fa.set(r,new wc(n)),e.va=e.va.insert(n,r),ba(e.remoteStore,new qs(Nn(Sn(n.path)),r,"TargetPurposeLimboResolution",ye.oe))}}async function Oc(e,t,n){const r=I(e),s=[],i=[],o=[];r.ba.isEmpty()||(r.ba.forEach(((e,a)=>{o.push(r.Ba(a,t,n).then((e=>{if((e||n)&&r.isPrimaryClient){const t=e&&!e.fromCache;r.sharedClientState.updateQueryState(a.targetId,t?"current":"not-current")}if(e){s.push(e);const t=Ao.Ki(a.targetId,e);i.push(t)}})))})),await Promise.all(o),r.Sa.h_(s),await async function(e,t){const n=I(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(e=>se.forEach(t,(t=>se.forEach(t.qi,(r=>n.persistence.referenceDelegate.addReference(e,t.targetId,r))).next((()=>se.forEach(t.Qi,(r=>n.persistence.referenceDelegate.removeReference(e,t.targetId,r)))))))))}catch(e){if(!le(e))throw e;m("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=n.ns.get(t),r=e.snapshotVersion,s=e.withLastLimboFreeSnapshotVersion(r);n.ns=n.ns.insert(t,s)}}}(r.localStore,i))}async function qc(e,t){const n=I(e);if(!n.currentUser.isEqual(t)){m("SyncEngine","User change. New user:",t.toKey());const e=await Po(n.localStore,t);n.currentUser=t,function(e,t){e.Oa.forEach((e=>{e.forEach((e=>{e.reject(new b(_.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),e.Oa.clear()}(n),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await Oc(n,e.us)}}function Uc(e,t){const n=I(e),r=n.Fa.get(t);if(r&&r.wa)return Xn().add(r.key);{let e=Xn();const r=n.Da.get(t);if(!r)return e;for(const t of r){const r=n.ba.get(t);e=e.unionWith(r.view.Ea)}return e}}async function Bc(e,t){const n=I(e),r=await Bo(n.localStore,t.query,!0),s=t.view.pa(r);return n.isPrimaryClient&&Pc(n,t.targetId,s.fa),s}async function zc(e,t){const n=I(e);return Go(n.localStore,t).then((e=>Oc(n,e)))}async function Gc(e,t,n,r){const s=I(e),i=await function(e,t){const n=I(e),r=I(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(e=>r.vn(e,t).next((t=>t?n.localDocuments.getDocuments(e,t):se.resolve(null)))))}(s.localStore,t);null!==i?("pending"===n?await La(s.remoteStore):"acknowledged"===n||"rejected"===n?(Mc(s,t,r||null),kc(s,t),function(e,t){I(I(e).mutationQueue).Mn(t)}(s.localStore,t)):w(),await Oc(s,i)):m("SyncEngine","Cannot apply mutation batch with id: "+t)}async function Kc(e,t,n){const r=I(e),s=[],i=[];for(const e of t){let t;const n=r.Da.get(e);if(n&&0!==n.length){t=await qo(r.localStore,Nn(n[0]));for(const e of n){const t=r.ba.get(e),n=await Bc(r,t);n.snapshot&&i.push(n.snapshot)}}else{const n=await zo(r.localStore,e);t=await qo(r.localStore,n),await Tc(r,$c(n),e,!1,t.resumeToken)}s.push(t)}return r.Sa.h_(i),s}function $c(e){return En(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function Qc(e){return function(e){return I(I(e).persistence).Bi()}(I(e).localStore)}async function jc(e,t,n,r){const s=I(e);if(s.La)return void m("SyncEngine","Ignoring unexpected query state notification.");const i=s.Da.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{const e=await Go(s.localStore,On(i[0])),r=Hr.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,ut.EMPTY_BYTE_STRING);await Oc(s,e,r);break}case"rejected":await Uo(s.localStore,t,!0),Fc(s,t,r);break;default:w()}}async function Wc(e,t,n){const r=Hc(e);if(r.La){for(const e of t){if(r.Da.has(e)&&r.sharedClientState.isActiveQueryTarget(e)){m("SyncEngine","Adding an already active target "+e);continue}const t=await zo(r.localStore,e),n=await qo(r.localStore,t);await Tc(r,$c(t),n.targetId,!1,n.resumeToken),ba(r.remoteStore,n)}for(const e of n)r.Da.has(e)&&await Uo(r.localStore,e,!1).then((()=>{Ta(r.remoteStore,e),Fc(r,e)})).catch(re)}}function Hc(e){const t=I(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=xc.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=Uc.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=Dc.bind(null,t),t.Sa.h_=sc.bind(null,t.eventManager),t.Sa.ka=ic.bind(null,t.eventManager),t}function Jc(e){const t=I(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=Nc.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=Ac.bind(null,t),t}class Yc{constructor(){this.synchronizeTabs=!1}async initialize(e){this.serializer=da(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),await this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return Ro(this.persistence,new Mo,e.initialUser,this.serializer)}createPersistence(e){return new vo(_o.Hr,this.serializer)}createSharedClientState(e){return new ta}async terminate(){var e,t;null===(e=this.gcScheduler)||void 0===e||e.stop(),null===(t=this.indexBackfillerScheduler)||void 0===t||t.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class Xc extends Yc{constructor(e){super(),this.cacheSizeBytes=e}createGarbageCollectionScheduler(e,t){v(this.persistence.referenceDelegate instanceof bo);const n=this.persistence.referenceDelegate.garbageCollector;return new Wi(n,e.asyncQueue,t)}createPersistence(e){const t=void 0!==this.cacheSizeBytes?Fi.withCacheSize(this.cacheSizeBytes):Fi.DEFAULT;return new vo((e=>bo.Hr(e,t)),this.serializer)}}class Zc extends Yc{constructor(e,t,n){super(),this.Qa=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Qa.initialize(this,e),await Jc(this.Qa.syncEngine),await La(this.Qa.remoteStore),await this.persistence.fi((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}createLocalStore(e){return Ro(this.persistence,new Mo,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){const n=this.persistence.referenceDelegate.garbageCollector;return new Wi(n,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){const n=new pe(t,this.persistence);return new ge(e.asyncQueue,n)}createPersistence(e){const t=No(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Fi.withCacheSize(this.cacheSizeBytes):Fi.DEFAULT;return new xo(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,la(),ha(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new ta}}class eu extends Zc{constructor(e,t){super(e,t,!1),this.Qa=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);const t=this.Qa.syncEngine;this.sharedClientState instanceof ea&&(this.sharedClientState.syncEngine={Zs:Gc.bind(null,t),Xs:jc.bind(null,t),eo:Wc.bind(null,t),Bi:Qc.bind(null,t),Ys:zc.bind(null,t)},await this.sharedClientState.start()),await this.persistence.fi((async e=>{await async function(e,t){const n=I(e);if(Hc(n),Jc(n),!0===t&&!0!==n.La){const e=n.sharedClientState.getAllActiveQueryTargets(),t=await Kc(n,e.toArray());n.La=!0,await Qa(n.remoteStore,!0);for(const e of t)ba(n.remoteStore,e)}else if(!1===t&&!1!==n.La){const e=[];let t=Promise.resolve();n.Da.forEach(((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?e.push(s):t=t.then((()=>(Fc(n,s),Uo(n.localStore,s,!0)))),Ta(n.remoteStore,s)})),await t,await Kc(n,e),function(e){const t=I(e);t.Fa.forEach(((e,n)=>{Ta(t.remoteStore,n)})),t.Ma.mr(),t.Fa=new Map,t.va=new tt(G.comparator)}(n),n.La=!1,await Qa(n.remoteStore,!1)}}(this.Qa.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())}))}createSharedClientState(e){const t=la();if(!ea.D(t))throw new b(_.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=No(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new ea(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class tu{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Cc(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=qc.bind(null,this.syncEngine),await Qa(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new tc}createDatastore(e){const t=da(e.databaseInfo.databaseId),n=function(e){return new ua(e)}(e.databaseInfo);return function(e,t,n,r){return new ya(e,t,n,r)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return function(e,t,n,r,s){return new va(e,t,n,r,s)}(this.localStore,this.datastore,e.asyncQueue,(e=>Cc(this.syncEngine,e,0)),ra.D()?new ra:new na)}createSyncEngine(e,t){return function(e,t,n,r,s,i,o){const a=new vc(e,t,n,r,s,i);return o&&(a.La=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){var e;await async function(e){const t=I(e);m("RemoteStore","RemoteStore shutting down."),t.M_.add(5),await _a(t),t.O_.shutdown(),t.N_.set("Unknown")}(this.remoteStore),null===(e=this.datastore)||void 0===e||e.terminate()}}function nu(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){const r={value:e.slice(n,n+t),done:!1};return n+=t,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class ru{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Ka(this.observer.next,e)}error(e){this.observer.error?this.Ka(this.observer.error,e):g("Uncaught Error in snapshot listener:",e.toString())}$a(){this.muted=!0}Ka(e,t){this.muted||setTimeout((()=>{this.muted||e(t)}),0)}}class su{constructor(e,t){this.Ua=e,this.serializer=t,this.metadata=new T,this.buffer=new Uint8Array,this.Wa=new TextDecoder("utf-8"),this.Ga().then((e=>{e&&e.sa()?this.metadata.resolve(e.ia.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.ia)}`))}),(e=>this.metadata.reject(e)))}close(){return this.Ua.cancel()}async getMetadata(){return this.metadata.promise}async qa(){return await this.getMetadata(),this.Ga()}async Ga(){const e=await this.za();if(null===e)return null;const t=this.Wa.decode(e),n=Number(t);isNaN(n)&&this.ja(`length string (${t}) is not valid number`);const r=await this.Ha(n);return new lc(JSON.parse(r),e.length+n)}Ja(){return this.buffer.findIndex((e=>e==="{".charCodeAt(0)))}async za(){for(;this.Ja()<0&&!await this.Ya(););if(0===this.buffer.length)return null;const e=this.Ja();e<0&&this.ja("Reached the end of bundle when a length string is expected.");const t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async Ha(e){for(;this.buffer.length<e;)await this.Ya()&&this.ja("Reached the end of bundle when more is expected.");const t=this.Wa.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}ja(e){throw this.Ua.cancel(),new Error(`Invalid bundle format: ${e}`)}async Ya(){const e=await this.Ua.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class iu{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new b(_.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;const t=await async function(e,t){const n=I(e),r={documents:t.map((e=>ps(n.serializer,e)))},s=await n.xo("BatchGetDocuments",n.serializer.databaseId,U.emptyPath(),r,t.length),i=new Map;s.forEach((e=>{const t=function(e,t){return"found"in t?function(e,t){v(!!t.found),t.found.name,t.found.updateTime;const n=ys(e,t.found.name),r=ds(t.found.updateTime),s=t.found.createTime?ds(t.found.createTime):O.min(),i=new Bt({mapValue:{fields:t.found.fields}});return Gt.newFoundDocument(n,r,s,i)}(e,t):"missing"in t?function(e,t){v(!!t.missing),v(!!t.readTime);const n=ys(e,t.missing),r=ds(t.readTime);return Gt.newNoDocument(n,r)}(e,t):w()}(n.serializer,e);i.set(t.key.toString(),t)}));const o=[];return t.forEach((e=>{const t=i.get(e.toString());v(!!t),o.push(t)})),o}(this.datastore,e);return t.forEach((e=>this.recordVersion(e))),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastTransactionError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new kr(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;const e=this.readVersions;this.mutations.forEach((t=>{e.delete(t.key.toString())})),e.forEach(((e,t)=>{const n=G.fromPath(t);this.mutations.push(new Mr(n,this.precondition(n)))})),await async function(e,t){const n=I(e),r={writes:t.map((e=>Es(n.serializer,e)))};await n.Co("Commit",n.serializer.databaseId,U.emptyPath(),r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw w();t=O.min()}const n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new b(_.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(O.min())?wr.exists(!1):wr.updateTime(t):wr.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(O.min()))throw new b(_.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return wr.updateTime(t)}return wr.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class ou{constructor(e,t,n,r,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=s,this.Za=n.maxAttempts,this.Yo=new fa(this.asyncQueue,"transaction_retry")}Xa(){this.Za-=1,this.eu()}eu(){this.Yo.$o((async()=>{const e=new iu(this.datastore),t=this.tu(e);t&&t.then((t=>{this.asyncQueue.enqueueAndForget((()=>e.commit().then((()=>{this.deferred.resolve(t)})).catch((e=>{this.nu(e)}))))})).catch((e=>{this.nu(e)}))}))}tu(e){try{const t=this.updateFunction(e);return!we(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}nu(e){this.Za>0&&this.ru(e)?(this.Za-=1,this.asyncQueue.enqueueAndForget((()=>(this.eu(),Promise.resolve())))):this.deferred.reject(e)}ru(e){if("FirebaseError"===e.name){const t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!Ur(t)}return!1}}class au{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=l.UNAUTHENTICATED,this.clientId=F.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async e=>{m("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e})),this.appCheckCredentials.start(n,(e=>(m("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user))))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new b(_.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const e=new T;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const n=Ja(t,"Failed to shutdown persistence");e.reject(n)}})),e.promise}}async function cu(e,t){e.asyncQueue.verifyOperationInProgress(),m("FirestoreClient","Initializing OfflineComponentProvider");const n=e.configuration;await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener((async e=>{r.isEqual(e)||(await Po(t.localStore,e),r=e)})),t.persistence.setDatabaseDeletedListener((()=>e.terminate())),e._offlineComponents=t}async function uu(e,t){e.asyncQueue.verifyOperationInProgress();const n=await hu(e);m("FirestoreClient","Initializing OnlineComponentProvider"),await t.initialize(n,e.configuration),e.setCredentialChangeListener((e=>$a(t.remoteStore,e))),e.setAppCheckTokenChangeListener(((e,n)=>$a(t.remoteStore,n))),e._onlineComponents=t}function lu(e){return"FirebaseError"===e.name?e.code===_.FAILED_PRECONDITION||e.code===_.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}async function hu(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){m("FirestoreClient","Using user provided OfflineComponentProvider");try{await cu(e,e._uninitializedComponentsProvider._offline)}catch(t){const n=t;if(!lu(n))throw n;p("Error using user provided cache. Falling back to memory cache: "+n),await cu(e,new Yc)}}else m("FirestoreClient","Using default OfflineComponentProvider"),await cu(e,new Yc);return e._offlineComponents}async function du(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(m("FirestoreClient","Using user provided OnlineComponentProvider"),await uu(e,e._uninitializedComponentsProvider._online)):(m("FirestoreClient","Using default OnlineComponentProvider"),await uu(e,new tu))),e._onlineComponents}function fu(e){return hu(e).then((e=>e.persistence))}function mu(e){return hu(e).then((e=>e.localStore))}function gu(e){return du(e).then((e=>e.remoteStore))}function pu(e){return du(e).then((e=>e.syncEngine))}function yu(e){return du(e).then((e=>e.datastore))}async function wu(e){const t=await du(e),n=t.eventManager;return n.onListen=Ic.bind(null,t.syncEngine),n.onUnlisten=Ec.bind(null,t.syncEngine),n.onFirstRemoteStoreListen=_c.bind(null,t.syncEngine),n.onLastRemoteStoreUnlisten=Sc.bind(null,t.syncEngine),n}function vu(e,t,n={}){const r=new T;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new ru({next:i=>{t.enqueueAndForget((()=>rc(e,o)));const a=i.docs.has(n);!a&&i.fromCache?s.reject(new b(_.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&r&&"server"===r.source?s.reject(new b(_.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(i)},error:e=>s.reject(e)}),o=new uc(Sn(n.path),i,{includeMetadataChanges:!0,ra:!0});return nc(e,o)}(await wu(e),e.asyncQueue,t,n,r))),r.promise}function Iu(e,t,n={}){const r=new T;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new ru({next:n=>{t.enqueueAndForget((()=>rc(e,o))),n.fromCache&&"server"===r.source?s.reject(new b(_.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:e=>s.reject(e)}),o=new uc(n,i,{includeMetadataChanges:!0,ra:!0});return nc(e,o)}(await wu(e),e.asyncQueue,t,n,r))),r.promise}function _u(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const bu=new Map;function Tu(e,t,n){if(!n)throw new b(_.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Eu(e,t,n,r){if(!0===t&&!0===r)throw new b(_.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function Su(e){if(!G.isDocumentKey(e))throw new b(_.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function xu(e){if(G.isDocumentKey(e))throw new b(_.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function Cu(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function(e){return e.constructor?e.constructor.name:null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":w()}function Du(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new b(_.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=Cu(e);throw new b(_.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function Nu(e,t){if(t<=0)throw new b(_.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class Au{constructor(e){var t,n;if(void 0===e.host){if(void 0!==e.ssl)throw new b(_.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new b(_.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}Eu("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=_u(null!==(n=e.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new b(_.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new b(_.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new b(_.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&function(e,t){return e.timeoutSeconds===t.timeoutSeconds}(this.experimentalLongPollingOptions,e.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class ku{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Au({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new b(_.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new b(_.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Au(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new S;switch(e.type){case"firstParty":return new N(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new b(_.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=bu.get(e);t&&(m("ComponentProvider","Removing Datastore"),bu.delete(e),t.terminate())}(this),Promise.resolve()}}function Mu(e,t,n,r={}){var s;const i=(e=Du(e,ku))._getSettings(),a=`${t}:${n}`;if("firestore.googleapis.com"!==i.host&&i.host!==a&&p("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),e._setSettings(Object.assign(Object.assign({},i),{host:a,ssl:!1})),r.mockUserToken){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=l.MOCK_USER;else{t=o.createMockUserToken(r.mockUserToken,null===(s=e._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new b(_.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new l(i)}e._authCredentials=new x(new E(t,n))}}class Fu{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new Fu(this.firestore,e,this._query)}}class Ru{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Pu(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Ru(this.firestore,e,this._key)}}class Pu extends Fu{constructor(e,t,n){super(e,t,Sn(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Ru(this.firestore,null,new G(e))}withConverter(e){return new Pu(this.firestore,e,this._path)}}function Lu(e,t,...n){if(e=o.getModularInstance(e),1===arguments.length&&(t=F.newId()),Tu("doc","path",t),e instanceof ku){const r=U.fromString(t,...n);return Su(r),new Ru(e,null,new G(r))}{if(!(e instanceof Ru||e instanceof Pu))throw new b(_.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(U.fromString(t,...n));return Su(r),new Ru(e.firestore,e instanceof Pu?e.converter:null,new G(r))}}function Vu(e,t){return e=o.getModularInstance(e),t=o.getModularInstance(t),e instanceof Fu&&t instanceof Fu&&e.firestore===t.firestore&&Rn(e._query,t._query)&&e.converter===t.converter}class Ou{constructor(){this.iu=Promise.resolve(),this.su=[],this.ou=!1,this._u=[],this.au=null,this.uu=!1,this.cu=!1,this.lu=[],this.Yo=new fa(this,"async_queue_retry"),this.hu=()=>{const e=ha();e&&m("AsyncQueue","Visibility state changed to "+e.visibilityState),this.Yo.Wo()};const e=ha();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.hu)}get isShuttingDown(){return this.ou}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Pu(),this.Iu(e)}enterRestrictedMode(e){if(!this.ou){this.ou=!0,this.cu=e||!1;const t=ha();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.hu)}}enqueue(e){if(this.Pu(),this.ou)return new Promise((()=>{}));const t=new T;return this.Iu((()=>this.ou&&this.cu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.su.push(e),this.Tu())))}async Tu(){if(0!==this.su.length){try{await this.su[0](),this.su.shift(),this.Yo.reset()}catch(e){if(!le(e))throw e;m("AsyncQueue","Operation failed with retryable error: "+e)}this.su.length>0&&this.Yo.$o((()=>this.Tu()))}}Iu(e){const t=this.iu.then((()=>(this.uu=!0,e().catch((e=>{this.au=e,this.uu=!1;const t=function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e);throw g("INTERNAL UNHANDLED ERROR: ",t),e})).then((e=>(this.uu=!1,e))))));return this.iu=t,t}enqueueAfterDelay(e,t,n){this.Pu(),this.lu.indexOf(e)>-1&&(t=0);const r=Ha.createAndSchedule(this,e,t,n,(e=>this.Eu(e)));return this._u.push(r),r}Pu(){this.au&&w()}verifyOperationInProgress(){}async du(){let e;do{e=this.iu,await e}while(e!==this.iu)}Au(e){for(const t of this._u)if(t.timerId===e)return!0;return!1}Ru(e){return this.du().then((()=>{this._u.sort(((e,t)=>e.targetTimeMs-t.targetTimeMs));for(const t of this._u)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.du()}))}Vu(e){this.lu.push(e)}Eu(e){const t=this._u.indexOf(e);this._u.splice(t,1)}}function qu(e){return function(e,t){if("object"!=typeof e||null===e)return!1;const n=e;for(const e of["next","error","complete"])if(e in n&&"function"==typeof n[e])return!0;return!1}(e)}class Uu{constructor(){this._progressObserver={},this._taskCompletionResolver=new T,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}class Bu extends ku{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new Ou,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||Gu(this),this._firestoreClient.terminate()}}function zu(e){return e._firestoreClient||Gu(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function Gu(e){var t,n,r;const s=e._freezeSettings(),i=function(e,t,n,r){return new yt(e,t,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,_u(r.experimentalLongPollingOptions),r.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,s);e._firestoreClient=new au(e._authCredentials,e._appCheckCredentials,e._queue,i),(null===(n=s.localCache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(r=s.localCache)||void 0===r?void 0:r._onlineComponentProvider)&&(e._firestoreClient._uninitializedComponentsProvider={_offlineKind:s.localCache.kind,_offline:s.localCache._offlineComponentProvider,_online:s.localCache._onlineComponentProvider})}function Ku(e,t,n){const r=new T;return e.asyncQueue.enqueue((async()=>{try{await cu(e,n),await uu(e,t),r.resolve()}catch(e){const t=e;if(!lu(t))throw t;p("Error enabling indexeddb cache. Falling back to memory cache: "+t),r.reject(t)}})).then((()=>r.promise))}function $u(e){if(e._initialized||e._terminated)throw new b(_.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class Qu{constructor(e="count",t){this._internalFieldPath=t,this.type="AggregateField",this.aggregateType=e}}class ju{constructor(e,t,n){this._userDataWriter=t,this._data=n,this.type="AggregateQuerySnapshot",this.query=e}data(){return this._userDataWriter.convertObjectMap(this._data)}}class Wu{constructor(e){this._byteString=e}static fromBase64String(e){try{return new Wu(ut.fromBase64String(e))}catch(e){throw new b(_.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new Wu(ut.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class Hu{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new b(_.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new z(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class Ju{constructor(e){this._methodName=e}}class Yu{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new b(_.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new b(_.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return R(this._lat,e._lat)||R(this._long,e._long)}}const Xu=/^__.*__$/;class Zu{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new Cr(e,this.data,this.fieldMask,t,this.fieldTransforms):new xr(e,this.data,t,this.fieldTransforms)}}class el{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new Cr(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function tl(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw w()}}class nl{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===s&&this.mu(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get fu(){return this.settings.fu}gu(e){return new nl(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}pu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.gu({path:n,yu:!1});return r.wu(e),r}Su(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.gu({path:n,yu:!1});return r.mu(),r}bu(e){return this.gu({path:void 0,yu:!0})}Du(e){return bl(e,this.settings.methodName,this.settings.Cu||!1,this.path,this.settings.vu)}contains(e){return void 0!==this.fieldMask.find((t=>e.isPrefixOf(t)))||void 0!==this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))}mu(){if(this.path)for(let e=0;e<this.path.length;e++)this.wu(this.path.get(e))}wu(e){if(0===e.length)throw this.Du("Document fields must not be empty");if(tl(this.fu)&&Xu.test(e))throw this.Du('Document fields cannot begin and end with "__"')}}class rl{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||da(e)}Fu(e,t,n,r=!1){return new nl({fu:e,methodName:t,vu:n,path:z.emptyPath(),yu:!1,Cu:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function sl(e){const t=e._freezeSettings(),n=da(e._databaseId);return new rl(e._databaseId,!!t.ignoreUndefinedProperties,n)}function il(e,t,n,r,s,i={}){const o=e.Fu(i.merge||i.mergeFields?2:0,t,n,s);wl("Data must be an object, but it was:",o,r);const a=pl(r,o);let c,u;if(i.merge)c=new at(o.fieldMask),u=o.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=vl(t,r,n);if(!o.contains(s))throw new b(_.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);Tl(e,s)||e.push(s)}c=new at(e),u=o.fieldTransforms.filter((e=>c.covers(e.field)))}else c=null,u=o.fieldTransforms;return new Zu(new Bt(a),c,u)}class ol extends Ju{_toFieldTransform(e){if(2!==e.fu)throw 1===e.fu?e.Du(`${this._methodName}() can only appear at the top level of your update data`):e.Du(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof ol}}function al(e,t,n){return new nl({fu:3,vu:t.settings.vu,methodName:e._methodName,yu:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class cl extends Ju{_toFieldTransform(e){return new pr(e.path,new cr)}isEqual(e){return e instanceof cl}}class ul extends Ju{constructor(e,t){super(e),this.Mu=t}_toFieldTransform(e){const t=al(this,e,!0),n=this.Mu.map((e=>gl(e,t))),r=new ur(n);return new pr(e.path,r)}isEqual(e){return e instanceof ul&&o.deepEqual(this.Mu,e.Mu)}}class ll extends Ju{constructor(e,t){super(e),this.Mu=t}_toFieldTransform(e){const t=al(this,e,!0),n=this.Mu.map((e=>gl(e,t))),r=new hr(n);return new pr(e.path,r)}isEqual(e){return e instanceof ll&&o.deepEqual(this.Mu,e.Mu)}}class hl extends Ju{constructor(e,t){super(e),this.xu=t}_toFieldTransform(e){const t=new fr(e.serializer,rr(e.serializer,this.xu));return new pr(e.path,t)}isEqual(e){return e instanceof hl&&this.xu===e.xu}}function dl(e,t,n,r){const s=e.Fu(1,t,n);wl("Data must be an object, but it was:",s,r);const i=[],a=Bt.empty();Xe(r,((e,r)=>{const c=_l(t,e,n);r=o.getModularInstance(r);const u=s.Su(c);if(r instanceof ol)i.push(c);else{const e=gl(r,u);null!=e&&(i.push(c),a.set(c,e))}}));const c=new at(i);return new el(a,c,s.fieldTransforms)}function fl(e,t,n,r,s,i){const a=e.Fu(1,t,n),c=[vl(t,r,n)],u=[s];if(i.length%2!=0)throw new b(_.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<i.length;e+=2)c.push(vl(t,i[e])),u.push(i[e+1]);const l=[],h=Bt.empty();for(let e=c.length-1;e>=0;--e)if(!Tl(l,c[e])){const t=c[e];let n=u[e];n=o.getModularInstance(n);const r=a.Su(t);if(n instanceof ol)l.push(t);else{const e=gl(n,r);null!=e&&(l.push(t),h.set(t,e))}}const d=new at(l);return new el(h,d,a.fieldTransforms)}function ml(e,t,n,r=!1){return gl(n,e.Fu(r?4:3,t))}function gl(e,t){if(yl(e=o.getModularInstance(e)))return wl("Unsupported field value:",t,e),pl(e,t);if(e instanceof Ju)return function(e,t){if(!tl(t.fu))throw t.Du(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Du(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.yu&&4!==t.fu)throw t.Du("Nested arrays are not supported");return function(e,t){const n=[];let r=0;for(const s of e){let e=gl(s,t.bu(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=o.getModularInstance(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return rr(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=V.fromDate(e);return{timestampValue:us(t.serializer,n)}}if(e instanceof V){const n=new V(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:us(t.serializer,n)}}if(e instanceof Yu)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof Wu)return{bytesValue:ls(t.serializer,e._byteString)};if(e instanceof Ru){const n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.Du(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:fs(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.Du(`Unsupported field value: ${Cu(e)}`)}(e,t)}function pl(e,t){const n={};return et(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):Xe(e,((e,r)=>{const s=gl(r,t.pu(e));null!=s&&(n[e]=s)})),{mapValue:{fields:n}}}function yl(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof V||e instanceof Yu||e instanceof Wu||e instanceof Ru||e instanceof Ju)}function wl(e,t,n){if(!yl(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const r=Cu(n);throw"an object"===r?t.Du(e+" a custom object"):t.Du(e+" "+r)}}function vl(e,t,n){if((t=o.getModularInstance(t))instanceof Hu)return t._internalPath;if("string"==typeof t)return _l(e,t);throw bl("Field path arguments must be of type string or ",e,!1,void 0,n)}const Il=new RegExp("[~\\*/\\[\\]]");function _l(e,t,n){if(t.search(Il)>=0)throw bl(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new Hu(...t.split("."))._internalPath}catch(r){throw bl(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function bl(e,t,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${t}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(i||o)&&(c+=" (found",i&&(c+=` in field ${r}`),o&&(c+=` in document ${s}`),c+=")"),new b(_.INVALID_ARGUMENT,a+e+c)}function Tl(e,t){return e.some((e=>e.isEqual(t)))}class El{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Ru(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new Sl(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(xl("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class Sl extends El{data(){return super.data()}}function xl(e,t){return"string"==typeof t?_l(e,t):t instanceof Hu?t._internalPath:t._delegate._internalPath}function Cl(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new b(_.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Dl{}class Nl extends Dl{}class Al extends Nl{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new Al(e,t,n)}_apply(e){const t=this._parse(e);return ql(e._query,t),new Fu(e.firestore,e.converter,Mn(e._query,t))}_parse(e){const t=sl(e.firestore),n=function(e,t,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new b(_.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){Ol(o,i);const t=[];for(const n of o)t.push(Vl(r,e,n));a={arrayValue:{values:t}}}else a=Vl(r,e,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||Ol(o,i),a=ml(n,"where",o,"in"===i||"not-in"===i);return Jt.create(s,i,a)}(e._query,0,t,e.firestore._databaseId,this._field,this._op,this._value);return n}}class kl extends Dl{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new kl(e,t)}_parse(e){const t=this._queryConstraints.map((t=>t._parse(e))).filter((e=>e.getFilters().length>0));return 1===t.length?t[0]:Yt.create(t,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;const r=t.getFlattenedFilters();for(const e of r)ql(n,e),n=Mn(n,e)}(e._query,t),new Fu(e.firestore,e.converter,Mn(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class Ml extends Nl{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new Ml(e,t)}_apply(e){const t=function(e,t,n){if(null!==e.startAt)throw new b(_.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new b(_.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new jt(t,n)}(e._query,this._field,this._direction);return new Fu(e.firestore,e.converter,function(e,t){const n=e.explicitOrderBy.concat([t]);return new Tn(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}class Fl extends Nl{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new Fl(e,t,n)}_apply(e){return new Fu(e.firestore,e.converter,Fn(e._query,this._limit,this._limitType))}}class Rl extends Nl{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Rl(e,t,n)}_apply(e){const t=Ll(e,this.type,this._docOrFields,this._inclusive);return new Fu(e.firestore,e.converter,function(e,t){return new Tn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)}(e._query,t))}}class Pl extends Nl{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Pl(e,t,n)}_apply(e){const t=Ll(e,this.type,this._docOrFields,this._inclusive);return new Fu(e.firestore,e.converter,function(e,t){return new Tn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)}(e._query,t))}}function Ll(e,t,n,r){if(n[0]=o.getModularInstance(n[0]),n[0]instanceof El)return function(e,t,n,r,s){if(!r)throw new b(_.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of Dn(e))if(n.field.isKeyField())i.push(Nt(t,r.key));else{const e=r.data.field(n.field);if(mt(e))throw new b(_.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=n.field.canonicalString();throw new b(_.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}i.push(e)}return new Kt(i,s)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{const s=sl(e.firestore);return function(e,t,n,r,s,i){const o=e.explicitOrderBy;if(s.length>o.length)throw new b(_.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let i=0;i<s.length;i++){const c=s[i];if(o[i].field.isKeyField()){if("string"!=typeof c)throw new b(_.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof c}`);if(!Cn(e)&&-1!==c.indexOf("/"))throw new b(_.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${c}' contains a slash.`);const n=e.path.child(U.fromString(c));if(!G.isDocumentKey(n))throw new b(_.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new G(n);a.push(Nt(t,s))}else{const e=ml(n,r,c);a.push(e)}}return new Kt(a,i)}(e._query,e.firestore._databaseId,s,t,n,r)}}function Vl(e,t,n){if("string"==typeof(n=o.getModularInstance(n))){if(""===n)throw new b(_.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Cn(t)&&-1!==n.indexOf("/"))throw new b(_.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=t.path.child(U.fromString(n));if(!G.isDocumentKey(r))throw new b(_.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Nt(e,new G(r))}if(n instanceof Ru)return Nt(e,n._key);throw new b(_.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Cu(n)}.`)}function Ol(e,t){if(!Array.isArray(e)||0===e.length)throw new b(_.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function ql(e,t){const n=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new b(_.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new b(_.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}function Ul(e,t){if(!(t instanceof Al||t instanceof kl))throw new b(_.INVALID_ARGUMENT,`Function ${e}() requires AppliableConstraints created with a call to 'where(...)', 'or(...)', or 'and(...)'.`)}class Bl{convertValue(e,t="none"){switch(_t(e)){case 0:return null;case 1:return e.booleanValue;case 2:return dt(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(ft(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw w()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){const n={};return Xe(e,((e,r)=>{n[e]=this.convertValue(r,t)})),n}convertGeoPoint(e){return new Yu(dt(e.latitude),dt(e.longitude))}convertArray(e,t){return(e.values||[]).map((e=>this.convertValue(e,t)))}convertServerTimestamp(e,t){switch(t){case"previous":const n=gt(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(pt(e));default:return null}}convertTimestamp(e){const t=ht(e);return new V(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=U.fromString(e);v(Os(n));const r=new wt(n.get(1),n.get(3)),s=new G(n.popFirst(5));return r.isEqual(t)||g(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function zl(e,t,n){let r;return r=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,r}class Gl extends Bl{constructor(e){super(),this.firestore=e}convertBytes(e){return new Wu(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Ru(this.firestore,null,t)}}function Kl(){return new Qu("count")}class $l{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Ql extends El{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new jl(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(xl("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class jl extends Ql{data(e={}){return super.data(e)}}class Wl{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new $l(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach((t=>e.push(t))),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach((n=>{e.call(t,new jl(this._firestore,this._userDataWriter,n.key,n,new $l(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new b(_.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map((n=>{const r=new jl(e._firestore,e._userDataWriter,n.doc.key,n.doc,new $l(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}}))}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter((e=>t||3!==e.type)).map((t=>{const r=new jl(e._firestore,e._userDataWriter,t.doc.key,t.doc,new $l(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let s=-1,i=-1;return 0!==t.type&&(s=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),i=n.indexOf(t.doc.key)),{type:Hl(t.type),doc:r,oldIndex:s,newIndex:i}}))}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function Hl(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return w()}}class Jl extends Bl{constructor(e){super(),this.firestore=e}convertBytes(e){return new Wu(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Ru(this.firestore,null,t)}}function Yl(e,t){return function(e,t){const n=new T;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){const r=Jc(e);try{const e=await function(e,t){const n=I(e),r=V.now(),s=t.reduce(((e,t)=>e.add(t.key)),Xn());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(e=>{let a=Gn(),c=Xn();return n.os.getEntries(e,s).next((e=>{a=e,a.forEach(((e,t)=>{t.isValidDocument()||(c=c.add(e))}))})).next((()=>n.localDocuments.getOverlayedDocuments(e,a))).next((s=>{i=s;const o=[];for(const e of t){const t=Er(e,i.get(e.key).overlayedDocument);null!=t&&o.push(new Cr(e.key,t,zt(t.value.mapValue),wr.exists(!0)))}return n.mutationQueue.addMutationBatch(e,r,o,t)})).next((t=>{o=t;const r=t.applyToLocalDocumentSet(i,c);return n.documentOverlayCache.saveOverlays(e,t.batchId,r)}))})).then((()=>({batchId:o.batchId,changes:Qn(i)})))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.xa[e.currentUser.toKey()];r||(r=new tt(R)),r=r.insert(t,n),e.xa[e.currentUser.toKey()]=r}(r,e.batchId,n),await Oc(r,e.changes),await La(r.remoteStore)}catch(e){const t=Ja(e,"Failed to persist write");n.reject(t)}}(await pu(e),t,n))),n.promise}(zu(e),t)}function Xl(e,t,n){const r=n.docs.get(t._key),s=new Jl(e);return new Ql(e,s,t._key,r,new $l(n.hasPendingWrites,n.fromCache),t.converter)}function Zl(e,t){const n=Du(e.firestore,Bu),r=zu(n),s=Ze(t,((e,t)=>new Lr(t,e.aggregateType,e._internalFieldPath)));return function(e,t,n){const r=new T;return e.asyncQueue.enqueueAndForget((async()=>{try{const s=await yu(e);r.resolve(async function(e,t,n){var r;const s=I(e),{request:i,ut:o,parent:a}=Ds(s.serializer,An(t),n);s.connection.Do||delete i.parent;const c=(await s.xo("RunAggregationQuery",s.serializer.databaseId,a,i,1)).filter((e=>!!e.result));v(1===c.length);const u=null===(r=c[0].result)||void 0===r?void 0:r.aggregateFields;return Object.keys(u).reduce(((e,t)=>(e[o[t]]=u[t],e)),{})}(s,t,n))}catch(e){r.reject(e)}})),r.promise}(r,e._query,s).then((t=>function(e,t,n){const r=new Jl(e);return new ju(t,r,n)}(n,e,t)))}class eh{constructor(e){this.kind="memory",this._onlineComponentProvider=new tu,(null==e?void 0:e.garbageCollector)?this._offlineComponentProvider=e.garbageCollector._offlineComponentProvider:this._offlineComponentProvider=new Yc}toJSON(){return{kind:this.kind}}}class th{constructor(e){let t;this.kind="persistent",(null==e?void 0:e.tabManager)?(e.tabManager._initialize(e),t=e.tabManager):(t=oh(void 0),t._initialize(e)),this._onlineComponentProvider=t._onlineComponentProvider,this._offlineComponentProvider=t._offlineComponentProvider}toJSON(){return{kind:this.kind}}}class nh{constructor(){this.kind="memoryEager",this._offlineComponentProvider=new Yc}toJSON(){return{kind:this.kind}}}class rh{constructor(e){this.kind="memoryLru",this._offlineComponentProvider=new Xc(e)}toJSON(){return{kind:this.kind}}}class sh{constructor(e){this.forceOwnership=e,this.kind="persistentSingleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=new tu,this._offlineComponentProvider=new Zc(this._onlineComponentProvider,null==e?void 0:e.cacheSizeBytes,this.forceOwnership)}}class ih{constructor(){this.kind="PersistentMultipleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=new tu,this._offlineComponentProvider=new eu(this._onlineComponentProvider,null==e?void 0:e.cacheSizeBytes)}}function oh(e){return new sh(null==e?void 0:e.forceOwnership)}const ah={maxAttempts:5};class ch{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=sl(e)}set(e,t,n){this._verifyNotCommitted();const r=uh(e,this._firestore),s=zl(r.converter,t,n),i=il(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,wr.none())),this}update(e,t,n,...r){this._verifyNotCommitted();const s=uh(e,this._firestore);let i;return i="string"==typeof(t=o.getModularInstance(t))||t instanceof Hu?fl(this._dataReader,"WriteBatch.update",s._key,t,n,r):dl(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,wr.exists(!0))),this}delete(e){this._verifyNotCommitted();const t=uh(e,this._firestore);return this._mutations=this._mutations.concat(new kr(t._key,wr.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new b(_.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function uh(e,t){if((e=o.getModularInstance(e)).firestore!==t)throw new b(_.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class lh extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=sl(e)}get(e){const t=uh(e,this._firestore),n=new Gl(this._firestore);return this._transaction.lookup([t._key]).then((e=>{if(!e||1!==e.length)return w();const r=e[0];if(r.isFoundDocument())return new El(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new El(this._firestore,n,t._key,null,t.converter);throw w()}))}set(e,t,n){const r=uh(e,this._firestore),s=zl(r.converter,t,n),i=il(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(e,t,n,...r){const s=uh(e,this._firestore);let i;return i="string"==typeof(t=o.getModularInstance(t))||t instanceof Hu?fl(this._dataReader,"Transaction.update",s._key,t,n,r):dl(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){const t=uh(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=uh(e,this._firestore),n=new Jl(this._firestore);return super.get(e).then((e=>new Ql(this._firestore,n,t._key,e._document,new $l(!1,!1),t.converter)))}}function hh(e,t){if("string"!=typeof e[t])throw new b(_.INVALID_ARGUMENT,"Missing string value for: "+t);return e[t]}class dh{constructor(e){this._client=e,this.type="PersistentCacheIndexManager"}}function fh(e,t){e._client.verifyNotTerminated(),function(e,t){return e.asyncQueue.enqueue((async()=>function(e,t){I(e).ts.Ui=t}(await mu(e),t)))}(e._client,t).then((e=>m(`setting persistent cache index auto creation isEnabled=${t} succeeded`))).catch((e=>p(`setting persistent cache index auto creation isEnabled=${t} failed`,e)))}const mh=new WeakMap;class gh{constructor(){this.Ou=new Map}static get instance(){return ph||(ph=new gh,function(e){if(zr)throw new Error("a TestingHooksSpi instance is already set");zr=e}(ph)),ph}et(e){this.Ou.forEach((t=>t(e)))}onExistenceFilterMismatch(e){const t=Symbol(),n=this.Ou;return n.set(t,e),()=>n.delete(t)}}let ph=null;!function(e,t=!0){!function(e){h=e}(r.SDK_VERSION),r._registerComponent(new s.Component("firestore",((e,{instanceIdentifier:n,options:r})=>{const s=e.getProvider("app").getImmediate(),i=new Bu(new C(e.getProvider("auth-internal")),new k(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new b(_.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new wt(e.options.projectId,t)}(s,n),s);return r=Object.assign({useFetchStreams:t},r),i._setSettings(r),i}),"PUBLIC").setMultipleInstances(!0)),r.registerVersion(u,"4.6.3",e),r.registerVersion(u,"4.6.3","cjs2017")}(),t.AbstractUserDataWriter=Bl,t.AggregateField=Qu,t.AggregateQuerySnapshot=ju,t.Bytes=Wu,t.CACHE_SIZE_UNLIMITED=-1,t.CollectionReference=Pu,t.DocumentReference=Ru,t.DocumentSnapshot=Ql,t.FieldPath=Hu,t.FieldValue=Ju,t.Firestore=Bu,t.FirestoreError=b,t.GeoPoint=Yu,t.LoadBundleTask=Uu,t.PersistentCacheIndexManager=dh,t.Query=Fu,t.QueryCompositeFilterConstraint=kl,t.QueryConstraint=Nl,t.QueryDocumentSnapshot=jl,t.QueryEndAtConstraint=Pl,t.QueryFieldFilterConstraint=Al,t.QueryLimitConstraint=Fl,t.QueryOrderByConstraint=Ml,t.QuerySnapshot=Wl,t.QueryStartAtConstraint=Rl,t.SnapshotMetadata=$l,t.Timestamp=V,t.Transaction=lh,t.WriteBatch=ch,t._AutoId=F,t._ByteString=ut,t._DatabaseId=wt,t._DocumentKey=G,t._EmptyAppCheckTokenProvider=class{getToken(){return Promise.resolve(new A(""))}invalidateToken(){}start(e,t){}shutdown(){}},t._EmptyAuthCredentialsProvider=S,t._FieldPath=z,t._TestingHooks=class{constructor(){throw new Error("instances of this class should not be created")}static onExistenceFilterMismatch(e){return gh.instance.onExistenceFilterMismatch(e)}},t._cast=Du,t._debugAssert=function(e,t){e||w()},t._internalAggregationQueryToProtoRunAggregationQueryRequest=function(e,t){var n;const r=Ze(t,((e,t)=>new Lr(t,e.aggregateType,e._internalFieldPath))),s=null===(n=zu(Du(e.firestore,Bu))._onlineComponents)||void 0===n?void 0:n.datastore.serializer;return void 0===s?null:Ds(s,An(e._query),r,!0).request},t._internalQueryToProtoQueryTarget=function(e){var t;const n=null===(t=zu(Du(e.firestore,Bu))._onlineComponents)||void 0===t?void 0:t.datastore.serializer;return void 0===n?null:Cs(n,Nn(e._query))._t},t._isBase64Available=function(){return"undefined"!=typeof atob},t._logWarn=p,t._validateIsNotUsedTogether=Eu,t.addDoc=function(e,t){const n=Du(e.firestore,Bu),r=Lu(e),s=zl(e.converter,t);return Yl(n,[il(sl(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,wr.exists(!1))]).then((()=>r))},t.aggregateFieldEqual=function(e,t){var n,r;return e instanceof Qu&&t instanceof Qu&&e.aggregateType===t.aggregateType&&(null===(n=e._internalFieldPath)||void 0===n?void 0:n.canonicalString())===(null===(r=t._internalFieldPath)||void 0===r?void 0:r.canonicalString())},t.aggregateQuerySnapshotEqual=function(e,t){return Vu(e.query,t.query)&&o.deepEqual(e.data(),t.data())},t.and=function(...e){return e.forEach((e=>Ul("and",e))),kl._create("and",e)},t.arrayRemove=function(...e){return new ll("arrayRemove",e)},t.arrayUnion=function(...e){return new ul("arrayUnion",e)},t.average=function(e){return new Qu("avg",vl("average",e))},t.clearIndexedDbPersistence=function(e){if(e._initialized&&!e._terminated)throw new b(_.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new T;return e._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(e){if(!oe.D())return Promise.resolve();const t=e+"main";await oe.delete(t)}(No(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}})),t.promise},t.collection=function(e,t,...n){if(e=o.getModularInstance(e),Tu("collection","path",t),e instanceof ku){const r=U.fromString(t,...n);return xu(r),new Pu(e,null,r)}{if(!(e instanceof Ru||e instanceof Pu))throw new b(_.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(U.fromString(t,...n));return xu(r),new Pu(e.firestore,null,r)}},t.collectionGroup=function(e,t){if(e=Du(e,ku),Tu("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new b(_.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Fu(e,null,function(e){return new Tn(U.emptyPath(),e)}(t))},t.connectFirestoreEmulator=Mu,t.count=Kl,t.deleteAllPersistentCacheIndexes=function(e){e._client.verifyNotTerminated(),function(e){return e.asyncQueue.enqueue((async()=>function(e){const t=I(e),n=t.indexManager;return t.persistence.runTransaction("Delete All Indexes","readwrite",(e=>n.deleteAllFieldIndexes(e)))}(await mu(e))))}(e._client).then((e=>m("deleting all persistent cache indexes succeeded"))).catch((e=>p("deleting all persistent cache indexes failed",e)))},t.deleteDoc=function(e){return Yl(Du(e.firestore,Bu),[new kr(e._key,wr.none())])},t.deleteField=function(){return new ol("deleteField")},t.disableNetwork=function(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await fu(e),n=await gu(e);return t.setNetworkEnabled(!1),async function(e){const t=I(e);t.M_.add(0),await _a(t),t.N_.set("Offline")}(n)}))}(zu(e=Du(e,Bu)))},t.disablePersistentCacheIndexAutoCreation=function(e){fh(e,!1)},t.doc=Lu,t.documentId=function(){return new Hu("__name__")},t.enableIndexedDbPersistence=function(e,t){$u(e=Du(e,Bu));const n=zu(e);if(n._uninitializedComponentsProvider)throw new b(_.FAILED_PRECONDITION,"SDK cache is already specified.");p("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const r=e._freezeSettings(),s=new tu;return Ku(n,s,new Zc(s,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))},t.enableMultiTabIndexedDbPersistence=function(e){$u(e=Du(e,Bu));const t=zu(e);if(t._uninitializedComponentsProvider)throw new b(_.FAILED_PRECONDITION,"SDK cache is already specified.");p("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const n=e._freezeSettings(),r=new tu;return Ku(t,r,new eu(r,n.cacheSizeBytes))},t.enableNetwork=function(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await fu(e),n=await gu(e);return t.setNetworkEnabled(!0),function(e){const t=I(e);return t.M_.delete(0),Ia(t)}(n)}))}(zu(e=Du(e,Bu)))},t.enablePersistentCacheIndexAutoCreation=function(e){fh(e,!0)},t.endAt=function(...e){return Pl._create("endAt",e,!0)},t.endBefore=function(...e){return Pl._create("endBefore",e,!1)},t.ensureFirestoreConfigured=zu,t.executeWrite=Yl,t.getAggregateFromServer=Zl,t.getCountFromServer=function(e){return Zl(e,{count:Kl()})},t.getDoc=function(e){e=Du(e,Ru);const t=Du(e.firestore,Bu);return vu(zu(t),e._key).then((n=>Xl(t,e,n)))},t.getDocFromCache=function(e){e=Du(e,Ru);const t=Du(e.firestore,Bu),n=zu(t),r=new Jl(t);return function(e,t){const n=new T;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await function(e,t){const n=I(e);return n.persistence.runTransaction("read document","readonly",(e=>n.localDocuments.getDocument(e,t)))}(e,t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new b(_.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){const r=Ja(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await mu(e),t,n))),n.promise}(n,e._key).then((n=>new Ql(t,r,e._key,n,new $l(null!==n&&n.hasLocalMutations,!0),e.converter)))},t.getDocFromServer=function(e){e=Du(e,Ru);const t=Du(e.firestore,Bu);return vu(zu(t),e._key,{source:"server"}).then((n=>Xl(t,e,n)))},t.getDocs=function(e){e=Du(e,Fu);const t=Du(e.firestore,Bu),n=zu(t),r=new Jl(t);return Cl(e._query),Iu(n,e._query).then((n=>new Wl(t,r,e,n)))},t.getDocsFromCache=function(e){e=Du(e,Fu);const t=Du(e.firestore,Bu),n=zu(t),r=new Jl(t);return function(e,t){const n=new T;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await Bo(e,t,!0),s=new pc(t,r.hs),i=s.da(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(e){const r=Ja(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await mu(e),t,n))),n.promise}(n,e._query).then((n=>new Wl(t,r,e,n)))},t.getDocsFromServer=function(e){e=Du(e,Fu);const t=Du(e.firestore,Bu),n=zu(t),r=new Jl(t);return Iu(n,e._query,{source:"server"}).then((n=>new Wl(t,r,e,n)))},t.getFirestore=function(e,t){const n="object"==typeof e?e:r.getApp(),s="string"==typeof e?e:t||"(default)",i=r._getProvider(n,"firestore").getImmediate({identifier:s});if(!i._initialized){const e=o.getDefaultEmulatorHostnameAndPort("firestore");e&&Mu(i,...e)}return i},t.getPersistentCacheIndexManager=function(e){var t;e=Du(e,Bu);const n=mh.get(e);if(n)return n;const r=zu(e);if("persistent"!==(null===(t=r._uninitializedComponentsProvider)||void 0===t?void 0:t._offlineKind))return null;const s=new dh(r);return mh.set(e,s),s},t.increment=function(e){return new hl("increment",e)},t.initializeFirestore=function(e,t,n){n||(n="(default)");const s=r._getProvider(e,"firestore");if(s.isInitialized(n)){const e=s.getImmediate({identifier:n}),r=s.getOptions(n);if(o.deepEqual(r,t))return e;throw new b(_.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==t.cacheSizeBytes&&void 0!==t.localCache)throw new b(_.INVALID_ARGUMENT,"cache and cacheSizeBytes cannot be specified at the same time as cacheSizeBytes willbe deprecated. Instead, specify the cache size in the cache object");if(void 0!==t.cacheSizeBytes&&-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new b(_.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return s.initialize({options:t,instanceIdentifier:n})},t.limit=function(e){return Nu("limit",e),Fl._create("limit",e,"F")},t.limitToLast=function(e){return Nu("limitToLast",e),Fl._create("limitToLast",e,"L")},t.loadBundle=function(e,t){const n=zu(e=Du(e,Bu)),r=new Uu;return function(e,t,n,r){const s=function(e,t){let n;return n="string"==typeof e?Gr().encode(e):e,function(e,t){return new su(e,t)}(function(e,t){if(e instanceof Uint8Array)return nu(e,t);if(e instanceof ArrayBuffer)return nu(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),t)}(n,da(t));e.asyncQueue.enqueueAndForget((async()=>{!function(e,t,n){const r=I(e);(async function(e,t,n){try{const r=await t.getMetadata();if(await function(e,t){const n=I(e),r=ds(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(e=>n.$r.getBundleMetadata(e,t.id))).then((e=>!!e&&e.createTime.compareTo(r)>=0))}(e.localStore,r))return await t.close(),n._completeWith(function(e){return{taskState:"Success",documentsLoaded:e.totalDocuments,bytesLoaded:e.totalBytes,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}(r)),Promise.resolve(new Set);n._updateProgress(fc(r));const s=new dc(r,e.localStore,t.serializer);let i=await t.qa();for(;i;){const e=await s._a(i);e&&n._updateProgress(e),i=await t.qa()}const o=await s.complete();return await Oc(e,o.ca,void 0),await function(e,t){const n=I(e);return n.persistence.runTransaction("Save bundle","readwrite",(e=>n.$r.saveBundleMetadata(e,t)))}(e.localStore,r),n._completeWith(o.progress),Promise.resolve(o.ua)}catch(e){return p("SyncEngine",`Loading bundle failed with ${e}`),n._failWith(e),Promise.resolve(new Set)}})(r,t,n).then((e=>{r.sharedClientState.notifyBundleLoaded(e)}))}(await pu(e),s,r)}))}(n,e._databaseId,t,r),r},t.memoryEagerGarbageCollector=function(){return new nh},t.memoryLocalCache=function(e){return new eh(e)},t.memoryLruGarbageCollector=function(e){return new rh(null==e?void 0:e.cacheSizeBytes)},t.namedQuery=function(e,t){return function(e,t){return e.asyncQueue.enqueue((async()=>function(e,t){const n=I(e);return n.persistence.runTransaction("Get named query","readonly",(e=>n.$r.getNamedQuery(e,t)))}(await mu(e),t)))}(zu(e=Du(e,Bu)),t).then((t=>t?new Fu(e,null,t.query):null))},t.onSnapshot=function(e,...t){var n,r,s;e=o.getModularInstance(e);let i={includeMetadataChanges:!1,source:"default"},a=0;"object"!=typeof t[a]||qu(t[a])||(i=t[a],a++);const c={includeMetadataChanges:i.includeMetadataChanges,source:i.source};if(qu(t[a])){const e=t[a];t[a]=null===(n=e.next)||void 0===n?void 0:n.bind(e),t[a+1]=null===(r=e.error)||void 0===r?void 0:r.bind(e),t[a+2]=null===(s=e.complete)||void 0===s?void 0:s.bind(e)}let u,l,h;if(e instanceof Ru)l=Du(e.firestore,Bu),h=Sn(e._key.path),u={next:n=>{t[a]&&t[a](Xl(l,e,n))},error:t[a+1],complete:t[a+2]};else{const n=Du(e,Fu);l=Du(n.firestore,Bu),h=n._query;const r=new Jl(l);u={next:e=>{t[a]&&t[a](new Wl(l,r,n,e))},error:t[a+1],complete:t[a+2]},Cl(e._query)}return function(e,t,n,r){const s=new ru(r),i=new uc(t,s,n);return e.asyncQueue.enqueueAndForget((async()=>nc(await wu(e),i))),()=>{s.$a(),e.asyncQueue.enqueueAndForget((async()=>rc(await wu(e),i)))}}(zu(l),h,c,u)},t.onSnapshotsInSync=function(e,t){return function(e,t){const n=new ru(t);return e.asyncQueue.enqueueAndForget((async()=>function(e,t){I(e).z_.add(t),t.next()}(await wu(e),n))),()=>{n.$a(),e.asyncQueue.enqueueAndForget((async()=>function(e,t){I(e).z_.delete(t)}(await wu(e),n)))}}(zu(e=Du(e,Bu)),qu(t)?t:{next:t})},t.or=function(...e){return e.forEach((e=>Ul("or",e))),kl._create("or",e)},t.orderBy=function(e,t="asc"){const n=t,r=xl("orderBy",e);return Ml._create(r,n)},t.persistentLocalCache=function(e){return new th(e)},t.persistentMultipleTabManager=function(){return new ih},t.persistentSingleTabManager=oh,t.query=function(e,t,...n){let r=[];t instanceof Dl&&r.push(t),r=r.concat(n),function(e){const t=e.filter((e=>e instanceof kl)).length,n=e.filter((e=>e instanceof Al)).length;if(t>1||t>0&&n>0)throw new b(_.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const t of r)e=t._apply(e);return e},t.queryEqual=Vu,t.refEqual=function(e,t){return e=o.getModularInstance(e),t=o.getModularInstance(t),(e instanceof Ru||e instanceof Pu)&&(t instanceof Ru||t instanceof Pu)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter},t.runTransaction=function(e,t,n){e=Du(e,Bu);const r=Object.assign(Object.assign({},ah),n);return function(e){if(e.maxAttempts<1)throw new b(_.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(e,t,n){const r=new T;return e.asyncQueue.enqueueAndForget((async()=>{const s=await yu(e);new ou(e.asyncQueue,s,n,t,r).Xa()})),r.promise}(zu(e),(n=>t(new lh(e,n))),r)},t.serverTimestamp=function(){return new cl("serverTimestamp")},t.setDoc=function(e,t,n){e=Du(e,Ru);const r=Du(e.firestore,Bu),s=zl(e.converter,t,n);return Yl(r,[il(sl(r),"setDoc",e._key,s,null!==e.converter,n).toMutation(e._key,wr.none())])},t.setIndexConfiguration=function(e,t){var n;const r=zu(e=Du(e,Bu));if(!r._uninitializedComponentsProvider||"memory"===(null===(n=r._uninitializedComponentsProvider)||void 0===n?void 0:n._offlineKind))return p("Cannot enable indexes when persistence is disabled"),Promise.resolve();const s=function(e){const t="string"==typeof e?function(e){try{return JSON.parse(e)}catch(e){throw new b(_.INVALID_ARGUMENT,"Failed to parse JSON: "+(null==e?void 0:e.message))}}(e):e,n=[];if(Array.isArray(t.indexes))for(const e of t.indexes){const t=hh(e,"collectionGroup"),r=[];if(Array.isArray(e.fields))for(const t of e.fields){const e=_l("setIndexConfiguration",hh(t,"fieldPath"));"CONTAINS"===t.arrayConfig?r.push(new W(e,2)):"ASCENDING"===t.order?r.push(new W(e,0)):"DESCENDING"===t.order&&r.push(new W(e,1))}n.push(new K(K.UNKNOWN_ID,t,r,J.empty()))}return n}(t);return function(e,t){return e.asyncQueue.enqueue((async()=>async function(e,t){const n=I(e),r=n.indexManager,s=[];return n.persistence.runTransaction("Configure indexes","readwrite",(e=>r.getFieldIndexes(e).next((n=>function(e,t,n,r,s){e=[...e],t=[...t],e.sort(n),t.sort(n);const i=e.length,o=t.length;let a=0,c=0;for(;a<o&&c<i;){const i=n(e[c],t[a]);i<0?s(e[c++]):i>0?r(t[a++]):(a++,c++)}for(;a<o;)r(t[a++]);for(;c<i;)s(e[c++])}(n,t,j,(t=>{s.push(r.addFieldIndex(e,t))}),(t=>{s.push(r.deleteFieldIndex(e,t))})))).next((()=>se.waitFor(s)))))}(await mu(e),t)))}(r,s)},t.setLogLevel=function(e){d.setLogLevel(e)},t.snapshotEqual=function(e,t){return e instanceof Ql&&t instanceof Ql?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof Wl&&t instanceof Wl&&e._firestore===t._firestore&&Vu(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)},t.startAfter=function(...e){return Rl._create("startAfter",e,!1)},t.startAt=function(...e){return Rl._create("startAt",e,!0)},t.sum=function(e){return new Qu("sum",vl("sum",e))},t.terminate=function(e){return r._removeServiceInstance(e.app,"firestore",e._databaseId.database),e._delete()},t.updateDoc=function(e,t,n,...r){e=Du(e,Ru);const s=Du(e.firestore,Bu),i=sl(s);let a;return a="string"==typeof(t=o.getModularInstance(t))||t instanceof Hu?fl(i,"updateDoc",e._key,t,n,r):dl(i,"updateDoc",e._key,t),Yl(s,[a.toMutation(e._key,wr.exists(!0))])},t.waitForPendingWrites=function(e){return function(e){const t=new T;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t){const n=I(e);Da(n.remoteStore)||m("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(e){const t=I(e);return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e)))}(n.localStore);if(-1===e)return void t.resolve();const r=n.Oa.get(e)||[];r.push(t),n.Oa.set(e,r)}catch(e){const n=Ja(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await pu(e),t))),t.promise}(zu(e=Du(e,Bu)))},t.where=function(e,t,n){const r=t,s=xl("where",e);return Al._create(s,r,n)},t.writeBatch=function(e){return zu(e=Du(e,Bu)),new ch(e,(t=>Yl(e,t)))}}}]);